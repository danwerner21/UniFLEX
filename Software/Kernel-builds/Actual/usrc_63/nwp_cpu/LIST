               0001  NET       set    1                               opt    exp  0000                         absSWTPc      Intelligent I/O Proce     19:34:16  Apr 22, 2024   Page    1Hardware   Definitions                                                                                                                  *       lib ../include/sysdefs.h                     *                     * Various useful constants                     *                                          * Include Debug info                                    0001  DBG_SYS   equ    %0000000000000001 Debug system (scheduler, etc)               0002  DBG_8274  equ    %0000000000000010 Debug ACIA drivers               0004  DBG_INT   equ    %0000000000000100 Debug Interrupt routine               0008  DBG_TRMI  equ    %0000000000001000 Debug terminal interrupts               0010  DBG_IO    equ    %0000000000010000 Debug I/O Main routine               0020  DBG_HAN   equ    %0000000000100000 Debug terminal handler               0040  DBG_SLP   equ    %0000000001000000 Debug Sleep/Wakeup               0080  DBG_TASK  equ    %0000000010000000 Debug tasking               0100  DBG_CMD   equ    %0000000100000000 Debug I/O tasks               0200  DBG_MSG   equ    %0000001000000000 Debug high level messages               0400  DBG_INIT  equ    %0000010000000000 Print initialization messages               0800  DBG_OPEN  equ    %0000100000000000 Debug Open actions                     *               0D04  DEBUG     equ    %0000110100000100                     *EBUG_CONTROL set     %0000111100111111               0000  DEBUG_CONTROL set %0000000000000000                                    0001  DO_HISTORY set   1         Include transaction history mechanism                                          * Process Priorities                                    0046  RUNPRI    equ    70        Must run NOW               FFD8  SIQPRI    equ    -40       Waiting for a terminal interrupt to process               FFCE  FIOPRI    equ    -50       Waiting for the FIO               FFC4  SKPRI     equ    -60       Waiting for socket interrupt               FFBA  POLPRI    equ    -70       poliing priority                                          * UniFLEX signals                                    0001  HANGS     equ    1         Device hangup               0002  INTS      equ    2         Program quit (Control-C)               0003  QUITS     equ    3         Program abort (Control-backslash)               0006  PIPES     equ    6         Broken pipe                                          * -- Configuration constants                                    0009  MAX_TI    equ    9         # Queued terminal interrupts                     *               0001  MAX_DEV   equ    1                     *                                          * constants for PROT_XLTEOLSWTPc      Intelligent I/O Proce     19:34:16  Apr 22, 2024   Page    2Hardware   Definitions                                             000A  LF        equ    $0a       line feed               000D  CR        equ    $0d       carriage return                                          * NETBLOCK constants               0004  NBRQLN    equ    4         4 bytes for request               0204  NBSIZE    equ    512+NBRQLN                     SWTPc      Intelligent I/O Proce     19:34:17  Apr 22, 2024   Page    3Macro Definitions                                                                             *                     * This file contains all the standard macro definitions                     * used in the system.                     *                                    0040  FF        equ    %01000000 FIRQ interrupt mask               0010  IF        equ    %00010000 IRQ interrupt mask                                          * register references               0000  D         equ    0               0001  X         equ    1               0002  Y         equ    2               0003  U         equ    3               0004  S         equ    4               0005  PC        equ    5               0006  W         equ    6               0007  V         equ    7               0008  A         equ    8               0009  B         equ    9               000A  CC        equ    10               000B  DP        equ    11               000E  E         equ    14               000F  F         equ    15                                          * indexed addressing in macro's               0000  IX        equ    0               0001  IY        equ    1               0002  IU        equ    2               0003  IS        equ    3                                                               *                     * Set interrupt flags (I and F)                     *                                          seti      macro                               orcc   #FF|IF                               endm                                          *                     * Clear interrupt flags (I and F)                     *                                          clri      macro                               andcc  #!(FF|IF)                               endm                     SWTPc      Intelligent I/O Proce     19:34:17  Apr 22, 2024   Page    4Macro Definitions                                                                                                  *                     * debug macro                     *                                          *dbugm macro output_character                     * lda #'&1                     * lbsr syspch                     * endm                                          *                     * HD6309 MACRO's                     *                                          ldmd      macro                               fdb    $113d                               fcb    &1                               endm                                          * load W immediate                     ldwi      macro                               fdb    $1086                               fdb    &1                               endm                                          * load W direct                     *ldwd    macro                     *        fdb     $1096                     *        fcb     &1&0xff                     *        endm                                          * load W indexed                     ldwx      macro                               fdb    $10A6                               doindx &1,&2                               endm                                          * load W extended                     *ldwe    macro                     *        fdb     $10b6                     *        fdb     &1                     *        endm                                          * load E indexed                     ldex      macro                               fdb    $11a6                               doindx &1                               endm                                          ordx      macro                               fdb    $10aaSWTPc      Intelligent I/O Proce     19:34:17  Apr 22, 2024   Page    5Macro Definitions                                                                  doindx &1,&2                               endm                                          doindx    macro                               if     (&1=0)                               fcb    $84+(&2<<5)                               else                               if     (&1<16)                               fcb    (&2<<5)+(&1&$0f)                               else                               if     (&1>-16)                               fcb    (&2<<5)+($10)+(&1&$0f)                               else                               if     (&1<128)                               fcb    $88+(&2<<5),(&1&$7f)                               endif                               endif                               endif                               endif                               endm                                          * push W on system stack                     pshsw     macro                               fdb    $1038                               endm                                          * pull W from sytemstack                     pulsw     macro                               fdb    $1039                               endm                                          * memory move ++,++                     tfm1      macro                               fdb    $1138                               fcb    &1<<4|&2                               endm                                          * move memory++ to location                     tfm3      macro                               fdb    $113a                               fcb    &1<<4|&2                               endm                                          * move location to memory++                     tfm4      macro                               fdb    $113b                               fcb    &1<<4|&2                               endm                                          * logical shift left D                     lsld      macro                               fdb    $1048SWTPc      Intelligent I/O Proce     19:34:17  Apr 22, 2024   Page    6Macro Definitions                                                                  endm                                          * logical shift right D                     lsrd      macro                               fdb    $1044                               endm                                          * arithmetic shift right D                     *asrd    macro                     *        fdb     $1047                     *        endm                                          * negate D                     negd      macro                               fdb    $1040                               endm                                          * ex-or registers                     eorr      macro                               fdb    $1036                               fcb    &1<<4|&2                               endm                                          * add with carry D immediate                     adcdi     macro                               fdb    $1089                               fdb    &1                               endm                                          * increment D                     incd      macro                               fdb    $104c                               endm                                          * decrement D                     decd      macro                               fdb    $104a                               endm                                          * clear D                     clrd      macro                               fdb    $104f                               endm                                          * complement D                     comd      macro                               fdb    $1043                               endm                                          * and D immediate                     anddi     macro                               fdb    $1084SWTPc      Intelligent I/O Proce     19:34:17  Apr 22, 2024   Page    7Macro Definitions                                                                  fdb    &1                               endm                                          * bit D immediate                     bitdi     macro                               fdb    $1085                               fdb    &1                               endm                                          *                     * trfr, transfer registers, allow ALL registers                     *                     trfr      macro                               fcb    $1f                               fcb    &1<<4|&2                               endm                                          * exchange, allow ALL registers                     excg      macro                               fcb    $1e                               fcb    &1<<4|&2                               endm                                          * add registers                     *                     * addr, add reg0 + reg1 => reg1                     *                     addr      macro                               fdb    $1030                               fcb    &1<<4|&2                               endm                                          * subtract registers                     subr      macro                               fdb    $1032                               fcb    &1<<4|&2                               endm                                          * extended addressing mode                     aime      macro                               fcb    $72                               fcb    &1                               fdb    &2                               endm                                          * extended addressing mode                     oime      macro                               fcb    $71                               fcb    &1                               fdb    &2                               endm                     SWTPc      Intelligent I/O Proce     19:34:18  Apr 22, 2024   Page    8Macro Definitions                                                        * extended addressing mode                     eime      macro                               fcb    $75                               fcb    &1                               fdb    &2                               endm                                          * test immediate memory                     *timex   macro                     *        fcb     $7b                     *        fcb     &1                     *        fdb     &2                     *        endm                                          * put a LED in LIGHTS on                     LEDON     macro                               fcb    $71                               fcb    &1                               fdb    LIGHTS                               endm                                          * put a LED in LIGHTS off                     LEDOFF    macro                               fcb    $72                               fcb    255-&1                               fdb    LIGHTS                               endmSWTPc      Intelligent I/O Proce     19:34:18  Apr 22, 2024   Page    9Device     Table Structure                                                                    *                     * Possible module types table                     *                       0000                         org    $0  0000               mod_type  rmb    2         device control table address  0002               mod_name  rmb    2         pointer to module name                     *  0004               MOD_SIZE  rmb    0                                                               *                     * Device table structure                     *                       0000                         org    0  0000               dev_addr  rmb    2         Device base address  0002               dev_type  rmb    2         Device type table  0004               dev_brbu  rmb    2         baudrate backup loc                     *  0006               DEV_SIZE  rmb    0         Size of device entry                                          *                     * Control structure for a device, indexed by fifo cmnd >>3                     * MUST match nwp_codes.h  and MAX_S_NUM !!!!                     * wzsockdev.t                     *  0000                         org    $0000  0000               D_func0   rmb    2         0  Bad Command  0002               D_func1   rmb    2         1  S_OPEN  0004               D_func2   rmb    2         2  S_CLOSE  0006               D_func3   rmb    2         3  S_RQWR  0008               D_func4   rmb    2         4  S_SEND  000A               D_func5   rmb    2         5  S_RQRD  000C               D_func6   rmb    2         6  S_RECV  000E               D_func7   rmb    2         7  S_INTRPT  0010               D_func8   rmb    2         8  S_CONNECT  0012               D_func9   rmb    2         9  S_BIND  0014               D_funcA   rmb    2         10  S_LISTEN  0016               D_funcB   rmb    2         11  S_ACCEPT  0018               D_funcC   rmb    2         12  S_DISCON  001A               D_funcD   rmb    2         13  S_SNDMAC  001C               D_funcE   rmb    2         14  S_SNDKEP  001E               D_funcF   rmb    2         15  S_SPCL                     *  0020               D_func10  rmb    2         16 S_RRDFRM  0022               D_func11  rmb    2         17 S_RREAD  0024               D_func12  rmb    2         18 S_WRQSTO  0026               D_func13  rmb    2         19 S_WSNDO  0028               D_func14  rmb    2         20 S_WSNDTM  002A               D_func15  rmb    2         21 S_RQSBLKSWTPc      Intelligent I/O Proce     19:34:18  Apr 22, 2024   Page   10Device     Table Structure                            002C               D_func16  rmb    2         22 S_SNDBLK  002E               D_func17  rmb    2         23 S_RQRBLK  0030               D_func18  rmb    2         24 S_RDRBLK                     *  0032               D_inthan  rmb    2         14 Interrupt poller/handler  0034               D_init    rmb    2         15 Device initialization  0036               D_test    rmb    2         16 Test for device present                     *  0038               D_END     rmb    0         End of common handlers                     SWTPc      Intelligent I/O Proce     19:34:18  Apr 22, 2024   Page   11History Queue Record Structure                                             0000                         org    0  0000               hst_cmd   rmb    1         Command  0001               hst_seq   rmb    1         Sequence #  0002               hst_tty   rmb    1         TTY #  0003               hst_val   rmb    1         Message dependent data                     *  0004               HRECSIZ   rmb    0                                          *                     * Number of history records supported                     *               0010  MAXHIST   equ    16                     SWTPc      Intelligent I/O Proce     19:34:18  Apr 22, 2024   Page   12IOP        Memory Layout                                                 *                     * Basic Memory Layout                     *               0400  RAMorg    equ    $0400     28K of RAM - Thru $6FFF               3EFF  RAMend    equ    $3EFF     $6FFF               7000  RAMscratch equ   $7000     4K of scratchpad RAM               7E00  RAMscrend equ    $7E00               7FE0  ROMstack  equ    $7FE0     High end of ROM Stack                     * BGDB uses 7FF0               E000  ROMLOorg  equ    $E000     8K of ROM - $E000-$FFFF               C000  DEBUGROM  equ    $C000     8K of Debug ROM $C000-$DFFF               FFF0  CPUtraps  equ    $FFF0     CPU Trap Vectors                                          *                     * layout of hardware, w5500 socket device                     *Task       Structure                 19:34:18  Apr 22, 2024   Page   13IOP        Memory Layout                                                 *                     * Task Table                     *                       0000                         org    0                                          * struct task                                    00C0  USTSIZ    equ    192       User Stack Size (big enough??)                     *  0000               tslink    rmb    2         list link of running tasks  0002               tsslnk    rmb    2         list link of sleeping tasks  0004               tsstat    rmb    1         * see below *  0005               tsprir    rmb    1         priority - negative is low  0006               tsevnt    rmb    2         event task is waiting on  0008               tssgnl    rmb    1         Signal waiting for task                     *  0009               tscmd     rmb    1         Saved mailbox command  000A               tsseq     rmb    2         Saved message sequence #  000C               tstval    rmb    1         Saved transaction value  000D               tsdev     rmb    2         Device for task is servicing  000F               tsagin    rmb    2         return pointer                     *  0011               usp       rmb    2         Saved User Stack Pointer  0013               umark0    rmb    2         Stack Frame Markers  0015               umark1    rmb    2  0017                         rmb    USTSIZ    space for per/process stack                                    00D7  TSKSIZ    equ    *         task structure size                     * stat codes                                    0001  TRUN      equ    1         running               0002  TSLEEP    equ    2         sleep with high priority               0003  TWAIT     equ    3         sleep with low priority               0004  TFREE     equ    4         task is free (uncommitted)               0005  TSYS      equ    5         system task                     *                     * definition of wz5500 variables                     *                     * [*] items are initialized by the IO CPU                     * others are zeroed out                     *                                          * [*] are setup by GPP CPU                                          *                     * wzfsta bits                     *               0001  WZSLCK    equ    %00000001 sock is locked (equal to fdn)               0002  WZSKIO    equ    %00000010 io modeTask       Structure                 19:34:19  Apr 22, 2024   Page   14IOP        Memory Layout                                           0004  WZSKIS    equ    %00000100 sock is sending               0010  WZWLCK    equ    %00010000 sock task is waiting lock (equal to fdn)               0040  WZSKIP    equ    %01000000 sock interrupt pending               0080  WZBUSY    equ    %10000000 sock is busy                                          *                     * protocol values                     *               0001  SP_ICMP   equ    1         Internet Control Message Protocol               0002  SP_GMP    equ    2         Internet Group Management Protocol               0006  SP_TCP    equ    6         Transmission Control Protocol               0008  SP_EGP    equ    8         Exterior Gateway Protocol               0011  SP_UDP    equ    17        User Datagram Protocol                                          *                     * wzcmd values (w5500), private for IOP                     *               0001  WCOPEN    equ    1         open command               0002  WCLIST    equ    2         list command               0004  WCCONN    equ    4         connect command               0008  WCDISC    equ    8         disconnect               0010  WCCLOS    equ    16        close               0020  WCSEND    equ    32        send               0021  WCSNAC    equ    33        send mac               0022  WCSKEP    equ    34        send keep               0040  WCRECV    equ    64        receive               0080  WCSPEC    equ    128       special, combined commands               0081  WCRRQD    equ    128+1     read request data               0082  WCXMDR    equ    128+2     write data in fifo                                    0085  WCBIND    equ    128+5     bind  CPU<=>GPP               0086  WCACCP    equ    128+6     accpet CPU<=>GPP                     *                     * wzstat values                     *               0000  WSCLSD    equ    $00       sock closed               0013  WSINIT    equ    $13       sock init               0014  WSLIST    equ    $14       sock listen               0017  WSESTB    equ    $17       sock established               001C  WSCLWT    equ    $1c       sock close wait               0022  WSUDP     equ    $22       sock UDP               0042  WSMRAW    equ    $42       sock mac raw               0032  WSIRAW    equ    $32       sock IP raw               0015  WSSYNS    equ    $15       sock syn sent               0016  WSSYNR    equ    $16       sock syn received               0018  WSFWAI    equ    $18       sock fin wiat               001A  WSCLSG    equ    $1a       sock closing               001B  WSTIMW    equ    $1b       sock time wait               001D  WSLACK    equ    $1d       sock last ack               001E  WSRNBL    equ    $1e       sock read non block               001F  WSWNBL    equ    $1f       sock write non block               0080  WSSPEC    equ    $80       special combined commandsTask       Structure                 19:34:19  Apr 22, 2024   Page   15IOP        Memory Layout                                           0081  WSRRQF    equ    $80+1     read request data in fifo               0082  WSXMDD    equ    $80+2     xmit data taken from fifo                                          *                     * miscellaneous                     *               0080  PACK_FIRST equ   $80       in non TCP packet start to receive               0001  PACK_REMAI equ   $01       in non TCP packet received               0000  PACK_COMPL equ   $00       in non TCP complete toe receive                                          * is SOCK_NONBLOCK               0001  WFNBLK    equ    $01       in socket() call(wztype << 8)                     * is SOCK_SIGPIPECLS               0002  WFSPOC    equ    $02       in socket() call(wztype << 8)                       0000                         org    $0                     *                     * per wzsocket process and socket data                     *  0000               wzenum    rmb    1         [*] (pre=enum)  0001               wzdctr    rmb    1         [*] (pre= $00)  delay counter  0002               wzfsta    rmb    1         (pre= $00) status bits (SAME POS!! as in fdn)  0003               wzflg     rmb    1         [*] flasgs, i.e. bind                     *  0004               wzcmnd    rmb    1         command byte copy  0005               wzstat    rmb    1         status byte copy  0006               wzupkt    rmb    1         UDP packet flag  0007               wzerr     rmb    1         error code passing                     *  0008               wzxfer    rmb    2         transfer size  000A               wzrqln    rmb    2         requested size                     *  000C               wzdma1    rmb    2         if split xfer, first part  000E               wzdma2    rmb    2         if split xfer, second part                     *                     * unix socket call info                     *  0010               wzsprt    rmb    2         source port  0012               wzdprt    rmb    2         destination port  0014               wzipad    rmb    4         dest IP address  0018               wzsflg    rmb    2         flags                     *                     * udp header info                     *  001A               wzuipa    rmb    4         ip address from UDP header  001E               wzuprt    rmb    2         port number from UDP header  0020               wzurms    rmb    2         socket remained size                     * UDP write pointer  0022               wzuwrp    rmb    2         write pointer save                     *                     * open parameters                     *Task       Structure                 19:34:19  Apr 22, 2024   Page   16IOP        Memory Layout                              0024               wzfaml    rmb    2         family            for check AF_  0026               wztype    rmb    2         type              for check SOCK_  0028               wzprot    rmb    2         protocol          for check IPPROTO_                                    002A  WZSIZE    equ    *-wzenum                       0000                         org    $0                     *                     * holds the local IP info, wzdev  net0                     * ipad, mask, gwad, macad                     *  0000               wzmyip    rmb    4         Device IP address  0004               wzsbnm    rmb    4         Subnet mask bits  0008               wzgwad    rmb    4         Gateway IP address  000C               wzhwad    rmb    6         Device Hardware address                     *  0012               wzdsta    rmb    1         up/down status  0013                         rmb    3                                    0016  WZLCSZ    equ    *-wzmyip                     *                     * this is (an attempt) to implement the Berkely                     * socket interface into the UniFLEX 6309 kernel (no 6809)                     *  0000                         org    0                                          * struct sockaddr  0000               sa_fam    rmb    2         address family  0002               sa_dat    rmb    14        protocol address               0010  SKADLN    equ    *                                          * struct sockaddr_in  0010               sin_fam   rmb    2         AF_INET  0012               sin_port  rmb    2         16 bit port  0014               sin_addr  rmb    4         32 bit netid/hostid                                          * address families               0000  AF_UNSP   equ    0         AF_UNSPEC               0001  AF_UNIX   equ    1         AF_UNIX               0002  AF_INET   equ    2         AF_INET                                          * socket types               0001  SK_STRM   equ    1         socket stream               0002  SK_DGRM   equ    2         datagram, conn less               0003  SK_MRAW   equ    3         mac raw socket               0004  SK_IRAW   equ    4         IP raw socket                     *               0100  SK_NONBLK equ    $0100                                          * protocol families               0001  PF_UNIX   equ    AF_UNIX   same as address families               0002  PF_INET   equ    AF_INETTask       Structure                 19:34:20  Apr 22, 2024   Page   17IOP        Memory Layout                                                                8000  PROT_XLTEOL equ  $8000     xlate CR<=>LF (stream only)               0001  PROT_ICMP equ    1               0002  PROT_IGMP equ    2               0008  PROT_EGP  equ    8                                          *               05C0  MAX_UDP   equ    1472      max size of UDP packet                                          FIO Simulation Structure             19:34:20  Apr 22, 2024   Page   18IOP        Memory Layout                                                                      *                     * is now performed by CY7C130 dual port RAM where (1024 * 8)                     * the RAM size is limited to the (upper) 256 bytes, which                     * contains the Interrupt handshake locations                     *                     *                       0000                         org    $0000     absolute addressed                                          ************************************************************                     * the first 32 bytes of a fifo/DPR area are the same                     * for ALL applications                     ************************************************************  0000               cpu_fio   rmb    1         Command code  0001               cpu_fio1  rmb    2         Task ID/sequence  0003               cpu_fio2  rmb    1         Message specific data  0004               cpu_fio3  rmb    2         Device designator  0006               cpu_fio4  rmb    2         UIO  0008               cpu_fio5  rmb    1         UIO                     ************************************************************  0009               fio_cpu   rmb    1         Response code  000A               fio_cpu1  rmb    2         Task ID /sequence  000C               fio_cpu2  rmb    1         Transaction specific value  000D               fio_cpu3  rmb    2         --  000F               fio_cpu4  rmb    2         UIO  0011               fio_cpu5  rmb    1         UIO                     ************************************************************                     *  0012               fifo_cnt  rmb    2         Count of data in FIFO  0014               fifo_get  rmb    2         retrieval ponter  0016               fifo_put  rmb    2         storage pointer                     *                     * these values are initialized by the IO CPU                     *  0018               fifo_us0  rmb    2         FIFO offset to application data                     *  001A               fifo_us1  rmb    2         FIFO offset to user specific area2  001C               fifo_us2  rmb    2         FIFO offset to user specific area2  001E               fifo_us3  rmb    2         FIFO offset to user specific area3                     *  0020                         rmb    32-(*-cpu_fio) ** Filler **                     * end of defined area                                          ************************************************************  0020               fifo      rmb    1                     * the size of the fifo is defined in the parameter block                     ************************************************************                                          ************************************************************                     * the top 4 locations are also fixed and shared on all applications                     ************************************************************FIO Simulation Structure             19:34:20  Apr 22, 2024   Page   19IOP        Memory Layout                              0021               DEV2CPU   rmb    1         debug data from IOP/GPP  0022               CPU2DEV   rmb    1         debug data to IOP/GPP                     * should end up at the two top locations in the DUALPORT RAM  0023               fio_cpuF  rmb    1         INT + non-zero   contains info AND set CPU IRQ when written  0024               cpu_fioF  rmb    1         INT + non-zero   contains info AND set FIO IRQ when written                     **************************************************************FIO Simulation Structure             19:34:20  Apr 22, 2024   Page   20Dual_Port RAM Structure                                                                                            *                     * this is an OVERLAY on a 1Kx8 FIFO in DPR                     *                     * the primary fifo definitions are not touched                     *                     * some locations may be re-used for this purpose                     *               0000  DPR_BASE  equ    $0000     GPP DPR at this address (GPP)  0000                         org    DPR_BASE  -- Dual port RAM address                                          *               0000  nwp_strt  equ    *         first address  of DPR RAM                     *                     ******************************************************  0000                         rmb    32        defined in fio.h                       0020                         rmb    512       fifo space                     ******************************************************               0220  WZSKOFF   equ    *                     ******************************************************  0220               wzsk8     rmb    WZSIZE    sock structure  024A               wzsk7     rmb    WZSIZE    sock  0274               wzsk6     rmb    WZSIZE    sock  029E               wzsk5     rmb    WZSIZE    sock  02C8               wzsk4     rmb    WZSIZE    sock  02F2               wzsk3     rmb    WZSIZE    sock  031C               wzsk2     rmb    WZSIZE    sock  0346               wzsk1     rmb    WZSIZE    sock                     ******************************************************               0370  WZNETOF   equ    *  0370               wlocip    rmb    WZLCSZ    network device                     ******************************************************                     *                     * fifo top                     * specified in fio.h                     *                     ******************************************************                     *                     * IOP ROM Version #                     *               0020  ROM_VERSION equ  $20       Major/Minor Version of IOP ROM                                          *                     * generic and specific transaction codes for use with fio_han                     * these are for IOP                     *                                          *                     * Error codes                     *FIO Simulation Structure             19:34:20  Apr 22, 2024   Page   21Dual_Port RAM Structure                                            0080  REJECT    equ    %10000000 Error/Reject bit in command response               0081  E_BADCMD  equ    REJECT+$01 Illegal command               0082  E_SYSBSY  equ    REJECT+$02 IOP saturated               0083  E_NTOPEN  equ    REJECT+$03 Selected device not open               0084  E_BADDEV  equ    REJECT+$04 Illegal device # (=3)               0085  E_DEVBSY  equ    REJECT+$05 Device is already open (exclusieve)               0086  E_IOERR   equ    REJECT+$06 Some sort of IO error               00BE  E_INTRPT  equ    REJECT+$3E Terminal interrupt (send by IOP to UniFLEX)               00BF  E_ABORT   set    REJECT+$3F Transaction aborted by UniFLEX (not sent by IOP)               00C0  E_SOCKET  equ    REJECT+$40 Socket error,                                          *                     * Request codes (from Main CPU) is index in DEV_XXXX table at IOP                     *               0010  O_OPEN    equ    $10       Open device               0020  O_CLOSE   equ    $20       Close device               0030  O_RQWR    equ    $30       Request write               0040  O_WRITE   equ    $40       Write data via fifo to IOP               0050  O_RQRD    equ    $50       Request read data               0060  O_READ    equ    $60       Read data for via fifo from IOP               0070  O_INTRPT  set    $70       Interrupt all tasks on a terminal               0080  O_WR1C    equ    $80       Write single character               0090  O_TTYS    equ    $90       TTY Set               00A0  O_TTYG    equ    $A0       TTY Get                                    00D0  O_PGETD   equ    $D0       Read baudrate settings               00E0  O_PSETD   equ    $E0       Write baudrate settings                                          *                     * Normal responses                     * error is with bit 7 set, A contains error code                     *               000F  R_RESET   equ    $0F       System reset & functioning               0001  R_OPEN    equ    $01       Device open successful               0002  R_CLOSE   equ    $02       Device close successful               0003  R_REQOK   equ    $03       Write request now granted               0004  R_WRITE   equ    $04       Write data complete               0005  R_RDOK    equ    $05       Read data now available               0006  R_READ    equ    $06       Read data in FIFO & no more data is available               0007  R_INTRPT  set    $07       Interrupt complete               0008  R_WR1C    equ    $08       Write single character               0009  R_RD1C    equ    $09       Single character available               000B  R_PDATA   equ    $0B       port data transaction succes               000C  R_READM   equ    $0C       Read data in fifo, more data waiting               000D  R_TTY     equ    $0D       TTYSET/GET complete               000E  R_CLOCK   equ    $0E       Interval Timer Tick                     *                     *                     * fio_codes.h is the leading file, here are                     * ammendments                     *                     *FIO Simulation Structure             19:34:21  Apr 22, 2024   Page   22Dual_Port RAM Structure                                            0003  R_RQWR    set    $03       [S]  Request for write               0005  R_RQRD    set    $05       [S]  Request for read               0007  R_INTRPT  set    $07       [S]  Interrupt complete               0008  R_CONNECT equ    $08       [S]  connect ok               0009  R_BIND    equ    $09       [S]  bind call ok               000A  R_LISTEN  equ    $0A       [S]  listen call ok               000B  R_ACCEPT  equ    $0B       [S]  accept call ok               000C  R_DISCON  equ    $0C       [S]  disconnect happened               000D  R_SNDMAC  equ    $0D       [S]  send mac done               000E  R_SNDKEP  equ    $0E       [S]  send keep alive done               000F  R_SPCL    equ    $0F       [S]  special call ok               0015  R_RQRDNB  equ    $15       [S]  non block return read               0013  R_RQWRNB  equ    $13       [S]  non block return write                     *               0021  R_RDFRM   equ    $21       [S]  request for data readfrom               0022  R_RRDFD   equ    $22       [S]  read data readfrom next packet               0023  R_RSNDTO  equ    $23       [S]  request write sendto               0024  R_WSNDTO  equ    $24       [S]  write data sendto               0025  R_SNDTOM  equ    $25       [S]  write data, request more                     *               0030  R_RQSBLK  equ    $30               0031  R_SNDBLK  equ    $31               0032  R_RQRBLK  equ    $32               0033  R_RDRBLK  equ    $33                                          *                     * Request codes (from Main CPU) is index in DEV_XXXX table at IOP                     * Socket functions                     *               0008  S_OPEN    equ    $08       Open socket               0010  S_CLOSE   equ    $10       Close socket               0018  S_RQWR    equ    $18       request write to socket               0020  S_WRITE   equ    $20       Write data to socket               0028  S_RQRD    equ    $28       Request read data from socket               0030  S_READ    equ    $30       Read data from socket               0038  S_INTRPT  equ    $38       Interrupt socket               0038  O_INTRPT  set    S_INTRPT               0040  S_CONNECT equ    $40       Connect socket               0048  S_BIND    equ    $48       Bind socket               0050  S_LISTEN  equ    $50       Listen on socket               0058  S_ACCEPT  equ    $58       Accept connection on socket               0060  S_DISCON  equ    $60       Disconnect socket               0068  S_SNDMAC  equ    $68       Send to mac               0070  S_SNDKEP  equ    $70       Send keep alive               0078  S_SPCL    equ    $78       Special. i.e set network device                     *               0080  S_RRDFRM  equ    $80       request read readfrom               0088  S_RREAD   equ    $88       read data readfrom               0090  S_WRQSTO  equ    $90       request send ssendto               0098  S_WSNDTO  equ    $98       send data sendto               00A0  S_WSNDTM  equ    $a0       send to more data                     *FIO Simulation Structure             19:34:21  Apr 22, 2024   Page   23Dual_Port RAM Structure                                            00C0  S_RQSBLK  equ    $c0       request send extended block               00C8  S_SNDBLK  equ    $c8       send extended block               00D0  S_RQRBLK  equ    $d0       request read extended block               00D8  S_RDRBLK  equ    $d8       read extended block                     *                                    0019  MAX_S_NUM equ    25        # of supported functions (incl 0)                     *                     * definition of all interrupts in the W5500                     *                                          *                     * interrupts per socket (Socket registers)                     *               0001  SI_CON    equ    %00000001 Sn_IR(CON)               0002  SI_DIS    equ    %00000010 Sn_IR(DISCON)               0004  SI_RCV    equ    %00000100 Sn_IR(RECV)               0008  SI_TIM    equ    %00001000 Sn_IR(TIMEOUT)               0010  SI_SOK    equ    %00010000 Sn_IR(SEND_OK)                                          *                     * common interrupts  (Common registers)                     *               0010  CI_MP     equ    %00010000 Magic Packet               0020  CI_POC    equ    %00100000 PPoE Close               0040  CI_UNR    equ    %01000000 UNREACH               0080  CI_CFL    equ    %10000000 IP ConflictFIO Simulation Structure             19:34:21  Apr 22, 2024   Page   24Variable   Space                                                           0400                         org    RAMorg                       0400               sys_vars  rmb    0         -- start of system variables                                          * Configuration "constants"                       0400               DB_iflg   rmb    1         Debug terminal initialized  0401               DB_cntrl  rmb    2         Debug control flags                     *  0403               runlst    rmb    2         Pointer to active tasks  0405               slplst    rmb    4         Pointer to waiting tasks  0409               utask     rmb    2         Currently executing task  040B               jobpri    rmb    1         Current job priority (for scheduling)  040C               chproc    rmb    1         Set if must switch users of CPU (reschedule)                     *  040D               idle      rmb    1         idle loop flag for scheduler  040E               SI_Q      rmb    6*MAX_TI  Max Terminal Interrupts  0444               SI_Q_ptr  rmb    2         current Q pointer  0446               FIO_lock  rmb    1         FIO in use lock  0447               int_buf   rmb    12        Current Message in  0453               int_ptr   rmb    2         Message in pointer  0455               clock_tick rmb   1         Clock tick counter  0456               spiint    rmb    1         Interrupt flag from w5500  0457               wzanyp    rmb    2         Source Port  0459               NUM_TSK   rmb    1         max tasks                       045A               hstbuf    rmb    HRECSIZ*MAXHIST  049A               hstptr    rmb    2         next "put" pointer in history queue                                          * Pointers to system tables - configuration dependent  049C               tsktab    rmb    2         Task Control Tables  049E               tskend    rmb    2         End of task table  04A0               dev_tab   rmb    DEV_SIZE*MAX_DEV system configuration table                     *  04A6                         rmb    32                       04C6               SYS_TABS  rmb    0         Start of dynamic system tables                                    04C6  lstram    equ    *               3EFF  end_vars  equ    RAMend    End of System Variables                                          FIO Simulation Structure             19:34:21  Apr 22, 2024   Page   25CPU        Vectors                                                         FFF0                         org    CPUtraps                       FFF0 E0BF                    fdb    rom_trap  Unused  FFF2 E0B8                    fdb    rom_swi3  SWI3  FFF4 E0B1                    fdb    rom_swi2  SWI2  FFF6 E0A4                    fdb    rom_firq  FIRQ  FFF8 E3B3                    fdb    IRQ_han   IRQ  FFFA E0AB                    fdb    rom_swi   SWI  FFFC E09E                    fdb    rom_nmi   Background debug  FFFE E080                    fdb    rom_init  Reset                     *                               info   UniFLEX Networking ROM                               info   for CPU09GPP+09NET                               info   At the start of ROM the locations for preset                               info   the network setting are reserved                               info   0000...0005  MAC ADDRESS                               info   0006...0009  IP address                               info   000A...000D  NETMASK                               info   000E...0011  GATEWAY IP address                               info   avoid any duplicate settings!                                          FIO Simulation Structure             19:34:22  Apr 22, 2024   Page   26System     RESET Code                                                      E000                         org    ROMLOorg                                          * start of ROM                     ***************************************************************                     *                     * contains the MAC ADDRESS to be used, make sure that is unique                     *                     * contains the IP address for the interface                     *                     * contains the NETMASK for the interface                     *                     * contains the IP address of the GATEWAY                     *                     **************************************************************                     *                     * REPLACE the defaults with your specific values                     *                     * mac address 6 bytes                            (E000...E005)  E000 FF FF FF FF   wzifma    fcb    $FF,$FF,$FF,$FF,$FF,$FF                     * IP addres for THIS interface (avoid duplicates!!!)  E006 FF FF FF FF   wzifip    fcb    255,255,255,255 (E006...E009)                     * NETMASK  E00A FF FF FF FF   wzifnm    fcb    255,255,255,255 (E00A...E00D)                     * GATEWAY  E00E FF FF FF FF   wzifga    fcb    255,255,255,255 (E00E...E011)                     *                     **************************************************************                       E012 0D 4E 57 50   DBmsg00   fcc    $d,'NWP ROM version:240422',0  E02A 0D 53 79 73   DBmsg01   fcc    $d,'System Initialization Complete',0  E04A 0D 43 50 55   DBmsg02   fcc    $d,'CPU RESET Complete',0  E05E 0D 0D 53 79   CPU_down  fcc    $d,$d,'System CPU not functioning',0                                          * share settings with kernel driver code               E07B  fio_fsz   equ    *         device fifo size               E07D  fio_dsz   equ    *+2       device RAM size               E07F  max_trn   equ    *+4       max transactions                     *                     * share specific DUAL PORT RAM device initialization                     * between UniFLEX kernel and NWP CPU                     *  E07B 0200                    fdb    512       fio_fsz FIFO SIZE  E07D 0400                    fdb    1024      fio_dsz DEVICE SIZE  E07F 08                      fcb    8         fio_mxtrn MAX_TRANSACTIONS                     *                     * declaration of offsets and settings                     *               0008  MAX_WZ    equ    8         # of sockets in w5500                                                               *FIO Simulation Structure             19:34:22  Apr 22, 2024   Page   27System     RESET Code                                                    * System RESET code                     *  E080 10CE 7FE0     rom_init  lds    #ROMstack initialize stack pointer  E084                         ldmd   3  E084 113D                    fdb    $113d  E086 03                      fcb    3                               endm                      >E087 BD   E0E0     20        jsr    stbinit   go initialize system memory                       E08A 10FE 049C     30        lds    tsktab    Task 0 Stack  E08E 32   E9 00D7            leas   TSKSIZ,s  E092 17   0155               lbsr   fio_reset  E095 BD   E646               jsr    skdvini   set the device itself  E098 17   012C               lbsr   timerin                     *                     * Initialization complete - Start executing commands                     *  E09B               fio_start  E09B 7E   E4C1     10        jmp    rsched                                          FIO Simulation Structure             19:34:22  Apr 22, 2024   Page   28ROM        Interrupt Fielders                                              E09E 8D   26       rom_nmi   bsr    rom_int  E0A0 4E 4D 49 00             fcc    'NMI',0  E0A4 8D   20       rom_firq  bsr    rom_int  E0A6 46 49 52 51             fcc    'FIRQ',0  E0AB 8D   19       rom_swi   bsr    rom_int  E0AD 53 57 49 00             fcc    'SWI',0  E0B1 8D   13       rom_swi2  bsr    rom_int  E0B3 53 57 49 32             fcc    'SWI2',0  E0B8 8D   0C       rom_swi3  bsr    rom_int  E0BA 53 57 49 33             fcc    'SWI3',0  E0BF 8D   05       rom_trap  bsr    rom_int  E0C1 54 52 41 50             fcc    'TRAP',0                       E0C6 8E   E0D3     rom_int   ldx    #ROM_ERR  E0C9 BD   F384               jsr    DB_pdata  E0CC 35   10                 puls   x  E0CE BD   F384               jsr    DB_pdata  E0D1 20   FE       rom_bad   bra    *                     *  E0D3 0D 52 4F 4D   ROM_ERR   fcc    $d,'ROM Error: ',0FIO Simulation Structure             19:34:22  Apr 22, 2024   Page   29Table      Initialization                                                                                                               *                     * stbinit - Initialize System Memory Tables                     *  E0E0 8E   0000     stbinit   ldx    #0        s  clear all variables  E0E3 CC   0000               ldd    #0  E0E6 ED   81       10        std    ,x++  E0E8 8C   3EFF               cmpx   #end_vars done yet?  E0EB 25   F9                 blo    10b                       E0ED CC   0D04               ldd    #DEBUG  E0F0 FD   0401               std    DB_cntrl                                            E0F3 B6   E07F               lda    max_trn   shared with main CPU  E0F6 48                      asla             *2  E0F7 8B   04                 adda   #4        fixed system tasks  E0F9 B7   0459               sta    NUM_TSK                     * >E0FC 17   0013               lbsr   set_tables go figure out configuration, tables, etc                                          * Initialize Socket Interrupt Queue  E0FF 8E   040E     15        ldx    #SI_Q     set queue empty  E102 BF   0444               stx    SI_Q_ptr  E105 8E   0447               ldx    #int_buf  reset message in pointer  E108 BF   0453               stx    int_ptr                      >E10B 17   0061     17        lbsr   tskinit   initialize tasks                       E10E 17   1291     18        lbsr   DB_config display configuration  E111 39                      rts                                          *                     * Set up system tables                     *  E112               set_tables  E112 108E 04A0               ldy    #dev_tab  E116 8E   E5F4               ldx    #DEV_SOCK  E119 AF   22                 stx    dev_type,y  E11B AD   98 34              jsr    [D_init,x] (skinit)                                          * Compute configuration  E11E CE   E1D9               ldu    #mod_tbl  tables with module refs  E121 AE   C4       12        ldx    mod_type,u  E123 27   09                 beq    20f       jump if end of module table  E125 AD   98 36              jsr    [D_test,x] check for device  E128 25   04                 bcs    15f       jump if found  E12A 33   44                 leau   MOD_SIZE,u  E12C 20   F3                 bra    12b                     *FIO Simulation Structure             19:34:23  Apr 22, 2024   Page   30Table      Initialization                             E12E               15  E12E               20                     * -- All done setting up configuration                       E12E CC   04C6               ldd    #SYS_TABS start of system tables  E131 1F   03                 tfr    d,u                     * -- Task table  E133 86   D7                 lda    #TSKSIZ  E135 F6   0459               ldb    NUM_TSK  E138 3D                      mul  E139 FF   049C               stu    tsktab >E13C 17   0022               lbsr   sto_chk   check for system table space overflow  E13F FF   049E               stu    tskend                     *                     * -- All done  E142 39            90        rts                     *  E143 0D 2E 2E 2E   00        fcc    $d,"...Can't size tables!",0                     *  E15A 2E 2E 4E 6F   no_dev    fcc    '..None',0                                                                                    *                     * Allocate some system table space                     *   D - Space being consumed                     *   U - Current end of table space                     *   jsr sto_chk (System Table Overflow check)                     *   <CS> if overflow                     *  E161 33   CB       sto_chk   leau   d,u       compute new end pointer  E163 1183 3EFF               cmpu   #end_vars overflow?  E167 22   03                 bhi    10f       yes - return error  E169 1C   FE                 clc              no         - return OK  E16B 39                      rts  E16C 1A   01       10        sec              ..         bad owies  E16E 39                      rts                                          *                     * tskinit - Initialize all tasks                     *  E16F BE   049C     tskinit   ldx    tsktab  E172 BF   0409               stx    utask  E175 F6   0459               ldb    NUM_TSK   # tasks in system  E178 34   04                 pshs   b  E17A 10BE 049C               ldy    tsktab    task 1  E17E 31   A9 00D7            leay   TSKSIZ,y  E182               10                                            E182 86   04       11        lda    #TFREE    mark all tasks free  E184 BC   049C               cmpx   tsktab    is this the system task?FIO Simulation Structure             19:34:23  Apr 22, 2024   Page   31Table      Initialization                             E187 26   02                 bne    15f  E189 86   05                 lda    #TSYS     the system task is never free  E18B A7   04       15        sta    tsstat,x  E18D 86   FF                 lda    #$FF      not associated with a terminal  E18F A7   0D                 sta    tsdev,x  E191 A7   0E                 sta    tsdev+1,x  E193 33   89 00D7            leau   TSKSIZ,x  initialize stack  E197 CC   E337               ldd    #IO_han  E19A 34   20                 pshs   y  E19C AC   E1                 cmpx   ,s++      task 1?  E19E 26   03                 bne    20f       no - normal I/O handling task  E1A0 CC   E407               ldd    #SI_HAN   yes - special terminal interrupt handling task  E1A3 36   06       20        pshu   d  E1A5 EF   88 11              stu    usp,x  E1A8 EF   88 13              stu    umark0,x  E1AB 30   89 00D7            leax   TSKSIZ,x  E1AF 6A   E4                 dec    0,s       done?  E1B1 26   CF                 bne    10b  E1B3 32   61                 leas   1,s       clean up stack  E1B5 CC   0000               ldd    #0        nothing running or sleeping  E1B8 FD   0403               std    runlst  E1BB FD   0405               std    slplst  E1BE FD   0407               std    slplst+tsslnk  E1C1 30   A4                 leax   0,y       start interrupt handling task  E1C3 BD   E567               jsr    makrdy  E1C6 39                      rts                                                               *                     * GPP interrupt timer                     *               8400  tim_base  equ    $8400               8401  tim_rest  equ    $8401                       E1C7 86   00       timerin   lda    #%00000000 D0      (OFF!)  E1C9 B7   8400               sta    tim_base  interrupt enable  E1CC 39                      rts                                                         E1CD  timerack  equ    *  E1CD 86   01                 lda    #1  E1CF B7   8401               sta    tim_rest  reset interrupt  E1D2 39                      rts                       E1D3 B6   8400     timerchk  lda    tim_base  E1D6 84   80                 anda   #%10000000 interrupt flag  E1D8 39                      rtsFIO Simulation Structure             19:34:23  Apr 22, 2024   Page   32IOP        Configuration                                                                      *                     * define which type of boards are present                     *               E1D9  mod_tbl   equ    *  E1D9 E5F4 E1DF               fdb    DEV_SOCK,WZ5_name  E1DD 0000                    fdb    0                     *  E1DF 57 35 35 30   WZ5_name  fcc    'W5500_SOCK',0FIO Simulation Structure             19:34:23  Apr 22, 2024   Page   33FIO        Simulation Routines                                                                *                     * Reset CPU-IOP Interface                     * it is assumed that the FIO (DPR) sits at $0000                     * it sets the offsets to the sock array and to the device info                     *  E1EA               fio_reset                     * when here, all storage locations have been erased already                     *  E1EA 8E   0000               ldx    #0  E1ED 9F   14                 stx    fifo_get  set Q pointers  E1EF 9F   16                 stx    fifo_put  E1F1 8E   0370               ldx    #WZNETOF  E1F4 9F   1A                 stx    fifo_us1  E1F6 8E   0220               ldx    #WZSKOFF  E1F9 9F   18                 stx    fifo_us0  so that kernel CPU can see it                     * init the 8 SOCK structs  E1FB 86   08                 lda    #8  E1FD A7   84       01        sta    wzenum,x  E1FF 30   88 2A              leax   WZSIZE,x  to next  E202 4A                      deca  E203 26   F8                 bne    01b                     *  E205 BE   E07D               ldx    fio_dsz  E208 30   1E                 leax   -2,x      one from top  E20A CE   0400               ldu    #1024     -- Reset Time-Out value                     *  E20D C6   FF       fio_wait  ldb    #255      Spin counter                     *  E20F               00  E20F 6D   84                 tst    0,x       fio_cpuF  E211 27   16                 beq    10f                     *  E213 5A                      decb  E214 26   F9                 bne    00b       jump back if not ready                     *  E216 33   5F                 leau   -1,u  E218 1183 0000               cmpu   #0  E21C 26   EF                 bne    fio_wait  E21E 8E   E05E               ldx    #CPU_down  E221 17   1160               lbsr   DB_pdata  E224 17   1157               lbsr   DB_main  E227 20   C1                 bra    fio_reset                     * reset OK  E229 39            10        rts                                                               *                     * FIO interrupt handler, called when IRQ was set (interrupt context)                     *  E22A BE   0453     fio_irq   ldx    int_ptr   input message pointer  E22D 96   00                 lda    cpu_fio   move REQUESTFIO Simulation Structure             19:34:24  Apr 22, 2024   Page   34FIO        Simulation Routines                        E22F A7   80                 sta    ,x+  E231 DC   01                 ldd    cpu_fio1  sequence # TASK ID  E233 ED   81                 std    ,x++  E235 96   03                 lda    cpu_fio2  specific DATA  E237 A7   80                 sta    ,x+  E239 DC   04                 ldd    cpu_fio3  device major/minor  E23B ED   81                 std    ,x++                     *                     * X[0]=cmd,X[1][2]=task ID,X[3]=data, X[4][5]=device                     *  E23D FE   E07D               ldu    fio_dsz  E240 33   5F                 leau   -1,u  E242 6F   C4                 clr    0,u       cpu_fioF indicate message consumed                     *  E244 BF   0453               stx    int_ptr   update pointer  E247 108E 0447               ldy    #int_buf  get message from buffer  E24B A6   A4                 lda    0,y       -- Send interrupt command?  E24D 81   38                 cmpa   #S_INTRPT  E24F 26   0D                 bne    30f                     *                     * special case OOB signal                     *  E251 10BF 0453               sty    int_ptr   reset pointer  E255 E6   23                 ldb    3,y       signal  E257 AE   24                 ldx    4,y       SOCK reference                     *  E259 BD   E69E               jsr    sdev_sig  send device signal  E25C 20   35                 bra    fiointe   exit                     *                     * normal command                     * acquire free task slot                     *  E25E BE   049C     30        ldx    tsktab    search for an available task  E261 F6   0459               ldb    NUM_TSK   Number of tasks in system                     *  E264 A6   04       32        lda    tsstat,x  E266 81   04                 cmpa   #TFREE    looking for a "free" task  E268 27   0E                 beq    40f                     *  E26A 30   89 00D7            leax   TSKSIZ,x  E26E 5A                      decb  E26F 26   F3                 bne    32b                     *  E271 C6   82                 ldb    #E_SYSBSY can't process - IOP saturated! >E273 BD   E294               jsr    fio_msg  E276 20   1B                 bra    fiointe   exit                     *                     * X[0]=cmd,X[1][2]=task ID,X[3]=data, X[4][5]=device                     * move data over into task struct                     *  E278 108E 0447     40        ldy    #int_buf  get message from buffer  E27C 10BF 0453               sty    int_ptr   reset pointerFIO Simulation Structure             19:34:24  Apr 22, 2024   Page   35FIO        Simulation Routines                        E280 E6   A0                 ldb    ,y+       command byte  REQUEST  E282 E7   09                 stb    tscmd,x   save for task  E284 EC   A1                 ldd    ,y++      sequence #    task ID  E286 ED   0A                 std    tsseq,x  E288 E6   A0                 ldb    ,y+       command specific DATA  E28A E7   0C                 stb    tstval,x  E28C EC   A1                 ldd    ,y++      associate with terminal major/minor  E28E ED   0D                 std    tsdev,x  E290 BD   E567               jsr    makrdy    make task ready to run                     *  E293 39            fiointe   rts              exit                                          *                     * fio_msg - Send a message via the FIO Mailbox                     * it is assumed that the FIO (DPR) sits at $0000                     *   B - Message code to send (one byte)                     *   fio_cpu1..3 already set up                     *  E294 34   54       fio_msg   pshs   b,x,u     save register  E296 FE   E07D               ldu    fio_dsz  E299 33   5E                 leau   -2,u      one off top  E29B D7   09                 stb    fio_cpu   set up mailbox value                       E29D 86   FF       5         lda    #$FF      tell CPU mailbox full  E29F A7   C4                 sta    0,u       fio_cpuF  E2A1 8E   FFFF     05        ldx    #$FFFF    time-out counter                     *  E2A4 A6   C4       10        lda    0,u       fio_cpuF   wait till value consumed  E2A6 27   06                 beq    20f       jump if consumed                     *  E2A8 30   1F                 leax   -1,x      time-out yet?  E2AA 26   F8                 bne    10b                     *  E2AC 20   F3                 bra    05b       try again                     *  E2AE 35   D4       20        puls   b,x,u,pc                     *                                          *                     * this is the normal way the IOP sends data to the host CPU                     * fio_response - Return a response code/sequence #                     * it is assumed that the FIO (DPR) sits at $0000                     *    X = utask,                     *    B - Response code                     *    A - Transaction specific value                     *  E2B0 34   16       fio_response pshs d,x  E2B2 8D   18                 bsr    FIO_get   access FIO  E2B4 BE   0409               ldx    utask     task ID  E2B7 EC   0A                 ldd    tsseq,x  E2B9 DD   0A                 std    fio_cpu1  E2BB EC   0D                 ldd    tsdev,x   device infoFIO Simulation Structure             19:34:24  Apr 22, 2024   Page   36FIO        Simulation Routines                        E2BD DD   0D                 std    fio_cpu3  E2BF A6   E4                 lda    0,s       get transaction specific value (i.e. error code)  E2C1 97   0C                 sta    fio_cpu2  E2C3 E6   61                 ldb    1,s       is RESPONSE code >E2C5 BD   E294               jsr    fio_msg  E2C8 8D   17                 bsr    FIO_rel   release FIO  E2CA 35   96                 puls   d,x,pc    return                                          *                     * FIO_get - Get access to FIO device                     * -- Sleep till available                     *  E2CC 34   76       FIO_get   pshs   d,x,y,u   save registers  E2CE 108E 0446     10        ldy    #FIO_lock is the device locked  E2D2 6D   A4                 tst    0,y  E2D4 27   07                 beq    20f       no - go get it                     *  E2D6 C6   CE                 ldb    #FIOPRI   waiting for the FIO  E2D8 BD   E5A1               jsr    sleep  E2DB 20   F1                 bra    10b       try again                     *  E2DD 6C   A4       20        inc    0,y       mark in use  E2DF 35   F6                 puls   d,x,y,u,pc return                                          *                     * FIO_rel - Release access to FIO                     *  E2E1 34   76       FIO_rel   pshs   d,x,y,u  E2E3 108E 0446               ldy    #FIO_lock  E2E7 6F   A4                 clr    0,y  E2E9 BD   E57D               jsr    wakeup  E2EC 35   F6                 puls   d,x,y,u,pc return                                          *                     * FIFO_get - Fetch character from FIFO                     *   B - Character fetched                     *  E2EE 34   04       FIFOgeta  pshs   b  E2F0 8D   05                 bsr    FIFO_get  E2F2 35   02                 puls   a  E2F4 1E   89                 exg    a,b  E2F6 39                      rts                     *  E2F7 34   12       FIFO_get  pshs   a,x  E2F9 DC   12                 ldd    fifo_cnt  any data?  E2FB 27   15                 beq    99f       no - exit                     *  E2FD                         decd   yes       - adjust count  E2FD 104A                    fdb    $104a                               endm  E2FF DD   12                 std    fifo_cnt  E301 9E   14                 ldx    fifo_get  get consumer pointerFIO Simulation Structure             19:34:24  Apr 22, 2024   Page   37FIO        Simulation Routines                        E303 E6   88 20              ldb    fifo,x    fetch byte  E306 30   01                 leax   1,x       bump pointer  E308 BC   E07B               cmpx   fio_fsz   end of fifo?  E30B 26   03                 bne    10f                     *  E30D 8E   0000               ldx    #0        reset pointer                     *  E310 9F   14       10        stx    fifo_get                     *  E312 35   92       99        puls   a,x,pc                                          *                     * FIFO_put - Place character into FIFO                     *   B - Character fetched                     *  E314 34   04       FIFOputa  pshs   b  E316 1F   89                 tfr    a,b  E318 8D   02                 bsr    FIFO_put  E31A 35   84                 puls   b,pc                     *  E31C 34   16       FIFO_put  pshs   d,x  E31E 9E   16                 ldx    fifo_put  get consumer pointer  E320 E7   88 20              stb    fifo,x    store byte  E323 30   01                 leax   1,x       bump pointer  E325 BC   E07B               cmpx   fio_fsz   end of FIFO?  E328 26   03                 bne    10f                     *  E32A 8E   0000               ldx    #0        reset pointer  E32D 9F   16       10        stx    fifo_put                     *  E32F DC   12                 ldd    fifo_cnt  E331                         incd  E331 104C                    fdb    $104c                               endm  E333 DD   12                 std    fifo_cnt  E335 35   96       99        puls   d,x,pcFIO Simulation Structure             19:34:25  Apr 22, 2024   Page   38IO         Command Handler                                               *                     *                     * IO_han - I/O Command Handler                     *   This routine comprises the main processing loop                     * for each task in the system.  Whenever an I/O command                     * is detected (via the message interrupt), a task will                     * be scheduled to process it.  This is that task.                     *   The command is saved in the "tscmd" field of the                     * task control block.                     *  E337               IO_han    seti   block     interrupts  E337 1A   50                 orcc   #FF|IF                               endm                     *                     * we execute the task belonging to the transaction                     *  E339               10        clri  E339 1C   AF                 andcc  #!(FF|IF)                               endm  E33B BE   0409               ldx    utask     get task control block address  E33E A6   09                 lda    tscmd,x   get I/O command                     *                     * The command byte is shifted and used as an index                     * in a DEV_XXXX tab                     *  E340 44                      lsra             isolate    command  E341 44                      lsra  E342 44                      lsra                     **        lsra  E343 81   19                 cmpa   #MAX_S_NUM  E345 22   69                 bhi    bad_cmd                     *  E347 48                      lsla             --   word index on command  E348 34   10                 pshs   x  E34A 8E   04A0               ldx    #dev_tab  E34D AE   02                 ldx    dev_type,x get handler table address  E34F 10AE 86                 ldy    a,x       get processor address  E352 35   10                 puls   x  E354 34   20                 pshs   y  E356 10AE 0F                 ldy    tsagin,x  if 0, d nothing  E359 27   0A                 beq    05f       else it is target ponter  E35B 10AF E4                 sty    0,s  E35E 108E 0000               ldy    #0  E362 10AF 0F                 sty    tsagin,x  reset pointer  E365 35   20       05        puls   y         change address  E367 4F                      clra                     *  E368 8E   E395               ldx    #IO_end   interrupt handler address  E36B 34   10                 pshs   x  E36D BE   0409               ldx    utask     task pointer  E370 10EF 88 15              sts    umark1,x  E374 EE   0D                 ldu    tsdev,x   get sock refernceFIO Simulation Structure             19:34:25  Apr 22, 2024   Page   39IO         Command Handler                            E376 1E   03                 exg    d,u  E378 84   07                 anda   #%00000111 mask off address bits  E37A 1E   03                 exg    d,u                     *                     * CALL HANDLER: X=utask, Y=handler address, U=sock address                     *  E37C AD   A4                 jsr    0,y       perform operation & return status  E37E 32   62                 leas   2,s       clean up stack                     *                     * on return, Y= flag. -1 is resched, else end task                     *  E380 BE   0409               ldx    utask     restore task pointer  E383 108C FFFF               cmpy   #$ffff  E387 26   09                 bne    20f                     * task is NOT done yet  E389 86   BA                 lda    #POLPRI  E38B A7   05                 sta    tsprir,x  at lower prio  E38D BD   E4BB               jsr    change  E390 20   1B                 bra    91f       just escape (and come back)                     *                     * A=transaction value, B=response code, U=device reference                     * X = task pointer                     * in fio_response the task ID is added as sequence reference                     * SEND the response to the host CPU                     *                     *  E392 BD   E2B0     20        jsr    fio_response                     *                     * task is done                     *  E395               IO_end    seti   mask      interrupts  E395 1A   50                 orcc   #FF|IF                               endm  E397 BE   0409               ldx    utask     restore task control block address  E39A A7   0C                 sta    tstval,x  remember transaction value sent  E39C E7   09                 stb    tscmd,x   and command response  E39E 86   04                 lda    #TFREE    mark task "terminated & free"  E3A0 A7   04                 sta    tsstat,x  E3A2 86   FF                 lda    #$FF      disassociate from any terminal  E3A4 A7   0D                 sta    tsdev,x  E3A6 A7   0E                 sta    tsdev+1,x  E3A8 6F   08                 clr    tssgnl,x  no waiting signals                     *                     * exit here to rescheduling                     *  E3AA BD   E4C1     90        jsr    rsched    run other tasks >E3AD 16   FF87     91        lbra   IO_han                                          *                     * Illegal command                     *  E3B0               bad_cmdFIO Simulation Structure             19:34:25  Apr 22, 2024   Page   40IO         Command Handler                            E3B0 C6   81                 ldb    #E_BADCMD error code  E3B2 39                      rtsFIO Simulation Structure             19:34:25  Apr 22, 2024   Page   41Interrupt  Processing                                                                         *                     * This routine handles all IRQ interrupts                     *                     *               E3B3  IRQ_han   equ    *                     *                     * Check for FIO Mailbox interrupt                     *  E3B3 BE   E07D     10        ldx    fio_dsz  E3B6 30   1F                 leax   -1,x  E3B8 A6   84                 lda    0,x       cpu_fioF   see if mailbox interrupt  E3BA 27   03                 beq    99f       no - move on  E3BC BD   E22A               jsr    fio_irq   call fio interrupt handler                     *                     *         lbsr    DB_main                     *  E3BF 3B            99        rti              return from interrupt                     *  E3C0 0D 49 4F 50   IRQmsg10  fcc    $d,'IOP Got: ',0  E3CB 2D 2D 20 4E   00        fcc    '-- No tasks!',0FIO Simulation Structure             19:34:25  Apr 22, 2024   Page   42Interrupt  All Tasks                                                                          *                     * Interrupt all tasks associated with a given device                     *   A - Device #                     *   jsr int_all                     * Note: The current task is skipped, along with                     * the system and the interrupt handler task (1).                     *  E3D8 34   36       int_all   pshs   d,x,y  E3DA F6   0459               ldb    NUM_TSK  E3DD C0   02                 subb   #2  E3DF 34   04                 pshs   b  E3E1 BE   049C               ldx    tsktab  E3E4 30   89 01AE            leax   2*TSKSIZ,x                     *  E3E8 EC   61       10        ldd    1,s  E3EA 10A3 0D                 cmpd   tsdev,x   is this guy associated with the device?  E3ED 26   0C                 bne    20f                     *  E3EF BC   0409               cmpx   utask     make sure I don't get blown away  E3F2 27   07                 beq    20f                     *  E3F4 34   16                 pshs   d,x  E3F6 BD   E5D6               jsr    xmtint    interrupt task  E3F9 35   16                 puls   d,x                     *  E3FB 30   89 00D7  20        leax   TSKSIZ,x  next task  E3FF 6A   E4                 dec    0,s       more tasks?  E401 26   E5                 bne    10b  E403 32   61                 leas   1,s                     *  E405 35   B6                 puls   d,x,y,pc  returnFIO Simulation Structure             19:34:26  Apr 22, 2024   Page   43Terminal   Interrupt Handling Task                                                            *                     * SI_HAN Socket interrupt handler                     *  E407 108E 040E     SI_HAN    ldy    #SI_Q     Terminal Interrupt Queue  E40B                         seti  E40B 1A   50                 orcc   #FF|IF                               endm  E40D FE   0444               ldu    SI_Q_ptr  get current Q ptr  E410 1183 040E               cmpu   #SI_Q     anything in Q?  E414 26   07                 bne    20f       yes - go process it                     *  E416 C6   D8                 ldb    #SIQPRI   wait for something to do  E418 BD   E5A1               jsr    sleep  E41B 20   EA                 bra    SI_HAN                     *                     * U[0]=int,U[1][2]=dev,U[3][4]=task                     *  E41D E6   C2       20        ldb    0,-u      B = Interrupt #  E41F 34   04                 pshs   b  E421 EC   C3                 ldd    0,--u     A = Device #  E423 34   06                 pshs   d  E425 EC   C3                 ldd    0,--u     task ID  E427 34   06                 pshs   d         save registers  E429 FF   0444               stu    SI_Q_ptr  update pointer                     *                     * S[0][1]=task,U[2][3]=dev,U[4]=response                     *  E42C E6   63                 ldb    3,s       set up to flush all input for this terminal  E42E                         clri   allow     interrupts  E42E 1C   AF                 andcc  #!(FF|IF)                               endm                     *  E430 BD   E2CC               jsr    FIO_get   get access to FIO  E433 EC   E1                 ldd    0,s++     task ID  E435 DD   0A                 std    fio_cpu1  E437 EC   E1                 ldd    ,s++      terminal #  E439 DD   0D                 std    fio_cpu3  terminal  E43B E6   E0                 ldb    ,s+       interrupt #  E43D D7   0C                 stb    fio_cpu2  signal  E43F C6   07                 ldb    #R_INTRPT  E441 BD   E294               jsr    fio_msg   send interrupt message  E444 BD   E2E1               jsr    FIO_rel   release access to FIO  E447 20   BE                 bra    SI_HAN    process more if needed                                          *                     * Send_SI - Send a socket interrupt                     *   B = Interrupt #                     *   X = task struct                     *   U= wzsock                     *   jsr send_SI                     *FIO Simulation Structure             19:34:26  Apr 22, 2024   Page   44Terminal   Interrupt Handling Task                    E449 34   76       send_SI   pshs   d,x,y,u   save registers  E44B EC   C8 26              ldd    wztype,u  E44E 85   02                 bita   #WFSPOC  E450 27   1F                 beq    99f                     *  E452 FE   0444               ldu    SI_Q_ptr  get Q head  E455 1183 0444               cmpu   #SI_Q_ptr check for overflow  E459 24   0F                 bhs    90f       exit if so - sorry                     *  E45B EC   0A                 ldd    tsseq,x   task ID @ master side  E45D ED   C1                 std    0,u++  E45F EC   0D                 ldd    tsdev,x   wzsock#  E461 ED   C1                 std    0,u++     place value in Queue  E463 E6   61                 ldb    1,s       old B  E465 E7   C0                 stb    0,u+  E467 FF   0444               stu    SI_Q_ptr  update pointer                     *                     * U[0]=int,U[1][2]=dev,U[3][4]=task                     *                     *  E46A 108E 040E     90        ldy    #SI_Q     wake up Queue server  E46E BD   E57D               jsr    wakeup  E471 35   F6       99        puls   d,x,y,u,pc return                     FIO Simulation Structure             19:34:26  Apr 22, 2024   Page   45History    Entry Procedures                                                                   *                     * H_cpu - Place a transaction from the CPU into                     *         the history Queue.                     *  E473 34   16       H_cpu     pshs   d,x  E475 BE   049A               ldx    hstptr    get history queue pointer  E478 96   00                 lda    cpu_fio  E47A A7   84                 sta    hst_cmd,x  E47C 96   01                 lda    cpu_fio1  E47E A7   01                 sta    hst_seq,x  E480 96   04                 lda    cpu_fio3  E482 A7   02                 sta    hst_tty,x  E484 96   03                 lda    cpu_fio2  E486 A7   03                 sta    hst_val,x  E488 30   04                 leax   HRECSIZ,x  E48A 8C   049A               cmpx   #hstptr   end of Queue?  E48D 25   03                 blo    10f  E48F 8E   045A               ldx    #hstbuf  E492 BF   049A     10        stx    hstptr  E495 35   96                 puls   d,x,pc                                          *                     * H_fio - Place a transaction from the IOP into                     *         the history Queue.                     *  E497 34   16       H_fio     pshs   d,x  E499 BE   049A               ldx    hstptr    get history queue pointer  E49C 96   09                 lda    fio_cpu  E49E A7   84                 sta    hst_cmd,x  E4A0 96   0A                 lda    fio_cpu1  E4A2 A7   01                 sta    hst_seq,x  E4A4 96   0D                 lda    fio_cpu3  E4A6 A7   02                 sta    hst_tty,x  E4A8 96   0C                 lda    fio_cpu2  E4AA A7   03                 sta    hst_val,x  E4AC 30   04                 leax   HRECSIZ,x  E4AE 8C   049A               cmpx   #hstptr   end of Queue?  E4B1 25   03                 blo    10f  E4B3 8E   045A               ldx    #hstbuf  E4B6 BF   049A     10        stx    hstptr  E4B9 35   96                 puls   d,x,pcFIO Simulation Structure             19:34:27  Apr 22, 2024   Page   46Scheduler  routines                                                                           *                     * All routines in this file pertain to scheduling                     * operations.                     *                                          *                     * change & rsched                     *                     * Change will change tasks.  The current task is put                     * back on the linked list of running tasks.                     * Rsched will reschedule the cpu giving control to                     * another ready task.  If no tasks are ready, idle                     * looping is done until one becomes ready.  Rsched                     * does not put the current task back on the ready list!                     * This routine returns one to the caller.  All registers                     * are destroyed.                     *                       E4BB BE   0409     change    ldx    utask     point to task table entry >E4BE 17   006D               lbsr   putrun    put on ready list                     *  E4C1               rsched    seti   mask      interrupts  E4C1 1A   50                 orcc   #FF|IF                               endm  E4C3 BE   0409               ldx    utask     point to current task  E4C6 10EF 88 13              sts    umark0,x  save stack pointers  E4CA BE   049C               ldx    tsktab    point to task table  E4CD 8D   23                 bsr    swtchu    switch users  E4CF 7F   040D               clr    idle      reset idle/running flag                     *  E4D2 7F   040C     rsche2    clr    chproc    reset change flag >E4D5 17   0025               lbsr   getjob    get a new task  E4D8 26   0C                 bne    rsche3    find one?                                          ***+++                     ***---                       E4DA 86   7F       05        lda    #127      set higheset priority  E4DC B7   040B               sta    jobpri    set as current  E4DF                         clri   clear     interrupts  E4DF 1C   AF                 andcc  #!(FF|IF)                               endm                     * idle work could go on here  E4E1 12                      nop  E4E2                         seti  E4E2 1A   50                 orcc   #FF|IF                               endm  E4E4 20   EC                 bra    rsche2    loop til find a ready one                     *  E4E6 F7   040B     rsche3    stb    jobpri    set new priority  E4E9 8D   07                 bsr    swtchu    switch users top pageFIO Simulation Structure             19:34:27  Apr 22, 2024   Page   47Scheduler  routines                                   E4EB BE   0409               ldx    utask     point to task                     ** -- I don't think this will ever happen                     ** tst tssgnl,x any waiting signals?                     ** lbne sleep yes - this will blow task away...  E4EE CC   0001               ldd    #1        return 1 to new task  E4F1 39                      rts              return                                              *                     * Switch users                     *   X - Task entry for new task                     *  E4F2 35   20       swtchu    puls   y         get return address  E4F4 BF   0409               stx    utask     set up new running task  E4F7 10EE 88 13              lds    umark0,x  reset stack                                          ***+++                     ***---                       E4FB 6E   A4                 jmp    0,y       return to caller                                          ***+++                     ***---                                                                                    ***+++                     ***---                                          FIO Simulation Structure             19:34:27  Apr 22, 2024   Page   48Scheduler  routines                                                                           *                     * getjob                     *                     * Search ready list for ready task.  If none found,                     * return 'EQ' status.  Otherwise return task table                     * entry address in x.                     *                       E4FD 5F            getjob    clrb             clear      flag  E4FE BE   0403               ldx    runlst    point to head of list  E501 27   1F                 beq    getjo6    empty list?                     *  E503 A6   04       getjo1    lda    tsstat,x  get status byte  E505 81   01                 cmpa   #TRUN     is it in run state?  E507 26   1B                 bne    getjo8                     *  E509 5D                      tstb             first      in list?  E50A 27   06                 beq    getjo2                     *  E50C EC   84                 ldd    tslink,x  remove from list  E50E ED   A4                 std    tslink,y  E510 20   07                 bra    getjo4                     *  E512 10AE 84       getjo2    ldy    tslink,x  remove from list head  E515 10BF 0403               sty    runlst    set new head                     *  E519 E6   05       getjo4    ldb    tsprir,x  get priority  E51B 6F   84                 clr    tslink,x  zero out link  E51D 6F   01                 clr    tslink+1,x so not run list  E51F 86   FF                 lda    #$ff      set ne status  E521 39                      rts              return                         *  E522 4F            getjo6    clra             set        eq status  E523 39                      rts                     *  E524 1F   12       getjo8    tfr    x,y       save old pos  E526 AE   84                 ldx    tslink,x  follow link  E528 27   F8                 beq    getjo6                     *  E52A C6   01                 ldb    #1        set flag  E52C 20   D5                 bra    getjo1    repeat loop                     FIO Simulation Structure             19:34:27  Apr 22, 2024   Page   49Scheduler  routines                                                                           *                     * putrun                     *                     * Put current task on ready list.  The list is                     * arranged with higher priority tasks at the top.                     * If equal priorities are found, the new one is                     * put at the end of the block.  On entry, x points                     * to the task table entry.  All registers are                     * destroyed except x.                     *                       E52E 34   01       putrun    pshs   cc        save status  E530                         seti   mask      interrupts  E530 1A   50                 orcc   #FF|IF                               endm  E532 10BE 0403               ldy    runlst    point to head  E536 26   0A                 bne    putru2  E538 BF   0403               stx    runlst    set new head                     *  E53B CC   0000     putru1    ldd    #0        set last link  E53E ED   84                 std    tslink,x  E540 35   81                 puls   cc,pc     return                     *  E542 E6   05       putru2    ldb    tsprir,x  get priority  E544 E1   25                 cmpb   tsprir,y  look for correct prior slot  E546 2F   08                 ble    putru4                     *  E548 FC   0403               ldd    runlst  E54B BF   0403               stx    runlst    set new head  E54E 20   0F                 bra    putru5    link in rest                     *  E550 1F   23       putru4    tfr    y,u       save last look  E552 10AE A4                 ldy    tslink,y  follow link  E555 27   0C                 beq    putru6                     *  E557 E1   25                 cmpb   tsprir,y  check priority  E559 2F   F5                 ble    putru4                     *  E55B EC   C4                 ldd    tslink,u  link into list here  E55D AF   C4                 stx    tslink,u                     *  E55F ED   84       putru5    std    tslink,x  E561 35   81                 puls   cc,pc     return                     *  E563 AF   C4       putru6    stx    tslink,u  E565 20   D4                 bra    putru1    go zero last link                     FIO Simulation Structure             19:34:28  Apr 22, 2024   Page   50Scheduler  routines                                                                           *                     * makrdy                     *                     * Make a task ready to run.  Enter with x                     * pointing to task table entry.  If new tasks                     * priority is higher than current, set the                     * 'chproc' flag so the system can change tasks.                     *                       E567 86   01       makrdy    lda    #TRUN     set status  E569 A7   04                 sta    tsstat,x  E56B CC   0000               ldd    #0        clear events flag  E56E ED   06                 std    tsevnt,x  E570 8D   BC                 bsr    putrun    put on ready list  E572 E6   05                 ldb    tsprir,x  get priority  E574 F1   040B               cmpb   jobpri    higher than current?  E577 2F   03                 ble    makrd6                     *  E579 7C   040C               inc    chproc    set change flag                     *  E57C 39            makrd6    rts              return    FIO Simulation Structure             19:34:28  Apr 22, 2024   Page   51Sleep      and Wakeup routines                                                                *                     * wakeup                     *                     * Wakeup all tasks waiting the event designated                     * in the y register.  The x reg is preserved.                     *                       E57D 34   57       wakeup    pshs   cc,d,x,u  save registers  E57F                         seti   mask      interupts  E57F 1A   50                 orcc   #FF|IF                               endm  E581 CE   0405               ldu    #slplst  E584 AE   42                 ldx    tsslnk,u  point to sleep list  E586 27   0B                 beq    wakeu4                     *  E588 10AC 06       wakeu2    cmpy   tsevnt,x  check event  E58B 27   08                 beq    wakeu5  E58D 33   84                 leau   0,x       mark this entry                     *  E58F AE   02       wakeu3    ldx    tsslnk,x  follow chain  E591 26   F5                 bne    wakeu2    end of list?                     *  E593 35   D7       wakeu4    puls   cc,d,x,u,pc return                     *  E595 34   70       wakeu5    pshs   x,y,u     save registers  E597 EC   02                 ldd    tsslnk,x  remove from list  E599 ED   42                 std    tsslnk,u  E59B 8D   CA                 bsr    makrdy    put on ready list  E59D 35   70                 puls   u,x,y  E59F 20   EE                 bra    wakeu3    repeat                     FIO Simulation Structure             19:34:28  Apr 22, 2024   Page   52Sleep      and Wakeup routines                                                                *                     * sleep                     *                     * Sleep will put this task to sleep with priority                     * specified in the b register.  On entry, y is pointing                     * to the event which will be awakened.                     *  E5A1 34   51       sleep     pshs   cc,x,u    save registers  E5A3 BE   0409               ldx    utask     point to task  E5A6 6D   08                 tst    tssgnl,x  any signals waiting?  E5A8 26   1F                 bne    sleep7                     *  E5AA                         seti   mask      ints  E5AA 1A   50                 orcc   #FF|IF                               endm  E5AC E7   05                 stb    tsprir,x  set priority  E5AE 10AF 06                 sty    tsevnt,x  set event  E5B1 86   02                 lda    #TSLEEP   set status  E5B3 A7   04                 sta    tsstat,x  E5B5 FC   0407               ldd    slplst+tsslnk get head of list  E5B8 ED   02                 std    tsslnk,x  set new link  E5BA BF   0407               stx    slplst+tsslnk set new head  E5BD 17   FF01               lbsr   rsched    reschedule cpu                       E5C0 BE   0409     20        ldx    utask     get task entry  E5C3 6D   08                 tst    tssgnl,x  any signals waiting?  E5C5 26   02                 bne    sleep7                     *  E5C7 35   D1                 puls   cc,x,u,pc return                     *  E5C9 BE   0409     sleep7    ldx    utask     reset signal  E5CC 6F   08                 clr    tssgnl,x  E5CE EC   88 15              ldd    umark1,x  stack reset point  E5D1 35   51                 puls   cc,x,u    reset cc and registers  E5D3 1F   04                 tfr    d,s       change stacks  E5D5 39                      rts              returnFIO Simulation Structure             19:34:28  Apr 22, 2024   Page   53Sleep      and Wakeup routines                                                                *                     * xmtint - Send an interrupt to a task                     *  X - Task entry                     *  jsr xmtint                     *  E5D6 34   76       xmtint    pshs   d,x,y,u   save registers  E5D8 A6   04                 lda    tsstat,x  get task state  E5DA 81   01                 cmpa   #TRUN     running?  E5DC 26   06                 bne    10f       no - try something else                     *  E5DE 86   01                 lda    #1        set signal  E5E0 A7   08                 sta    tssgnl,x  E5E2 20   0E                 bra    99f       exit                     *  E5E4 81   02       10        cmpa   #TSLEEP   task sleeping?  E5E6 26   0A                 bne    99f       no - can't send interrupt                     *  E5E8 86   01                 lda    #1        set signal  E5EA A7   08                 sta    tssgnl,x  E5EC 10AE 06                 ldy    tsevnt,x  wake task up >E5EF 17   FF8B               lbsr   wakeup                     *  E5F2 35   F6       99        puls   d,x,y,u,pc returnFIO Simulation Structure             19:34:29  Apr 22, 2024   Page   54Sleep      and Wakeup routines                                                                *                     * the routines in this file are specific                     * for the W5500 socket device                     * they are called from "wskhan" and "wskdrv" files                     *                     * wzsocket device table                     *  E5F4               DEV_SOCK  E5F4 E3B0                    fdb    bad_cmd   0  E5F6 E6E3                    fdb    skopen    S_OPEN    1 open socket  E5F8 E783                    fdb    skclos    S_CLOSE   2 close socket  E5FA E9A4                    fdb    skreqwr   S_RQWR    3 request write to socket  E5FC E9EB                    fdb    sksend    S_SEND    4 write data to socket  E5FE E914                    fdb    skreqrd   S_RQRD    5 request read data from socket  E600 E961                    fdb    skrecv    S_RECV    6 read data from socket  E602 ED10                    fdb    skintrp   S_INTRPT  7 interrupt socket  E604 E7D0                    fdb    skconn    S_CONNECT 8 connect socket  E606 E866                    fdb    skbind    S_BIND    9 bind socket  E608 E8AB                    fdb    sklist    S_LISTEN  10 listen on socket  E60A E8DD                    fdb    skacpt    S_ACCEPT  11 accept connection  E60C ED10                    fdb    skdisc    S_DISCON  12 disconnect socket  E60E ED10                    fdb    sksmac    S_SNDMAC  13 send mac  E610 ED10                    fdb    skskep    S_SNDKEP  14 send keep alive  E612 EC4C                    fdb    skspcl    S_SPCL    15 special command  E614 EA2E                    fdb    skurrdf   S_RRDFRM  16 request read readfrom  E616 EAA5                    fdb    skurrd    S_RREAD   17 read data readfrom  E618 EAD3                    fdb    skurwt    S_WRQSTO  18 request write sendto  E61A EB78                    fdb    skusnt    S_WSNDTO  19 write data sendto  E61C EB22                    fdb    skusnm    S_WSNDTM  20 write data send more  E61E EC2C                    fdb    sknbsr    S_RQSBLK  21 netblock req send ext block  E620 EC3C                    fdb    sknbsd    S_SNDBLK  22 netblock send ext block  E622 EBB2                    fdb    sknbrr    S_RQRBLK  23 netblock req read ext block  E624 EC09                    fdb    sknbrd    S_RDRBLK  24 netblock read ext block                     *  E626 E69D                    fdb    skinthan  16 socket interrupt handler  E628 E62C                    fdb    skinit    17 socket initialization  E62A E69A                    fdb    sktest    18 test device present                     *                     *                     * this file contains all socket handlers                     *                     * when a wzsocket is opened, all locations are effectively                     * cleared to zero, with exception of the enumeration byte                     *                                          *                     * do everything to init the system                     *               E62C  skinit    equ    *  E62C BD   ED17               jsr    spinit    set SPI  E62F C6   82                 ldb    #%10000010 software reset + force ARPFIO Simulation Structure             19:34:29  Apr 22, 2024   Page   55wz socket interface routines                          E631 BD   EDE7               jsr    PCRMR  E634 BD   EDD8     01        jsr    GCRMR  E637 5D                      tstb  E638 2B   FA                 bmi    01b                     *  E63A C6   78                 ldb    #%01111000 power up  E63C BD   EFC5               jsr    PCRPHY    set the PHY part  E63F CC   8000               ldd    #32768  E642 FD   0457               std    wzanyp    set value for Source port  E645 39                      rts                                          *                     * check if ROM locations are preset, if not skip this here                     * else setup device with provided values                     *  E646 108E E000     skdvini   ldy    #wzifma   where mac address is to be found  E64A EC   A1       03        ldd    0,y++  E64C 1083 FFFF               cmpd   #$ffff    not set  E650 26   07                 bne    02f  E652 108C E012               cmpy   #wzifga+4 past area  E656 25   F2                 blo    03b                     * ROM not initialized, do nothing  E658 39                      rts                                          *                     * values present, setup device                     *  E659 34   66       02        pshs   d,y,u  E65B DE   1A                 ldu    fifo_us1  E65D 108E E006               ldy    #wzifip   source IP  E661 EC   A1                 ldd    0,y++  E663 ED   C1                 std    0,u++  E665 EC   A1                 ldd    0,y++  E667 ED   C1                 std    0,u++  E669 108E E00A               ldy    #wzifnm   netmask  E66D EC   A1                 ldd    0,y++  E66F ED   C1                 std    0,u++  E671 EC   A1                 ldd    0,y++  E673 ED   C1                 std    0,u++  E675 108E E00E               ldy    #wzifga   gateway ip  E679 EC   A1                 ldd    0,y++  E67B ED   C1                 std    0,u++  E67D EC   A1                 ldd    0,y++  E67F ED   C1                 std    0,u++  E681 108E E000               ldy    #wzifma   mac address  E685 EC   A1                 ldd    0,y++  E687 ED   C1                 std    0,u++  E689 EC   A1                 ldd    0,y++  E68B ED   C1                 std    0,u++  E68D EC   A1                 ldd    0,y++  E68F ED   C1                 std    0,u++                     *FIO Simulation Structure             19:34:29  Apr 22, 2024   Page   56wz socket interface routines                          E691 C6   FF                 ldb    #$ff      set active  E693 E7   C4                 stb    0,u  E695 BD   EC7B               jsr    wzwdev    init device with settings  E698 35   E6                 puls   d,y,u,pc                                          *                     * test if device is present                     *  E69A 1A   01       sktest    sec              yes  E69C 39                      rts                                          *                     * skinthan, fromddevice table                     *               E69D  skinthan  equ    *  E69D 39                      rts                                          *                     * device signal handle, from master                     *               E69E  sdev_sig  equ    *  E69E 39                      rts                                          *                     * get a new source port                     *  E69F FC   0457     sknewp    ldd    wzanyp    else create one  E6A2                         incd  E6A2 104C                    fdb    $104c                               endm  E6A4 1083 FFF0               cmpd   #$FFF0  E6A8 25   03                 blo    03f  E6AA CC   8000               ldd    #$8000  E6AD FD   0457     03        std    wzanyp  E6B0 39                      rts                                                               *                     * check if W5500 is active                     * wzdevt, device test, return Z if running, NZ if not                     *  E6B1 34   22       wzdevt    pshs   a,y  E6B3 109E 1A                 ldy    fifo_us1  device info  E6B6 A6   A8 12              lda    wzdsta,y  E6B9 81   FF                 cmpa   #$ff      open  E6BB 35   A2                 puls   a,y,pc                                          *                     * skfres, socket restore info, set E register                     *  E6BD A6   C4       skfres    lda    wzenum,u  socket #, is remembered  E6BF                         trfr   A,EFIO Simulation Structure             19:34:30  Apr 22, 2024   Page   57wz socket interface routines                          E6BF 1F                      fcb    $1f  E6C0 8E                      fcb    A<<4|E                               endm  E6C1 6F   47                 clr    wzerr,u   init result  E6C3 39                      rts                                          *                     * skctcp, check if in TCP mode                     * return zero if in TCP mode, non-zero if not                     * U = wzsock                     *  E6C4 34   06       skctcp    pshs   d  E6C6 EC   C8 26              ldd    wztype,u  SOCK_STREAM  E6C9 C1   01                 cmpb   #SK_STRM  is TCP  E6CB 35   86                 puls   d,pc                                          *                     * skcudp, check if in UDP mode                     * return zero if in UDP mode, non-zero if not                     * U = wzsock                     *  E6CD 34   06       skcudp    pshs   d  E6CF EC   C8 26              ldd    wztype,u  SOCK_DGRAM  E6D2 C1   02                 cmpb   #SK_DGRM  is UDP  E6D4 35   86                 puls   d,pc                                          *                     * skraw, check if in RAW mode                     * return zero if in RAW mode, non-zero if not                     * U = wzsock                     *  E6D6 34   06       skcraw    pshs   d  E6D8 EC   C8 26              ldd    wztype,u  SOCK_DGRAM  E6DB C1   03                 cmpb   #SK_MRAW  is RAW socket  E6DD 27   02                 beq    01f  E6DF C1   04                 cmpb   #SK_IRAW  E6E1 35   86       01        puls   d,pc                                          ****************************************************************                     *                     * here the socket is opened                     * X hold the TASK table                     * U holds the sock address                     *               E6E3  skopen    equ    * >E6E3 BD   E6BD               jsr    skfres                     *                     * check if DEVICE is active                     * >E6E6 BD   E6B1               jsr    wzdevt  E6E9 27   06                 beq    11f  E6EB BD   E79E               jsr    skclin    NO, close internal and don't startFIO Simulation Structure             19:34:30  Apr 22, 2024   Page   58wz socket interface routines                         >E6EE 16   0064     04        lbra   skoper1                     *                     * retry, we do all things                     *  E6F1 A6   42       11        lda    wzfsta,u  check if allocated by OS  E6F3 2A   F9                 bpl    04b       no, do nothing                     *                     * check socket() call arguments                     *  E6F5 6F   43                 clr    wzflg,u   erase flags  E6F7 6F   41                 clr    wzdctr,u  init counter  E6F9 EC   C8 24              ldd    wzfaml,u  E6FC C1   02                 cmpb   #AF_INET  E6FE 26   EE                 bne    04b       not supported                     * wztype holds socket type AND socket flags (hibyte)  E700 EC   C8 26              ldd    wztype,u  E703 C1   01                 cmpb   #SK_STRM  SOCK_STREAM  E705 27   26                 beq    01f  E707 C1   02                 cmpb   #SK_DGRM  SOCK_DGRAM  E709 27   1E                 beq    21f  E70B C1   03                 cmpb   #SK_MRAW  SOCK_RAW  E70D 27   16                 beq    41f  E70F C1   04                 cmpb   #SK_IRAW  IP_RAW  E711 26   46                 bne    skoper2                     *                     * raw socket, set protocol register first (only socket 0!!)                     * UDP and TCP are handled in a different way                     *  E713 EC   C8 28              ldd    wzprot,u  what is the protocol option?  E716 C1   06                 cmpb   #SP_TCP   not allowed  E718 27   3F                 beq    skoper2  E71A C1   11                 cmpb   #SP_UDP   not allowed  E71C 27   3B                 beq    skoper2  E71E BD   F128               jsr    PSRPROT   set protocol register                     *  E721 C6   03                 ldb    #%00000011 IPRAW  E723 20   0A                 bra    07f                     * nacraw  E725 C6   04       41        ldb    #%00000100 MACRAW  E727 20   06                 bra    07f                     * dgram  E729 C6   02       21        ldb    #%00000010 UDP  E72B 20   02                 bra    07f                     * TCP socket  E72D C6   01       01        ldb    #%00000001 TCP set source port in connect                     *                     * set socket mode register                     *  E72F BD   EFF2     07        jsr    PSRMR     set socket mode register                     *                     * here do the real OPEN,                     *FIO Simulation Structure             19:34:30  Apr 22, 2024   Page   59wz socket interface routines                          E732 C6   01                 ldb    #WCOPEN   open the device  E734 E7   44                 stb    wzcmnd,u  copy command  E736 BD   F010               jsr    PSRCR  E739 108E 0000               ldy    #0        nopoll                     *                     * interrupts not expected                     *               E73D  skowfo    equ    *  E73D BD   F044     21        jsr    GSRSR     get status  E740 E7   45                 stb    wzstat,u  E742 C1   00                 cmpb   #WSCLSD   not closed?  E744 26   0B                 bne    22f                     *  E746 6A   41                 dec    wzdctr,u  delay counter  E748 27   0F                 beq    skoper2  E74A 108E E73D               ldy    #skowfo  E74E 7E   E83D               jmp    polext    switch tasks                     *  E751 4F            22        clra  E752 C6   01                 ldb    #R_OPEN   response  E754 39            99        rts                     *  E755 86   01       skoper1   lda    #1        device not initialized  E757 20   02                 bra    12f  E759 86   02       skoper2   lda    #2        type error  E75B C6   C0       12        ldb    #E_SOCKET  E75D 20   F5                 bra    99b                                          *                     * convert number in bit position                     * B = enum, B=bit                     *  E75F 34   10       num2bt    pshs   x  E761 8E   E77A               ldx    #bittab  E764 3A                      abx  E765 E6   84                 ldb    0,x  E767 35   90                 puls   x,pc                                          *                     * bit to nummer, offset byt one, entry should NOT be 0                     *  E769 34   10       bt2num    pshs   x  E76B 8E   E77A               ldx    #bittab  E76E 6F   E2                 clr    0,-s  E770 E1   80       02        cmpb   0,x+  E772 27   04                 beq    01f  E774 6C   E4                 inc    0,s  E776 20   F8                 bra    02b  E778 35   94       01        puls   b,x,pc                                          * table  E77A 00            bittab    fcb    0FIO Simulation Structure             19:34:30  Apr 22, 2024   Page   60wz socket interface routines                          E77B 01 02 04 08             fcb    %00000001,%00000010,%00000100,%00001000  E77F 10 20 40 80             fcb    %00010000,%00100000,%01000000,%10000000                                          ***************************************************************                     *                     * close the socket                     * X hold the task table                     * U holds the sock address                     *               E783  skclos    equ    *  E783 BD   E6BD               jsr    skfres  E786 C6   08                 ldb    #WCDISC  E788 E7   44                 stb    wzcmnd,u  E78A BD   F010               jsr    PSRCR     send disconnect                     *  E78D 8D   0F                 bsr    skclin  E78F                         clrd  E78F 104F                    fdb    $104f                               endm  E791 ED   C8 24              std    wzfaml,u  E794 ED   C8 26              std    wztype,u  E797 ED   C8 28              std    wzprot,u                     *  E79A 4F                      clra  E79B C6   02                 ldb    #R_CLOSE  response  E79D 39                      rts                                          *                     * wzclin, close interal                     *  E79E 34   06       skclin    pshs   d  E7A0 C6   10                 ldb    #WCCLOS   do close  E7A2 E7   44                 stb    wzcmnd,u  E7A4 BD   F010               jsr    PSRCR                     *                     * erase registers in device                     *  E7A7 CC   0000               ldd    #0  E7AA BD   F062               jsr    PSRPORT   source port                     *  E7AD A6   42                 lda    wzfsta,u  E7AF 84   F9                 anda   #!(WZSKIO+WZSKIS) reset io mode and is sending  E7B1 A7   42                 sta    wzfsta,u  E7B3 CC   0000               ldd    #0  E7B6 ED   48                 std    wzxfer,u  clear remaining size                     *  E7B8 BD   F044     91        jsr    GSRSR  E7BB E7   45                 stb    wzstat,u  stat = 0 (closed)                     *  E7BD CC   0000               ldd    #0  E7C0 ED   C8 10              std    wzsprt,u  erase old info  E7C3 ED   C8 14              std    wzipad,uFIO Simulation Structure             19:34:31  Apr 22, 2024   Page   61wz socket interface routines                          E7C6 ED   C8 16              std    wzipad+2,u  E7C9 ED   C8 12              std    wzdprt,u  E7CC E7   43                 stb    wzflg,u   clear flags                     *  E7CE 35   86                 puls   d,pc                                          ***************************************************************                     *                     * connect socket                     * X hold the task table                     * U holds the sock address                     * connect() call fills in info in the sock structure                     *               E7D0  skconn    equ    *  E7D0 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E7D3 BD   E6B1               jsr    wzdevt  E7D6 27   06                 beq    01f >E7D8 BD   E783               jsr    skclos    NO, don't start >E7DB 16   007A     02        lbra   skcner4  E7DE BD   E6C4     01        jsr    skctcp    not in tcp, illegal  E7E1 26   F8                 bne    02b                     *                     * check if socket has been set up                     *  E7E3 BD   F044     11        jsr    GSRSR     status  E7E6 E7   45                 stb    wzstat,u  check if properly setup  E7E8 C1   13                 cmpb   #WSINIT   SHOULD BE >E7EA 1026 005F               lbne   skcner6                     *                     * check the info from the connect call                     *  E7EE EC   C8 14              ldd    wzipad,u  check if dest IP == null  E7F1                         ordx   wzipad+2,IU  E7F1 10AA                    fdb    $10aa  E7F3                         doindx wzipad+2,IU  E7F3 C8 16                   fcb    $88+(IU<<5),(wzipad+2&$7f)                               endm                               endm  E7F5 27   65                 beq    skcner1   IP address == NULL                     * IP address = 0000  E7F7 EC   C8 14              ldd    wzipad,u  or FFFFFFFF  E7FA                         incd  E7FA 104C                    fdb    $104c                               endm  E7FC 26   07                 bne    01f  E7FE EC   C8 16              ldd    wzipad+2,u  E801                         incd  E801 104C                    fdb    $104c                               endmFIO Simulation Structure             19:34:31  Apr 22, 2024   Page   62wz socket interface routines                          E803 27   57                 beq    skcner1   IP address = FFFFFFFF                     *                     * valid IP                     *  E805 EC   C8 12    01        ldd    wzdprt,u  check destination port  E808 27   4A                 beq    skcner5   is not set, error                     *  E80A BD   F0EC               jsr    PSRDPOR   set destination port  E80D 31   C8 14              leay   wzipad,u  load socket  E810 BD   F0C6               jsr    PSRDIP    set destination IP                     *                     * source port, create one, always unique                     *  E813 BD   E69F               jsr    sknewp    get new  E816 ED   C8 10              std    wzsprt,u  tell us what you took  E819 BD   F062               jsr    PSRPORT   source port                     *                     * do the CONNECT here                     *  E81C C6   04                 ldb    #WCCONN  E81E E7   44                 stb    wzcmnd,u  E820 BD   F010               jsr    PSRCR     do connect                     *                     *                     *  E823 BD   E6BD     conlb1    jsr    skfres  E826 BD   F044               jsr    GSRSR     update status  E829 E7   45                 stb    wzstat,u  E82B C1   17                 cmpb   #WSESTB  E82D 27   0A                 beq    90f  E82F C1   00                 cmpb   #WSCLSD  E831 27   16                 beq    skcner2  E833 108E E823               ldy    #conlb1  E837 20   04                 bra    polext                     *  E839 4F            90        clra  E83A C6   08                 ldb    #R_CONNECT  E83C 39            99        rts                                          *                     * polexit, Y=where to return                     *  E83D 10AF 0F       polext    sty    tsagin,x  here to restart  E840 C6   BA                 ldb    #POLPRI  E842 E7   05                 stb    tsprir,x  E844 108E FFFF               ldy    #$ffFF  E848 39                      rts                       E849 C6   0C       skcner2   ldb    #R_DISCON  E84B 20   EF                 bra    99b                       E84D BD   E79E     skcner6   jsr    skclin    reset openFIO Simulation Structure             19:34:31  Apr 22, 2024   Page   63wz socket interface routines                          E850 86   0F                 lda    #15       not properly setup  E852 20   0E                 bra    09f  E854 86   0E       skcner5   lda    #14       destination port not set  E856 20   0A                 bra    09f  E858 86   0A       skcner4   lda    #10       device not initialized  E85A 20   06                 bra    09f  E85C 86   0B       skcner1   lda    #11       IP address invalid  E85E 20   02                 bra    09f  E860 86   0D       skcner3   lda    #13  E862 C6   C0       09        ldb    #E_SOCKET  E864 20   D6                 bra    99b                                          ***************************************************************                     *                     * bind request                     * X hold the task table                     * U holds the sock address                     * bindt() call fills in info in the sock structure                     *               E866  skbind    equ    *  E866 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E869 BD   E6B1               jsr    wzdevt  E86C 1026 00EC               lbne   rdrqer1  E870 BD   E6C4               jsr    skctcp    check TCP  E873 27   12                 beq    01f  E875 BD   E6CD               jsr    skcudp    check UDP >E878 1026 FFD1               lbne   skcner6                     *                     * go on , the bind() call sets wzipad and wzsprt, this is for                     * a server, for a client it needs to set wzdprt                     * for as server IP is local, for a client IP is remote                     *                     *  E87C BD   F044               jsr    GSRSR     status  E87F E7   45                 stb    wzstat,u  E881 C1   22                 cmpb   #WSUDP    check  E883 27   0D                 beq    03f  E885 20   07                 bra    04f                       E887 BD   F044     01        jsr    GSRSR     status  E88A E7   45                 stb    wzstat,u  E88C C1   13                 cmpb   #WSINIT   should be >E88E 1026 FFBB     04        lbne   skcner6                     *                     * set the network connection data                     *  E892 BD   E69F     03        jsr    sknewp  E895 ED   C8 12              std    wzdprt,u  E898 BD   F0EC               jsr    PSRDPOR   destination portFIO Simulation Structure             19:34:32  Apr 22, 2024   Page   64wz socket interface routines                          E89B EC   C8 10              ldd    wzsprt,u  E89E BD   F062               jsr    PSRPORT   source port                     *  E8A1 31   C8 14              leay   wzipad,u  E8A4 BD   F0C6               jsr    PSRDIP    source IP                     *  E8A7 4F                      clra  E8A8 C6   09                 ldb    #R_BIND  E8AA 39                      rts                     *                                          ***************************************************************                     *                     * listen request                     * X hold the task table                     * U holds the sock address                     * listen() call waits for peer to connect                     *               E8AB  sklist    equ    *  E8AB BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E8AE BD   E6B1               jsr    wzdevt  E8B1 1026 00A7     02        lbne   rdrqer1  E8B5 BD   E6C4               jsr    skctcp  E8B8 26   F7                 bne    02b                     *                     * go on                     *                     *  E8BA BD   F044               jsr    GSRSR     status  E8BD E7   45                 stb    wzstat,u                     *  E8BF C1   00                 cmpb   #WSCLSD   closed?  E8C1 27   0F                 beq    80f  E8C3 C1   13                 cmpb   #WSINIT   opened  E8C5 26   0F                 bne    90f                     *  E8C7 C6   02                 ldb    #WCLIST  E8C9 E7   44                 stb    wzcmnd,u  E8CB BD   F010               jsr    PSRCR                     *  E8CE 4F                      clra  E8CF C6   0A                 ldb    #R_LISTEN  E8D1 39                      rts                                          *  E8D2 4F            80        clra  E8D3 C6   02                 ldb    #R_CLOSE  E8D5 39                      rts                     *FIO Simulation Structure             19:34:32  Apr 22, 2024   Page   65wz socket interface routines                          E8D6 108E E8AB     90        ldy    #sklist  E8DA 7E   E83D               jmp    polext                                          ***************************************************************                     *                     * accept request                     * X hold the task table                     * U holds the sock address                     * listen() call waits for peer to connect                     *               E8DD  skacpt    equ    *  E8DD BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E8E0 BD   E6B1               jsr    wzdevt >E8E3 1026 0075     02        lbne   rdrqer1  E8E7 BD   E6C4               jsr    skctcp  E8EA 26   F7                 bne    02b       wrong mode                     *                     * go on                     *  E8EC BD   F044               jsr    GSRSR     status  E8EF E7   45                 stb    wzstat,u  E8F1 C1   17                 cmpb   #WSESTB   connected  E8F3 26   10                 bne    01f  E8F5 BD   F0DD               jsr    GSRDPOR   fill in peer port  E8F8 ED   C8 12              std    wzdprt,u  E8FB 31   C8 14              leay   wzipad,u  E8FE BD   F0AF               jsr    GSRDIP                     *  E901 4F                      clra  E902 C6   0B                 ldb    #R_ACCEPT  E904 39                      rts                     *  E905 C1   00       01        cmpb   #WSCLSD  E907 26   04                 bne    02f  E909 4F                      clra  E90A C6   02                 ldb    #R_CLOSE  E90C 39                      rts                     *  E90D 108E E8DD     02        ldy    #skacpt  E911 7E   E83D               jmp    polext                                                               ***************************************************************                     *                     * read request  TCP only !!                     * X hold the task table                     * U holds the sock address                     * connect() call fills in info in the sock structure                     *FIO Simulation Structure             19:34:32  Apr 22, 2024   Page   66wz socket interface routines                                       E914  skreqrd   equ    *  E914 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E917 BD   E6B1               jsr    wzdevt >E91A 1026 003E     02        lbne   rdrqer1  E91E BD   E6C4               jsr    skctcp    check TCP  E921 26   F7                 bne    02b                     *                     * go on                     *                     *  E923 BD   F044               jsr    GSRSR  E926 E7   45                 stb    wzstat,u  update status  E928 C1   00                 cmpb   #WSCLSD  E92A 27   27                 beq    60f  E92C BD   F1FB               jsr    GSRRXRS   data available?  E92F ED   48                 std    wzxfer,u  E931 26   1C                 bne    70f                     *  E933 A6   C8 26              lda    wztype,u  check flags  E936 85   01                 bita   #WFNBLK   non block  E938 26   11                 bne    75f                     *  E93A E6   45                 ldb    wzstat,u  E93C C1   1C                 cmpb   #WSCLWT  E93E 27   13                 beq    60f  E940 C1   17       17        cmpb   #WSESTB   still active  E942 27   00                 beq    20f                                          *  E944 108E E914     20        ldy    #skreqrd  E948 7E   E83D               jmp    polext                                          *************************  E94B 4F            75        clra  E94C C6   15                 ldb    #R_RQRDNB tell no data  E94E 39                      rts                                          * data present  E94F 4F            70        clra  E950 C6   05                 ldb    #R_RQRD  E952 39                      rts                                          * close socket and return  E953 C6   06       60        ldb    #PIPES  E955 BD   E449               jsr    send_SI   send to main CPU  E958 4F                      clra  E959 C6   02                 ldb    #R_CLOSE  E95B 39                      rts                     FIO Simulation Structure             19:34:33  Apr 22, 2024   Page   67wz socket interface routines                                               E95C 86   82       rdrqer1   lda    #130  E95E C6   C0                 ldb    #E_SOCKET  E960 39                      rts                                          ***************************************************************                     *                     * get the data  U=wzsock, X=task struct                     *               E961  skrecv    equ    *  E961 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E964 BD   E6B1               jsr    wzdevt >E967 1026 FFF1               lbne   rdrqer1  E96B BD   E6C4     02        jsr    skctcp  E96E 26   FB                 bne    02b                     *                     * we got info that data is present, get it                     * if here the main CPU already locked the fifo for us                     * on return D= xfreed count                     *  E970 BD   F1FB               jsr    GSRRXRS   received size                     * D total aviable data  E973 108E 0020               ldy    #fifo     target  E977 BD   F2CB               jsr    RDSK2FB   transfer datat to fifo  E97A ED   48                 std    wzxfer,u  save it                     *                     * here check if PROT_XLTEOF is set                     *  E97C 6D   C8 28              tst    wzprot,u  PROT_XLTEOL is $8000  E97F 2A   18                 bpl    01f                     *  E981 34   36                 pshs   d,x,y  E983 1F   01                 tfr    d,x       count  E985 108E 0020               ldy    #fifo  E989 A6   A4       03        lda    0,y  E98B 81   0A                 cmpa   #LF       is line feed  E98D 26   02                 bne    02f  E98F 86   0D                 lda    #CR       make it Return  E991 A7   A0       02        sta    0,y+  E993 30   1F                 leax   -1,x      count  E995 26   F2                 bne    03b  E997 35   36                 puls   d,x,y                     *  E999 C6   40       01        ldb    #WCRECV  E99B E7   44                 stb    wzcmnd,u  E99D BD   F010               jsr    PSRCR     tell sender we took it                       E9A0 C6   06                 ldb    #R_READ   tell data in fifo  E9A2 4F                      clraFIO Simulation Structure             19:34:33  Apr 22, 2024   Page   68wz socket interface routines                          E9A3 39                      rts                                          ***************************************************************                     *                     * write request                     * X hold the task table                     * U holds the sock address                     * connect() call fills in info in the sock structure                     *               E9A4  skreqwr   equ    *  E9A4 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E9A7 BD   E6B1               jsr    wzdevt >E9AA 1026 FFAE     02        lbne   rdrqer1  E9AE BD   E6C4               jsr    skctcp  E9B1 26   F7                 bne    02b                     *                     * go on                     *                     *  E9B3 BD   F044               jsr    GSRSR  E9B6 E7   45                 stb    wzstat,u  update status  E9B8 C1   00                 cmpb   #WSCLSD  E9BA 27   12                 beq    30f  E9BC BD   F1AF               jsr    GSRTXFR   free size (remaining)  E9BF 10A3 4A                 cmpd   wzrqln,u  would it fit  E9C2 24   11                 bhs    70f                     *  E9C4 E6   45       10        ldb    wzstat,u  E9C6 C1   1C                 cmpb   #WSCLWT  E9C8 27   04                 beq    30f  E9CA C1   17                 cmpb   #WSESTB  E9CC 27   16                 beq    20f                     * connection broken?  E9CE CC   0000     30        ldd    #0  E9D1 ED   48                 std    wzxfer,u  E9D3 20   06                 bra    60f                     * data space  E9D5 4F            70        clra  E9D6 C6   03                 ldb    #R_RQWR  E9D8 39                      rts                                          * data space exhausted, would block  E9D9 4F            72        clra                     **        ldb     #R_RQWRWB  E9DA 39                      rts                                          * close socket and return  E9DB C6   06       60        ldb    #PIPES  E9DD BD   E449               jsr    send_SI   send to main CPUFIO Simulation Structure             19:34:33  Apr 22, 2024   Page   69wz socket interface routines                          E9E0 4F                      clra  E9E1 C6   02                 ldb    #R_CLOSE  E9E3 39                      rts                                          *  E9E4 108E E9A4     20        ldy    #skreqwr  E9E8 7E   E83D               jmp    polext                                          ***************************************************************                     *                     * write request                     * X hold the task table                     * U holds the sock address                     * connect() call fills in info in the sock structure                     *               E9EB  sksend    equ    *  E9EB BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  E9EE BD   E6B1               jsr    wzdevt  E9F1 1026 FF67     02        lbne   rdrqer1  E9F5 BD   E6C4               jsr    skctcp  E9F8 26   F7                 bne    02b                     *                     * we got info that data is present, get it                     * if here the main CPU already locked the fifo for us                     * on return D= xfreed count                     *  E9FA BD   F1AF               jsr    GSRTXFR   free size (remaining)                     * D = total available space  E9FD 6D   C8 28              tst    wzprot,u  check if PROT_XLTEOL is set  EA00 2A   18                 bpl    01f                     *  EA02 34   36                 pshs   d,x,y  EA04 1F   01                 tfr    d,x       count  EA06 108E 0020               ldy    #fifo  EA0A A6   A4       03        lda    0,y  EA0C 81   0D                 cmpa   #CR       Return?  EA0E 26   02                 bne    02f  EA10 86   0A                 lda    #LF       make it Line feed  EA12 A7   A0       02        sta    0,y+  EA14 30   1F                 leax   -1,x      count  EA16 26   F2                 bne    03b  EA18 35   36                 puls   d,x,y                     *  EA1A 108E 0020     01        ldy    #fifo     target  EA1E BD   F319               jsr    WRFB2SK   transfer from fifo to socket  EA21 ED   48                 std    wzxfer,u  save it  EA23 C6   20                 ldb    #WCSEND  EA25 E7   44                 stb    wzcmnd,u  EA27 BD   F010               jsr    PSRCR     tell sender it is comingFIO Simulation Structure             19:34:34  Apr 22, 2024   Page   70wz socket interface routines                                               EA2A C6   04                 ldb    #R_WRITE  tell data in fifo  EA2C 4F                      clra  EA2D 39                      rts                                          ***************************************************************                     * skurrdf, request readfrom                     *                     *                     * X hold the task table                     * U holds the sock address                     *               EA2E  skurrdf   equ    *  EA2E BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EA31 BD   E6B1               jsr    wzdevt  EA34 1026 FF24     02        lbne   rdrqer1  EA38 BD   E6CD               jsr    skcudp  EA3B 27   05                 beq    03f  EA3D BD   E6D6               jsr    skcraw  EA40 26   F2                 bne    02b  EA42               03                     *                     * go on                     *                     *  EA42 EC   C8 20              ldd    wzurms,u  check remaining size  EA45 26   4B                 bne    84f                     *                     * no  packet data present, wait for it                     *  EA47 BD   F044               jsr    GSRSR  EA4A E7   45                 stb    wzstat,u  update status  EA4C C1   00                 cmpb   #WSCLSD  EA4E 27   46                 beq    60f  EA50 BD   F1FB               jsr    GSRRXRS   data available?  EA53 ED   7E                 std    -2,s      test D  EA55 26   19                 bne    22f       keep waiting                     * no data yet, check socket state  EA57 E6   45                 ldb    wzstat,u  EA59 C1   1C                 cmpb   #WSCLWT  EA5B 27   39                 beq    60f  EA5D C1   22                 cmpb   #WSUDP    still active  EA5F 27   08                 beq    20f  EA61 C1   32                 cmpb   #WSIRAW  EA63 27   04                 beq    20f  EA65 C1   42                 cmpb   #WSMRAW  EA67 27   00                 beq    20f                     *  EA69 108E EA2E     20        ldy    #skurrdfFIO Simulation Structure             19:34:34  Apr 22, 2024   Page   71wz socket interface routines                          EA6D 7E   E83D               jmp    polext                     *                     * first data present, set wzuipa, wzuprt, wzurms                     *  EA70 31   C8 1A    22        leay   wzuipa,u  EA73 CC   0008               ldd    #8        size of header  EA76 BD   ED6F               jsr    bmread    copy data                     *                     * move pointer                     *  EA79 BD   F212               jsr    GSRRXRP  EA7C C3   0008               addd   #8  EA7F BD   F221               jsr    PSRRXRP   update pointer  EA82 C6   40                 ldb    #WCRECV  EA84 E7   44                 stb    wzcmnd,u  process move  EA86 BD   F010               jsr    PSRCR                     *  EA89 EC   C8 20              ldd    wzurms,u  EA8C 1083 05C0               cmpd   #MAX_UDP  max size  EA90 22   0D                 bhi    78f                     *  EA92 4F            84        clra  EA93 C6   21                 ldb    #R_RDFRM  EA95 39                      rts                                          * close socket and return  EA96 C6   06       60        ldb    #PIPES  EA98 BD   E449               jsr    send_SI   send to main CPU  EA9B 4F                      clra  EA9C C6   02                 ldb    #R_CLOSE  EA9E 39                      rts                                          *  EA9F BD   E79E     78        jsr    skclin    close  EAA2 C6   C0                 ldb    #E_SOCKET  EAA4 39                      rts                                          ***************************************************************                     * skurrd,  data readfrom                     *                     *                     * X hold the task table                     * U holds the sock address                     *               EAA5  skurrd    equ    *  EAA5 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EAA8 BD   E6B1               jsr    wzdevt  EAAB 1026 FEAD     02        lbne   rdrqer1  EAAF BD   E6CD               jsr    skcudpFIO Simulation Structure             19:34:34  Apr 22, 2024   Page   72wz socket interface routines                          EAB2 26   F7                 bne    02b                     *                     * go on                     *                     *                     * transfer at most fio_fsz bytes  EAB4 EC   C8 20              ldd    wzurms,u  this is leading count                     * D = total available data  EAB7 108E 0020               ldy    #fifo     target  EABB BD   F2CB               jsr    RDSK2FB   transfer data  EABE 34   06                 pshs   d         xferred count  EAC0 EC   C8 20              ldd    wzurms,u  update  EAC3 A3   E1                 subd   0,s++  EAC5 ED   C8 20              std    wzurms,u  new remaining                     *  EAC8 C6   40       01        ldb    #WCRECV  EACA E7   44                 stb    wzcmnd,u  set processed  EACC BD   F010               jsr    PSRCR                     *  EACF 4F                      clra  EAD0 C6   22                 ldb    #R_RRDFD  EAD2 39                      rts                                          ***************************************************************                     * skurwt,  request sendto                     *                     *                     * X hold the task table                     * U holds the sock address                     *               EAD3  skurwt    equ    *  EAD3 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EAD6 BD   E6B1               jsr    wzdevt  EAD9 1026 FE7F     02        lbne   rdrqer1  EADD BD   E6CD               jsr    skcudp  EAE0 27   05                 beq    03f  EAE2 BD   E6D6               jsr    skcraw  EAE5 26   F2                 bne    02b  EAE7               03                     *                     * go on                     *                     *  EAE7 EC   C8 12              ldd    wzdprt,u  check illegal port  EAEA 1027 0084               lbeq   78f                     *  EAEE EC   C8 14              ldd    wzipad,u  EAF1                         ordx   wzipad+2,IU  EAF1 10AA                    fdb    $10aaFIO Simulation Structure             19:34:35  Apr 22, 2024   Page   73wz socket interface routines                          EAF3                         doindx wzipad+2,IU  EAF3 C8 16                   fcb    $88+(IU<<5),(wzipad+2&$7f)                               endm                               endm >EAF5 1027 0079               lbeq   78f                     * set network registers  EAF9 EC   C8 12              ldd    wzdprt,u  EAFC BD   F0EC               jsr    PSRDPOR                       EAFF 31   C8 14              leay   wzipad,u  EB02 BD   F0C6               jsr    PSRDIP  EB05 EC   C8 10              ldd    wzsprt,u  EB08 26   11                 bne    04f                     *  EB0A EC   C8 10              ldd    wzsprt,u  already set?  EB0D 26   09                 bne    16f  EB0F BD   E69F               jsr    sknewp    get new source port  EB12 ED   C8 10              std    wzsprt,u  EB15 ED   C8 1E              std    wzuprt,u  set also return port  EB18 BD   F062     16        jsr    PSRPORT                     *  EB1B 108E EB22     04        ldy    #skuwr2   do remainder  EB1F 7E   E83D               jmp    polext                                          *                     * after intial setup. loop here                     *               EB22  skusnm    equ    *  EB22 BD   E6BD     skuwr2    jsr    skfres    set socket base  EB25 BD   E6B1               jsr    wzdevt    devie active >EB28 1026 FFAD               lbne   02b       no  EB2C BD   E6CD               jsr    skcudp    check open method  EB2F 26   A8                 bne    02b                     *  EB31 BD   F044               jsr    GSRSR  EB34 E7   45                 stb    wzstat,u  update status  EB36 C1   00                 cmpb   #WSCLSD   closed  EB38 27   2F                 beq    60f  EB3A BD   F1AF               jsr    GSRTXFR   free size  EB3D 10A3 C8 20              cmpd   wzurms,u  EB41 24   19                 bhs    10f                     * no space yet  EB43 E6   45                 ldb    wzstat,u  EB45 C1   1C                 cmpb   #WSCLWT   is closing  EB47 27   20                 beq    60f  EB49 C1   22                 cmpb   #WSUDP  EB4B 27   08                 beq    20f  EB4D C1   32                 cmpb   #WSIRAW   IPRAW  EB4F 27   04                 beq    20f  EB51 C1   42                 cmpb   #WSMRAW   MACRAW  EB53 27   00                 beq    20f                     *FIO Simulation Structure             19:34:35  Apr 22, 2024   Page   74wz socket interface routines                          EB55 108E EAD3     20        ldy    #skurwt  EB59 7E   E83D               jmp    polext    keep polling                     *  EB5C EC   C8 20    10        ldd    wzurms,u  EB5F 1083 05C0               cmpd   #MAX_UDP  too big  EB63 22   0D                 bhi    78f                     *  EB65 4F                      clra  EB66 C6   23                 ldb    #R_RSNDTO  EB68 39                      rts                       EB69 C6   06       60        ldb    #PIPES  EB6B BD   E449               jsr    send_SI   send to main CPU  EB6E 4F                      clra  EB6F C6   02                 ldb    #R_CLOSE  EB71 39                      rts                       EB72 BD   E79E     78        jsr    skclin    close  EB75 C6   C0                 ldb    #E_SOCKET  EB77 39                      rts                                                               ***************************************************************                     * skusnt,  data sendto                     *                     *                     * X hold the task table                     * U holds the sock address                     *               EB78  skusnt    equ    *  EB78 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EB7B BD   E6B1               jsr    wzdevt  EB7E 1026 FDDA     02        lbne   rdrqer1  EB82 BD   E6CD               jsr    skcudp  EB85 26   F7                 bne    02b                     *                     * go on                     *                     * transfer fifo to socket data register  EB87 EC   C8 20              ldd    wzurms,u  total data                     *  EB8A 108E 0020               ldy    #fifo     target  EB8E BD   F319               jsr    WRFB2SK   fifo to socket  EB91 34   06                 pshs   d  EB93 EC   C8 20              ldd    wzurms,u  all loaded  EB96 A3   E1                 subd   0,s++  EB98 ED   C8 20              std    wzurms,u  EB9B 26   11                 bne    01f                     FIO Simulation Structure             19:34:35  Apr 22, 2024   Page   75wz socket interface routines                          EB9D EC   C8 22              ldd    wzuwrp,u  is it used  EBA0 BD   F1EC               jsr    PSRTXWP   set write pointer                       EBA3 C6   20                 ldb    #WCSEND  EBA5 E7   44                 stb    wzcmnd,u  EBA7 BD   F010               jsr    PSRCR  EBAA 4F                      clra  EBAB C6   24                 ldb    #R_WSNDTO data taken  EBAD 39                      rts                       EBAE 4F            01        clra  EBAF C6   25                 ldb    #R_SNDTOM ask for more  EBB1 39                      rts                                          ***************************************************************                     *                     * netblock, read block                     * the method is special, we need to send a request                     * over the net first (send) before new data can be returned                     * X=task struct, U=wzsock                     *                     ***************************************************************               EBB2  sknbrr    equ    *  EBB2 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EBB5 BD   E6B1               jsr    wzdevt  EBB8 1026 FDA0     02        lbne   rdrqer1  EBBC BD   E6C4               jsr    skctcp  EBBF 26   F7                 bne    02b                     *  EBC1 BD   F044               jsr    GSRSR     get status  EBC4 E7   45                 stb    wzstat,u  update sock  EBC6 C1   17                 cmpb   #WSESTB   established  EBC8 26   3C                 bne    sknbe1    error                     *  EBCA BD   F1AF               jsr    GSRTXFR   get free space  EBCD 1083 0004               cmpd   #NBRQLN  EBD1 25   2A                 blo    sknbrp1   go poll  EBD3 CC   0004               ldd    #NBRQLN                     *  EBD6 108E 001C               ldy    #fifo_us2 where request is present  EBDA BD   F319               jsr    WRFB2SK  EBDD C6   20                 ldb    #WCSEND   tell socket we put it  EBDF E7   44                 stb    wzcmnd,u  EBE1 BD   F010               jsr    PSRCR                     * request is out, wait for data  EBE4 BD   F044     sknbrp2   jsr    GSRSR  EBE7 E7   45                 stb    wzstat,u  EBE9 C1   17                 cmpb   #WSESTB  EBEB 26   19                 bne    sknbe1FIO Simulation Structure             19:34:36  Apr 22, 2024   Page   76wz socket interface routines                          EBED BD   F1FB               jsr    GSRRXRS   check response  EBF0 1083 0204               cmpd   #NBSIZE   data available  EBF4 27   0D                 beq    01f  EBF6 108E EBE4               ldy    #sknbrp2  wait until  EBFA 7E   E83D     02        jmp    polext  EBFD 108E EBB2     sknbrp1   ldy    #sknbrr  EC01 20   F7                 bra    02b                     *  EC03 C6   32       01        ldb    #R_RQRBLK tell caller  EC05 39                      rts                       EC06 C6   C0       sknbe1    ldb    #E_SOCKET  EC08 39                      rts                                                                              EC09  sknbrd    equ    *  EC09 BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EC0C BD   E6B1               jsr    wzdevt  EC0F 1026 FD49     02        lbne   rdrqer1  EC13 BD   E6C4               jsr    skctcp  EC16 26   F7                 bne    02b                     * when we arrive here, the caller has allocated the fifo  EC18 CC   0204               ldd    #NBSIZE  EC1B 108E 001C               ldy    #fifo_us2  EC1F BD   F2CB               jsr    RDSK2FB  EC22 C6   40                 ldb    #WCRECV   tell socket we took it  EC24 E7   44                 stb    wzcmnd,u  EC26 BD   F010               jsr    PSRCR                     *  EC29 C6   33                 ldb    #R_RDRBLK tell caller, data in fifo_us2 and fifo  EC2B 39                      rts                                                               ***************************************************************                     *                     * netblock, write block                     *                     ***************************************************************               EC2C  sknbsr    equ    *  EC2C BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EC2F BD   E6B1               jsr    wzdevt  EC32 1026 FD26     02        lbne   rdrqer1  EC36 BD   E6C4               jsr    skctcp  EC39 26   F7                 bne    02b                     FIO Simulation Structure             19:34:36  Apr 22, 2024   Page   77wz socket interface routines                          EC3B 39                      rts                                                         EC3C  sknbsd    equ    *  EC3C BD   E6BD               jsr    skfres                     *                     * is the DEVICE (still) active                     *  EC3F BD   E6B1               jsr    wzdevt  EC42 1026 FD16     02        lbne   rdrqer1  EC46 BD   E6C4               jsr    skctcp  EC49 26   F7                 bne    02b                       EC4B 39                      rts                                          ***************************************************************                     *                     * special function, tstval,x is indicator                     * X hold the task table                     * U holds the SPECIAL sock address (NO wz....  access!)                     *               EC4C  skspcl    equ    *                     *  EC4C 34   10                 pshs   x  EC4E E6   0C                 ldb    tstval,x  get index  EC50 C1   03                 cmpb   #MAXTBL  EC52 22   18                 bhi    01f       illegal  EC54 58                      aslb  EC55 8E   EC73               ldx    #functb  EC58 10AE 85                 ldy    b,x       get special function  EC5B 27   0F                 beq    01f       not valid  EC5D 35   10                 puls   x                     *  EC5F AD   A4                 jsr    0,y       do function  EC61 26   05                 bne    90f                     *  EC63 4F                      clra  EC64 C6   0F                 ldb    #R_SPCL  EC66 20   0A                 bra    99f                     *  EC68 86   A2       90        lda    #162  EC6A 20   04                 bra    02f                     *  EC6C 35   10       01        puls   x  EC6E 86   A1                 lda    #161  EC70               02  EC70 C6   C0                 ldb    #E_SOCKET                     *  EC72 39            99        rts                       EC73 EC7B          functb    fdb    wzwdev    write device settings  EC75 EC7B                    fdb    wzwdevFIO Simulation Structure             19:34:36  Apr 22, 2024   Page   78wz socket interface routines                          EC77 ECA5                    fdb    wzrdev    read device settings  EC79 ECC1                    fdb    showrg               0003  MAXTBL    equ    ((*-functb)/2)-1                                          *                     * write W5500 basic device settings                     *                     * X hold the task table                     * U holds the special sock address                     *  EC7B               wzwdev  EC7B C6   08                 ldb    #8  EC7D                         trfr   B,E  EC7D 1F                      fcb    $1f  EC7E 9E                      fcb    B<<4|E                               endm  EC7F DE   1A                 ldu    fifo_us1  device info area  EC81 31   C4                 leay   0,u       myip  EC83 BD   EEA7               jsr    PCRSIP    source IP  EC86 31   44                 leay   4,u  EC88 BD   EE3B               jsr    PCRSNM    subnet mask  EC8B 31   48                 leay   8,u  EC8D BD   EE0D               jsr    PCRGA     gateway IP  EC90 31   4C                 leay   12,u  EC92 BD   EE71               jsr    PCRSHA    hardware address                     *  EC95 A6   C8 12              lda    18,u      ON/OFF  EC98 27   04                 beq    01f  EC9A C6   F8                 ldb    #%11111000 all on  EC9C 20   02                 bra    02f  EC9E C6   78       01        ldb    #%01111000 all off  ECA0 BD   EFC5     02        jsr    PCRPHY  ECA3 4F                      clra             no error return status  ECA4 39                      rts                                          *                     * read W5500 basic device settings                     *  ECA5               wzrdev  ECA5 C6   08                 ldb    #8  ECA7                         trfr   B,E       select first socket  ECA7 1F                      fcb    $1f  ECA8 9E                      fcb    B<<4|E                               endm  ECA9 DE   1A                 ldu    fifo_us1  ECAB 31   C4                 leay   0,u       overwrite what was set  ECAD BD   EE90               jsr    GCRSIP  ECB0 31   44                 leay   4,u  ECB2 BD   EE24               jsr    GCRSNM  ECB5 31   48                 leay   8,u  ECB7 BD   EDF6               jsr    GCRGA  ECBA 31   4C                 leay   12,uFIO Simulation Structure             19:34:37  Apr 22, 2024   Page   79wz socket interface routines                          ECBC BD   EE52               jsr    GCRSHA  ECBF 4F                      clra             no error return status  ECC0 39                      rts                                          *                     * debug service, read selected registers                     *  ECC1               showrg  ECC1 C6   08                 ldb    #8  ECC3                         trfr   B,E       select first socket  ECC3 1F                      fcb    $1f  ECC4 9E                      fcb    B<<4|E                               endm  ECC5 DE   1A                 ldu    fifo_us1  ECC7 33   C8 20              leau   32,u      skip network data area  ECCA BD   EFE3               jsr    GSRMR  ECCD E7   C0                 stb    0,u+  ECCF BD   F044               jsr    GSRSR  ECD2 E7   C0                 stb    0,u+  ECD4 BD   F173               jsr    GSRRBFS  ECD7 E7   C0                 stb    0,u+                       ECD9 C6   3D                 ldb    #'=  ECDB E7   C0                 stb    0,u+                       ECDD 31   C4                 leay   0,u  ECDF BD   EE90               jsr    GCRSIP  ECE2 33   44                 leau   4,u  ECE4 31   C4                 leay   0,u  ECE6 BD   EDF6               jsr    GCRGA  ECE9 33   44                 leau   4,u                       ECEB C6   23                 ldb    #'#  ECED E7   C0                 stb    0,u+                       ECEF 31   C4                 leay   0,u  ECF1 BD   EE52               jsr    GCRSHA  ECF4 33   46                 leau   6,u                       ECF6 C6   23                 ldb    #'#  ECF8 E7   C0                 stb    0,u+                       ECFA 31   C4                 leay   0,u  ECFC BD   EE24               jsr    GCRSNM  ECFF 33   44                 leau   4,u                       ED01 C6   3D                 ldb    #'=  ED03 E7   C0                 stb    0,u+                       ED05 BD   EFD4               jsr    GCRVERS  ED08 ED   C1                 std    0,u++                     FIO Simulation Structure             19:34:37  Apr 22, 2024   Page   80wz socket interface routines                          ED0A C6   23                 ldb    #'#  ED0C E7   C4                 stb    0,u  ED0E 4F                      clra                       ED0F 39                      rts                                                               * X hold the task table                     * U holds the sock address  ED10               skintrp  ED10               skdisc  ED10               sksmac  ED10               skskep  ED10 86   FF                 lda    #255  ED12 A7   47                 sta    wzerr,u  ED14 C6   C0                 ldb    #E_SOCKET  ED16 39                      rts                                    ED17  oldorg    set    *                     *                     * hardware register orgaization                     *               8080  SPIBASE   equ    $8080     hardware base address                       0000                         org    0                     *  0000               spicmd    rmb    1         HW control register               0000  spista    equ    spicmd    HW status register  0001               spicon    rmb    1         [W]   HW aux control register  0002                         rmb    2         dummy not used                     * shift register access  0004               hibyta    rmb    1         [R/W] hibyte auto 8 clock pulses for SR  0005               lobyta    rmb    1         [R/W] lobyte auto 8 clock pulses for SR  0006               hibyts    rmb    1         [R/W] hibyte static (no clock)  0007               lobyts    rmb    1         [R/W] lobyte static (no clock)                     *               0080  QFF1      equ    %10000000 [R]                          X               0040  SPI_CS_   equ    %01000000 [R/W] spi chip CS_           1               0020  SPI_RST   equ    %00100000 [R/W] spi chip RST_          1               0010  SPI_IEN   equ    %00010000 [R/W] spi chip INT enabled   0               0008  SPI_AUT   equ    %00001000 [R/W] auto advance           0               0004  SPI_SR_   equ    %00000100 [R/W] shift register MR_     1               0002  SPI_HLD   equ    %00000010 [R/W] HOLD                   0               0001  SPI_CR_   equ    %00000001 [W]   HC163 MR_              1               0001  SPI_IRQ   equ    %00000001 [R]   /IRQ bit               1                     *               0003  RSVREG    equ    %00000011 reserved register address                       ED17                         org    oldorg                                          *                     * spinit, init the SPI hardwareFIO Simulation Structure             19:34:37  Apr 22, 2024   Page   81wzspi, basic spi routines                                                *               ED17  spinit    equ    *  ED17 86   65                 lda    #SPI_CS_+SPI_RST+SPI_SR_+SPI_CR_ set idle  ED19 B7   8080               sta    SPIBASE+spicmd  ED1C 39                      rts                                          *                     * setup inital port for SPI access                     *                     * A,B are lost A=rwflag, F=register, X=offset                     * F=corrected register bits [7...3]                     * A= R/W flag 1=write/ 0= read                     * X,Y untouched                     *               ED1D  spistr2   equ    *  ED1D CE   8080               ldu    #SPIBASE  SPI base TODO  ED20                         trfr   F,B  ED20 1F                      fcb    $1f  ED21 F9                      fcb    F<<4|B                               endm  ED22 5D                      tstb             register pointer  ED23 27   09                 beq    01f       OK, valid  ED25 34   04                 pshs   b  ED27 C4   03                 andb   #RSVREG   reserved loctation  ED29 5D                      tstb             xxx10xxx  is invalid!  ED2A 35   04                 puls   b  ED2C 27   1A                 beq    09f       invalid access                     * adjust READ/WRITE bit  ED2E 4D            01        tsta             cmd flag  ED2F 27   04                 beq    04f  ED31 1A   01                 sec              write   100  ED33 20   02                 bra    05f  ED35 1C   FE       04        clc              read    000                     *  ED37 59            05        rolb             set READ/WRITE bit  [2...0]  ED38 58                      lslb             set variable length data [00]  ED39 58                      lslb                     *                     * here the actual SPI action starts                     *  ED3A                         seti   disable   interrupts  ED3A 1A   50                 orcc   #FF|IF                               endm  ED3C 12                      nop                     *       lda    #SPI_RST+SPI_SR_+SPI_CR_+SPI_AUT+SPI_IEN low  ED3D 86   2D                 lda    #SPI_RST+SPI_SR_+SPI_CR_+SPI_AUT low  ED3F A7   C4                 sta    spicmd,u  ED41 AF   44                 stx    hibyta,u  and shift out  ED43 E7   44                 stb    hibyta,u  and shift out  ED45 1A   04                 sez  ED47 39                      rts  ED48 1C   FB       09        clzFIO Simulation Structure             19:34:38  Apr 22, 2024   Page   82wzspi, basic spi routines                             ED4A 39                      rts                                          *                     * X = offset, unchanged                     * F = register#                     * read BYTE from SPI                     * return B=value, D,X,Y,U preserved                     *               ED4B  byterd    equ    *  ED4B 34   47                 pshs   cc,d,u  ED4D 4F                      clra  ED4E 8D   CD                 bsr    spistr2 >ED50 1026 007E               lbne   09f  ED54 E6   44                 ldb    hibyta,u  extra clocks for first data                     *  ED56 E6   45                 ldb    lobyta,u  read byte  ED58 4F                      clra  ED59 ED   61                 std    1,s  ED5B 20   69                 bra    sprend                                          *                     * X = offset                     * F = register#                     * read WORD from SPI                     * return D=value,  D,X,Y,U preserved                     *               ED5D  wordrd    equ    *  ED5D 34   47                 pshs   cc,d,u  ED5F 4F                      clra >ED60 BD   ED1D               jsr    spistr2  ED63 26   6D                 bne    09f  ED65 E6   44                 ldb    hibyta,u  extra clocks for first data                     *  ED67 A6   45                 lda    lobyta,u  read byte  ED69 E6   45                 ldb    lobyta,u  read byte  ED6B ED   61                 std    1,s  ED6D 20   57                 bra    sprend                                          *                     * Y=mem pointer, D=count (bytes)                     * F = register#                     * read bytes from SPI into memory location                     * return D,X,Y,U preserved                     *               ED6F  bmread    equ    *  ED6F 34   77                 pshs   cc,d,x,y,u  ED71 4F                      clra  ED72 BD   F212               jsr    GSRRXRP  ED75 1F   01                 tfr    d,x  ED77 CE   8080               ldu    #SPIBASE  ED7A 34   40                 pshs   u  ED7C 1A   50                 orcc   #$50FIO Simulation Structure             19:34:38  Apr 22, 2024   Page   83wzspi, basic spi routines                             ED7E 86   2D                 lda    #SPI_RST+SPI_SR_+SPI_CR_+SPI_AUT  ED80 A7   C4                 sta    spicmd,u  ED82 AF   44                 stx    hibyta,u  start address  ED84 BD   F2BC               jsr    tsk2rx  ED87 E7   44                 stb    hibyta,u  ED89 EC   63                 ldd    3,s       old D  ED8B                         trfr   D,W       count  ED8B 1F                      fcb    $1f  ED8C 06                      fcb    D<<4|W                               endm  ED8D 1F   12                 tfr    x,y       mem pointer  ED8F 10AE 67                 ldy    7,s       old Y  ED92 E7   44                 stb    hibyta,u  shift out  ED94 33   45                 leau   lobyta,u  ED96                         tfm4   U,Y  ED96 113B                    fdb    $113b  ED98 32                      fcb    U<<4|Y                               endm  ED99 35   40                 puls   u         old U  ED9B 86   25                 lda    #SPI_RST+SPI_SR_+SPI_CR_  ED9D A7   C4                 sta    spicmd,u                     * X = old read pointer, 0,s byte wount  ED9F 1F   10                 tfr    x,d  EDA1 E3   61                 addd   1,s       move pointer  EDA3 BD   F221               jsr    PSRRXRP   update pointer  EDA6 35   F7                 puls   cc,d,x,y,u,pc                                          *                     * X = offset                     * F = register#                     * write BYTE to SPI, D,X,Y,U preserved                     *               EDA8  bytewr    equ    *  EDA8 34   47                 pshs   cc,d,u  EDAA 86   01                 lda    #1  EDAC BD   ED1D               jsr    spistr2  EDAF 26   21                 bne    09f                     *  EDB1 A6   62                 lda    2,s  EDB3 A7   44                 sta    hibyta,u  EDB5 20   0F                 bra    sprend                                          *                     * X = offset                     * F = register#                     * write WORD to SPI, D,X,Y,U preserved                     *               EDB7  wordwr    equ    *  EDB7 34   47                 pshs   cc,d,u  EDB9 86   01                 lda    #1  EDBB BD   ED1D               jsr    spistr2  EDBE 26   12                 bne    09fFIO Simulation Structure             19:34:38  Apr 22, 2024   Page   84wzspi, basic spi routines                                                *  EDC0 EC   61                 ldd    1,s  EDC2 A7   44                 sta    hibyta,u  EDC4 E7   44                 stb    hibyta,u                     *                     * common exit from SPI action                     *  EDC6 86   65       sprend    lda    #SPI_CS_+SPI_RST+SPI_SR_+SPI_CR_                     *sprend  lda     #SPI_CS_+SPI_RST+SPI_SR_+SPI_CR_+SPI_IEN  EDC8 A7   C4                 sta    spicmd,u  EDCA A6   E4                 lda    0,s       sez  EDCC 8A   04                 ora    #4  EDCE A7   E4       02        sta    0,s  EDD0 35   C7                 puls   cc,d,u,pc                     *  EDD2 A6   E4       09        lda    0,s       clz  EDD4 84   FB                 anda   #255-4  EDD6 20   F6                 bra    02b                     FIO Simulation Structure             19:34:39  Apr 22, 2024   Page   85wzspi, basic spi routines                                                                     * register names and offset               0000  WZMR      equ    0               0001  WZGAR0    equ    1               0002  WZGAR1    equ    2               0003  WZGAR2    equ    3               0004  WZGAR3    equ    4               0005  WZSUBR0   equ    5               0006  WZSUBR1   equ    6               0007  WZSUBR2   equ    7               0008  WZSUBR3   equ    8               0009  WZSHAR0   equ    9               000A  WZSHAR1   equ    10               000B  WZSHAR2   equ    11               000C  WZSHAR3   equ    12               000D  WZSHAR4   equ    13               000E  WZSHAR5   equ    14               000F  WZSIPR0   equ    15               0010  WZSIPR1   equ    16               0011  WZSIPR2   equ    17               0012  WZSIPR3   equ    18               0013  WZILLT0   equ    19               0014  WZILLT1   equ    20               0015  WZIR      equ    21               0016  WZIMR     equ    22               0017  WZSIR     equ    23               0018  WZSIMR    equ    24               0019  WZRTR0    equ    25               001A  WZRTR1    equ    26               001B  WZRCR     equ    27               0028  WZUIPR0   equ    40               0029  WZUIPR1   equ    41               002A  WZUIPR2   equ    42               002B  WZUIPR3   equ    43               002C  WZUPRT0   equ    44               002D  WZUPRT1   equ    45               002E  WZPHY     equ    46               0039  WZVERS    equ    57                                          *                     * all commands to access common register set                     *                                          *                     * GCRMR, get byte from common registers mode register                     * return byte in B                     *  EDD8 34   56       GCRMR     pshs   d,x,u  EDDA 5F                      clrb  EDDB                         trfr   B,F  EDDB 1F                      fcb    $1f  EDDC 9F                      fcb    B<<4|FFIO Simulation Structure             19:34:39  Apr 22, 2024   Page   86wzspi, basic spi routines                                                          endm  EDDD 8E   0000               ldx    #WZMR  EDE0 BD   ED4B               jsr    byterd  EDE3 ED   E4                 std    0,s  EDE5 35   D6                 puls   d,x,u,pc                                          *                     * PCRMR, put byte B into common registers mode register                     *  EDE7 34   16       PCRMR     pshs   d,x  EDE9 5F                      clrb  EDEA                         trfr   B,F  EDEA 1F                      fcb    $1f  EDEB 9F                      fcb    B<<4|F                               endm  EDEC 8E   0000               ldx    #WZMR  EDEF EC   E4                 ldd    0,s >EDF1 BD   EDA8               jsr    bytewr  EDF4 35   96                 puls   d,x,pc                                          *                     * GCRGA, get gateway address from common regsiters                     * Y=destination address (4 bytes)                     *  EDF6 34   16       GCRGA     pshs   d,x  EDF8 5F                      clrb  EDF9                         trfr   B,F  EDF9 1F                      fcb    $1f  EDFA 9F                      fcb    B<<4|F                               endm  EDFB 8E   0001               ldx    #WZGAR0  EDFE BD   ED5D               jsr    wordrd  EE01 ED   A4                 std    0,y  EE03 8E   0003               ldx    #WZGAR2  EE06 BD   ED5D               jsr    wordrd  EE09 ED   22                 std    2,y  EE0B 35   96                 puls   d,x,pc                                          *                     * PCRGW, put gateway address                     * Y=source address (4 bytes)                     *  EE0D 34   16       PCRGA     pshs   d,x  EE0F 5F                      clrb  EE10                         trfr   B,F  EE10 1F                      fcb    $1f  EE11 9F                      fcb    B<<4|F                               endm  EE12 8E   0001               ldx    #WZGAR0  EE15 EC   A4                 ldd    0,y >EE17 BD   EDB7               jsr    wordwr  EE1A 8E   0003               ldx    #WZGAR2FIO Simulation Structure             19:34:39  Apr 22, 2024   Page   87wzspi, basic spi routines                             EE1D EC   22                 ldd    2,y >EE1F BD   EDB7               jsr    wordwr  EE22 35   96                 puls   d,x,pc                                          *                     * GCRSNM, get subnet mask  from common regsiters                     * Y=destination address (4 bytes)                     *  EE24 34   16       GCRSNM    pshs   d,x  EE26 5F                      clrb  EE27                         trfr   B,F  EE27 1F                      fcb    $1f  EE28 9F                      fcb    B<<4|F                               endm  EE29 8E   0005               ldx    #WZSUBR0  EE2C BD   ED5D               jsr    wordrd  EE2F ED   A4                 std    0,y  EE31 8E   0007               ldx    #WZSUBR2  EE34 BD   ED5D               jsr    wordrd  EE37 ED   22                 std    2,y  EE39 35   96                 puls   d,x,pc                                          *                     * PCRSNM, put subnet mask address                     * Y=source address (4 bytes)                     *  EE3B 34   16       PCRSNM    pshs   d,x  EE3D 5F                      clrb  EE3E                         trfr   B,F  EE3E 1F                      fcb    $1f  EE3F 9F                      fcb    B<<4|F                               endm  EE40 8E   0005               ldx    #WZSUBR0  EE43 EC   A4                 ldd    0,y  EE45 BD   EDB7               jsr    wordwr  EE48 8E   0007               ldx    #WZSUBR2  EE4B EC   22                 ldd    2,y  EE4D BD   EDB7               jsr    wordwr  EE50 35   96                 puls   d,x,pc                                          *                     * GCRSHA, get gateway hardware address from common regsiters                     * Y=destination address (6 bytes)                     *  EE52 34   16       GCRSHA    pshs   d,x  EE54 5F                      clrb  EE55                         trfr   B,F  EE55 1F                      fcb    $1f  EE56 9F                      fcb    B<<4|F                               endm  EE57 8E   0009               ldx    #WZSHAR0  EE5A BD   ED5D               jsr    wordrdFIO Simulation Structure             19:34:39  Apr 22, 2024   Page   88wzspi, basic spi routines                             EE5D ED   A4                 std    0,y  EE5F 8E   000B               ldx    #WZSHAR2  EE62 BD   ED5D               jsr    wordrd  EE65 ED   22                 std    2,y  EE67 8E   000D               ldx    #WZSHAR4  EE6A BD   ED5D               jsr    wordrd  EE6D ED   24                 std    4,y  EE6F 35   96                 puls   d,x,pc                                          *                     * PCRSHA, put gateway hardware address                     * Y=source address (6 bytes)                     *  EE71 34   16       PCRSHA    pshs   d,x  EE73 5F                      clrb  EE74                         trfr   B,F  EE74 1F                      fcb    $1f  EE75 9F                      fcb    B<<4|F                               endm  EE76 8E   0009               ldx    #WZSHAR0  EE79 EC   A4                 ldd    0,y  EE7B BD   EDB7               jsr    wordwr  EE7E 8E   000B               ldx    #WZSHAR2  EE81 EC   22                 ldd    2,y  EE83 BD   EDB7               jsr    wordwr  EE86 8E   000D               ldx    #WZSHAR4  EE89 EC   24                 ldd    4,y  EE8B BD   EDB7               jsr    wordwr  EE8E 35   96                 puls   d,x,pc                                          *                     * GCRSIP, get source IP address from common regsiters                     * Y=destination address (4 bytes)                     *  EE90 34   16       GCRSIP    pshs   d,x  EE92 5F                      clrb  EE93                         trfr   B,F  EE93 1F                      fcb    $1f  EE94 9F                      fcb    B<<4|F                               endm  EE95 8E   000F               ldx    #WZSIPR0  EE98 BD   ED5D               jsr    wordrd  EE9B ED   A4                 std    0,y  EE9D 8E   0011               ldx    #WZSIPR2  EEA0 BD   ED5D               jsr    wordrd  EEA3 ED   22                 std    2,y  EEA5 35   96                 puls   d,x,pc                                          *                     * PCRSIP, put gateway address                     * Y=source address (4 bytes)                     *FIO Simulation Structure             19:34:40  Apr 22, 2024   Page   89wzspi, basic spi routines                             EEA7 34   16       PCRSIP    pshs   d,x  EEA9 5F                      clrb  EEAA                         trfr   B,F  EEAA 1F                      fcb    $1f  EEAB 9F                      fcb    B<<4|F                               endm  EEAC 8E   000F               ldx    #WZSIPR0  EEAF EC   A4                 ldd    0,y  EEB1 BD   EDB7               jsr    wordwr  EEB4 8E   0011               ldx    #WZSIPR2  EEB7 EC   22                 ldd    2,y  EEB9 BD   EDB7               jsr    wordwr  EEBC 35   96                 puls   d,x,pc                                          *                     * GCRILLT, get byte from interrup low level timer register                     * return word in D                     *  EEBE 34   16       GCRILLT   pshs   d,x  EEC0 5F                      clrb  EEC1                         trfr   B,F  EEC1 1F                      fcb    $1f  EEC2 9F                      fcb    B<<4|F                               endm  EEC3 8E   0013               ldx    #WZILLT0  EEC6 BD   ED5D               jsr    wordrd  EEC9 ED   E4                 std    0,s  EECB 35   96                 puls   d,x,pc                                          *                     * PCRILLT, put word D into common registers mode register                     *  EECD 34   16       PCRILLT   pshs   d,x  EECF 5F                      clrb  EED0                         trfr   B,F  EED0 1F                      fcb    $1f  EED1 9F                      fcb    B<<4|F                               endm  EED2 8E   0013               ldx    #WZILLT0  EED5 EC   E4                 ldd    0,s  EED7 BD   EDB7               jsr    wordwr  EEDA 35   96                 puls   d,x,pc                                          *                     * GCRIR, get byte from common registers interrupt register                     * return byte in B                     *  EEDC 34   16       GCRIR     pshs   d,x  EEDE 5F                      clrb  EEDF                         trfr   B,F  EEDF 1F                      fcb    $1f  EEE0 9F                      fcb    B<<4|FFIO Simulation Structure             19:34:40  Apr 22, 2024   Page   90wzspi, basic spi routines                                                          endm  EEE1 8E   0015               ldx    #WZIR  EEE4 BD   ED4B               jsr    byterd  EEE7 ED   E4                 std    0,s  EEE9 35   96                 puls   d,x,pc                                          *                     * PCRIR, put byte B into common registers interrupt register                     *  EEEB 34   16       PCRIR     pshs   d,x  EEED 5F                      clrb  EEEE                         trfr   B,F  EEEE 1F                      fcb    $1f  EEEF 9F                      fcb    B<<4|F                               endm  EEF0 8E   0015               ldx    #WZIR  EEF3 EC   E4                 ldd    0,s  EEF5 BD   EDA8               jsr    bytewr  EEF8 35   96                 puls   d,x,pc                                          *                     * GCRIMR, get byte from common registers interrupt mask register                     * return byte in B                     *  EEFA 34   16       GCRIMR    pshs   d,x  EEFC 5F                      clrb  EEFD                         trfr   B,F  EEFD 1F                      fcb    $1f  EEFE 9F                      fcb    B<<4|F                               endm  EEFF 8E   0016               ldx    #WZIMR  EF02 BD   ED4B               jsr    byterd  EF05 ED   E4                 std    0,s  EF07 35   96                 puls   d,x,pc                                          *                     * PCRIMR, put byte B into common registers interrupt mask register                     *  EF09 34   16       PCRIMR    pshs   d,x  EF0B 5F                      clrb  EF0C                         trfr   B,F  EF0C 1F                      fcb    $1f  EF0D 9F                      fcb    B<<4|F                               endm  EF0E 8E   0016               ldx    #WZIMR  EF11 EC   E4                 ldd    0,s  EF13 BD   EDA8               jsr    bytewr  EF16 35   96                 puls   d,x,pc                                          *                     * GCRSIR, get byte from common registers socket interrupt register                     * return byte in BFIO Simulation Structure             19:34:40  Apr 22, 2024   Page   91wzspi, basic spi routines                                                *  EF18 34   16       GCRSIR    pshs   d,x  EF1A 5F                      clrb  EF1B                         trfr   B,F  EF1B 1F                      fcb    $1f  EF1C 9F                      fcb    B<<4|F                               endm  EF1D 8E   0017               ldx    #WZSIR  EF20 BD   ED4B               jsr    byterd  EF23 ED   E4                 std    0,s  EF25 35   96                 puls   d,x,pc                                          *                     * PCRSIR, put byte B into common registers socket interrupt register                     *  EF27 34   16       PCRSIR    pshs   d,x  EF29 5F                      clrb  EF2A                         trfr   B,F  EF2A 1F                      fcb    $1f  EF2B 9F                      fcb    B<<4|F                               endm  EF2C 8E   0017               ldx    #WZSIR  EF2F EC   E4                 ldd    0,s  EF31 BD   EDA8               jsr    bytewr  EF34 35   96                 puls   d,x,pc                                          *                     * GCSIMR, get byte from common registers socket interrupt mask register                     * return byte in B                     *  EF36 34   16       GCRSIMR   pshs   d,x  EF38 5F                      clrb  EF39                         trfr   B,F  EF39 1F                      fcb    $1f  EF3A 9F                      fcb    B<<4|F                               endm  EF3B 8E   0018               ldx    #WZSIMR  EF3E BD   ED4B               jsr    byterd  EF41 ED   E4                 std    0,s  EF43 35   96                 puls   d,x,pc                                          *                     * PCRSIMR, put byte B into common registers socket interrupt mask register                     *  EF45 34   16       PCRSIMR   pshs   d,x  EF47 5F                      clrb  EF48                         trfr   B,F  EF48 1F                      fcb    $1f  EF49 9F                      fcb    B<<4|F                               endm  EF4A 8E   0018               ldx    #WZSIMR  EF4D EC   E4                 ldd    0,sFIO Simulation Structure             19:34:41  Apr 22, 2024   Page   92wzspi, basic spi routines                             EF4F BD   EDA8               jsr    bytewr  EF52 35   96                 puls   d,x,pc                                          *                     * GCRRTR, get word from common registers retry register                     * return word in D                     *  EF54 34   16       GCRRTR    pshs   d,x  EF56 5F                      clrb  EF57                         trfr   B,F  EF57 1F                      fcb    $1f  EF58 9F                      fcb    B<<4|F                               endm  EF59 8E   0019               ldx    #WZRTR0  EF5C BD   ED5D               jsr    wordrd  EF5F ED   E4                 std    0,s  EF61 35   96                 puls   d,x,pc                                          *                     * PCRRTR, put word D into common registers retry register                     *  EF63 34   16       PCRRTR    pshs   d,x  EF65 5F                      clrb  EF66                         trfr   B,F  EF66 1F                      fcb    $1f  EF67 9F                      fcb    B<<4|F                               endm  EF68 8E   0019               ldx    #WZRTR0  EF6B EC   E4                 ldd    0,s  EF6D BD   EDB7               jsr    wordwr  EF70 35   96                 puls   d,x,pc                                          *                     * GCRRCR, get byte from common registers retry count register                     * return byte in B                     *  EF72 34   16       GCRRCR    pshs   d,x  EF74 5F                      clrb  EF75                         trfr   B,F  EF75 1F                      fcb    $1f  EF76 9F                      fcb    B<<4|F                               endm  EF77 8E   001B               ldx    #WZRCR  EF7A BD   ED4B               jsr    byterd  EF7D ED   E4                 std    0,s  EF7F 35   96                 puls   d,x,pc                                          *                     * PCRRCR, put byte B into common registers retry count register                     *  EF81 34   16       PCRRCR    pshs   d,x  EF83 5F                      clrbFIO Simulation Structure             19:34:41  Apr 22, 2024   Page   93wzspi, basic spi routines                             EF84                         trfr   B,F  EF84 1F                      fcb    $1f  EF85 9F                      fcb    B<<4|F                               endm  EF86 8E   001B               ldx    #WZRCR  EF89 EC   E4                 ldd    0,s  EF8B BD   EDA8               jsr    bytewr  EF8E 35   96                 puls   d,x,pc                                          *                     * GCRURP, get word from common registers unreachable port register                     * return word in D                     *  EF90 34   16       GCRURP    pshs   d,x  EF92 5F                      clrb  EF93                         trfr   B,F  EF93 1F                      fcb    $1f  EF94 9F                      fcb    B<<4|F                               endm  EF95 8E   002C               ldx    #WZUPRT0  EF98 BD   ED5D               jsr    wordrd  EF9B ED   E4                 std    0,s  EF9D 35   96                 puls   d,x,pc                                          *                     * GCRUIP, get unreachable IP address from common registers                     * Y=destination address (4 bytes)                     *  EF9F 34   16       GCRUIP    pshs   d,x  EFA1 5F                      clrb  EFA2                         trfr   B,F  EFA2 1F                      fcb    $1f  EFA3 9F                      fcb    B<<4|F                               endm  EFA4 8E   0028               ldx    #WZUIPR0  EFA7 BD   ED5D               jsr    wordrd  EFAA ED   A4                 std    0,y  EFAC 8E   002A               ldx    #WZUIPR2  EFAF BD   ED5D               jsr    wordrd  EFB2 ED   22                 std    2,y  EFB4 35   96                 puls   d,x,pc                                          *                     * GCRPHY, get byte from common registers PHY config register                     * return byte in B                     *  EFB6 34   56       GCRPHY    pshs   d,x,u  EFB8 8E   002E               ldx    #WZPHY  EFBB 5F                      clrb  EFBC                         trfr   B,F  EFBC 1F                      fcb    $1f  EFBD 9F                      fcb    B<<4|FFIO Simulation Structure             19:34:41  Apr 22, 2024   Page   94wzspi, basic spi routines                                                          endm  EFBE BD   ED4B               jsr    byterd  EFC1 ED   E4                 std    0,s  EFC3 35   D6                 puls   d,x,u,pc                                          *                     * PCRPHY, put byte B into common registers PHY config register                     *  EFC5 34   56       PCRPHY    pshs   d,x,u  EFC7 8E   002E               ldx    #WZPHY  EFCA 5F                      clrb  EFCB                         trfr   B,F  EFCB 1F                      fcb    $1f  EFCC 9F                      fcb    B<<4|F                               endm  EFCD EC   E4                 ldd    0,s  EFCF BD   EDA8               jsr    bytewr  EFD2 35   D6                 puls   d,x,u,pc                                          *                     * GCRVERS, get byte from common registers socket version register                     * return byte in B                     *  EFD4 34   56       GCRVERS   pshs   d,x,u  EFD6 8E   0039               ldx    #WZVERS  EFD9 5F                      clrb  EFDA                         trfr   B,F  EFDA 1F                      fcb    $1f  EFDB 9F                      fcb    B<<4|F                               endm  EFDC BD   ED4B               jsr    byterd  EFDF ED   E4                 std    0,s  EFE1 35   D6                 puls   d,x,u,pc                     *                     * all functions to access socket registers                     *                                          * socket register names and offsets               0000  SNMR      equ    0               0001  SNCR      equ    1               0002  SNIR      equ    2               0003  SNSR      equ    3               0004  SNPORT0   equ    4               0005  SNPORT1   equ    5               0006  SNDHAR0   equ    6               0007  SNDHAR1   equ    7               0008  SNDHAR2   equ    8               0009  SNDHAR3   equ    9               000A  SNDHAR4   equ    10               000B  SNDHAR5   equ    11               000C  SNDIPR0   equ    12               000D  SNDIPR1   equ    13FIO Simulation Structure             19:34:42  Apr 22, 2024   Page   95wzspi, basic spi routines                                          000E  SNDIPR2   equ    14               000F  SNDIPR3   equ    15               0010  SNDPOR0   equ    16               0011  SNDPOR1   equ    17               0012  SNMSSR0   equ    18               0013  SNMSSR1   equ    19               0014  SNPROTO   equ    20               0015  SNTOS     equ    21               0016  SNTTL     equ    22               001E  SNRBFSZ   equ    30               001F  SNTBFSZ   equ    31               0020  SNTXFR0   equ    32               0021  SNTXFR1   equ    33               0022  SNTXRP0   equ    34               0023  SNTXRP1   equ    35               0024  SNTXWP0   equ    36               0025  SNTXWP1   equ    37               0026  SNRXRZ0   equ    38               0027  SNRXRZ1   equ    39               0028  SNRXRP0   equ    40               0029  SNRXRP1   equ    41               002A  SNRXWP0   equ    42               002B  SNRXWP1   equ    43               002C  SNIMR     equ    44               002D  SNFRAG0   equ    45               002E  SNFRAG1   equ    46               002F  SNKATIM   equ    47                                                               *                     * all commands to access socket register set                     *                                                               *                     * GSRMR, get byte from socket registers mode register                     * E=socket#                     * return byte in B                     *  EFE3 34   16       GSRMR     psh    d,x  EFE5 BD   F2A1               jsr    tsk2rg  EFE8 8E   0000               ldx    #SNMR  EFEB BD   ED4B               jsr    byterd  EFEE ED   E4                 std    0,s  EFF0 35   96                 puls   d,x,pc                                          *                     * PSRMR, put byte B  to socket registers mode register                     * E=socket#                     *  EFF2 34   16       PSRMR     pshs   d,x  EFF4 BD   F2A1               jsr    tsk2rgFIO Simulation Structure             19:34:42  Apr 22, 2024   Page   96wzspi, basic spi routines                             EFF7 8E   0000               ldx    #SNMR  EFFA EC   E4                 ldd    0,s  EFFC BD   EDA8               jsr    bytewr  EFFF 35   96                 puls   d,x,pc                                          *                     * GSRCR, get bytefrom socket registers command register                     * E=socket#                     * return byte in B                     *  F001 34   16       GSRCR     pshs   d,x  F003 BD   F2A1               jsr    tsk2rg  F006 8E   0001               ldx    #SNCR  F009 BD   ED4B               jsr    byterd  F00C ED   E4                 std    0,s  F00E 35   96                 puls   d,x,pc                                          *                     * PSRCR, put byte B in socket registers command register                     * E=socket#                     *  F010 34   16       PSRCR     pshs   d,x  F012 BD   F2A1               jsr    tsk2rg  F015 8E   0001               ldx    #SNCR  F018 EC   E4                 ldd    0,s  F01A BD   EDA8               jsr    bytewr  F01D 8D   E2       01        bsr    GSRCR  F01F 5D                      tstb  F020 26   FB                 bne    01b       wait command to be consumed  F022 E7   61                 stb    1,s       set return  F024 35   96                 puls   d,x,pc                                          *                     * GSRIR, get bytefrom socket registers interrupt register                     * E=socket#                     * return byte in B                     *  F026 34   16       GSRIR     pshs   d,x  F028 BD   F2A1               jsr    tsk2rg  F02B 8E   0002               ldx    #SNIR  F02E BD   ED4B               jsr    byterd  F031 ED   E4                 std    0,s  F033 35   96                 puls   d,x,pc                                          *                     * PSRIR, put byte B in socket registers interrupt register                     * E=socket#                     *  F035 34   16       PSRIR     pshs   d,x  F037 BD   F2A1               jsr    tsk2rg  F03A 8E   0002               ldx    #SNIR  F03D EC   E4                 ldd    0,sFIO Simulation Structure             19:34:42  Apr 22, 2024   Page   97wzspi, basic spi routines                             F03F BD   EDA8               jsr    bytewr  F042 35   96                 puls   d,x,pc                                          *                     * GSRSR, get bytefrom socket registers status register                     * E=socket#                     * return byte in B                     *  F044 34   16       GSRSR     pshs   d,x  F046 BD   F2A1               jsr    tsk2rg  F049 8E   0003               ldx    #SNSR  F04C BD   ED4B               jsr    byterd  F04F ED   E4                 std    0,s  F051 35   96                 puls   d,x,pc                                          *                     * GSRPORT, get word from socket registers source port                     * E=socket#                     * return word in D                     *  F053 34   16       GSRPORT   pshs   d,x  F055 BD   F2A1               jsr    tsk2rg  F058 8E   0004               ldx    #SNPORT0  F05B BD   ED5D               jsr    wordrd  F05E ED   E4                 std    0,s  F060 35   96                 pul    d,x,pc                                          *                     * PSRPORT, put word D into socket registers source port                     * E=socket#                     *  F062 34   16       PSRPORT   pshs   d,x  F064 BD   F2A1               jsr    tsk2rg  F067 8E   0004               ldx    #SNPORT0  F06A EC   E4                 ldd    0,s  F06C BD   EDB7               jsr    wordwr  F06F 35   96                 puls   d,x,pc                                          *                     * GSRDHAR, get destination hardware address into [Y]                     * F=sockt#, Y=destination                     *  F071 34   16       GSRDHAR   pshs   d,x  F073 BD   F2A1               jsr    tsk2rg  F076 8E   0006               ldx    #SNDHAR0  F079 BD   ED5D               jsr    wordrd  F07C ED   A4                 std    0,y  F07E 8E   0008               ldx    #SNDHAR2  F081 BD   ED5D               jsr    wordrd  F084 ED   22                 std    2,y  F086 8E   000A               ldx    #SNDHAR4  F089 BD   ED5D               jsr    wordrdFIO Simulation Structure             19:34:43  Apr 22, 2024   Page   98wzspi, basic spi routines                             F08C ED   24                 std    4,y  F08E 35   96                 puls   d,x,pc                                          *                     * PSRDHAR, put [Y] into destination hardware address                     * F=sockt#, Y=destination                     *  F090 34   16       PSRDHAR   pshs   d,x  F092 BD   F2A1               jsr    tsk2rg  F095 8E   0006               ldx    #SNDHAR0  F098 EC   A4                 ldd    0,y  F09A BD   EDB7               jsr    wordwr  F09D 8E   0008               ldx    #SNDHAR2  F0A0 EC   22                 ldd    2,y  F0A2 BD   EDB7               jsr    wordwr  F0A5 8E   000A               ldx    #SNDHAR4  F0A8 EC   24                 ldd    4,y  F0AA BD   EDB7               jsr    wordwr  F0AD 35   96                 puls   d,x,pc                                          *                     * GSRDIP. get destination IP address into [Y]                     * E=socket#                     *  F0AF 34   16       GSRDIP    pshs   d,x  F0B1 BD   F2A1               jsr    tsk2rg  F0B4 8E   000C               ldx    #SNDIPR0  F0B7 BD   ED5D               jsr    wordrd  F0BA ED   A4                 std    0,y  F0BC 8E   000E               ldx    #SNDIPR2  F0BF BD   ED5D               jsr    wordrd  F0C2 ED   22                 std    2,y  F0C4 35   96                 puls   d,x,pc                                          *                     * PSRDIP. put destination IP address into [Y]                     * E=socket#                     *  F0C6 34   16       PSRDIP    pshs   d,x  F0C8 BD   F2A1               jsr    tsk2rg  F0CB 8E   000C               ldx    #SNDIPR0  F0CE EC   A4                 ldd    0,y  F0D0 BD   EDB7               jsr    wordwr  F0D3 8E   000E               ldx    #SNDIPR2  F0D6 EC   22                 ldd    2,y  F0D8 BD   EDB7               jsr    wordwr  F0DB 35   96                 puls   d,x,pc                                          *                     * GSRDPOR, get word from socket registers destination port                     * E=socket#                     * return word in DFIO Simulation Structure             19:34:43  Apr 22, 2024   Page   99wzspi, basic spi routines                                                *  F0DD 34   16       GSRDPOR   pshs   d,x  F0DF BD   F2A1               jsr    tsk2rg  F0E2 8E   0010               ldx    #SNDPOR0  F0E5 BD   ED5D               jsr    wordrd  F0E8 ED   E4                 std    0,s  F0EA 35   96                 pul    d,x,pc                                          *                     * PSRDPOR, put word D into socket registers destination port                     * E=socket#                     *  F0EC 34   16       PSRDPOR   pshs   d,x  F0EE BD   F2A1               jsr    tsk2rg  F0F1 8E   0010               ldx    #SNDPOR0  F0F4 EC   E4                 ldd    0,s  F0F6 BD   EDB7               jsr    wordwr  F0F9 35   96                 puls   d,x,pc                                          *                     * GSRMSS, get word from socket registers max segment size                     * E=socket#                     * return word in D                     *  F0FB 34   16       GSRMSS    pshs   d,x  F0FD BD   F2A1               jsr    tsk2rg  F100 8E   0012               ldx    #SNMSSR0  F103 BD   ED5D               jsr    wordrd  F106 ED   E4                 std    0,s  F108 35   96                 pul    d,x,pc                                          *                     * PSRMSS, put word D into socket registers maximum segment size                     * E=socket#                     *  F10A 34   16       PSRMSS    pshs   d,x  F10C BD   F2A1               jsr    tsk2rg  F10F 8E   0012               ldx    #SNMSSR0  F112 EC   E4                 ldd    0,s  F114 BD   EDB7               jsr    wordwr  F117 35   96                 puls   d,x,pc                                          *                     * GSRPROT, get byte from socket registers PROTOCOL                     * E=socket#                     * return byte in B                     *  F119 34   16       GSRPROT   pshs   d,x  F11B BD   F2A1               jsr    tsk2rg  F11E 8E   0014               ldx    #SNPROTO  F121 BD   ED4B               jsr    byterd  F124 ED   E4                 std    0,sFIO Simulation Structure             19:34:43  Apr 22, 2024   Page  100wzspi, basic spi routines                             F126 35   96                 pul    d,x,pc                                          *                     * PSRPROT, put byte B into socket registers PROTOCOL                     * E=socket#                     *  F128 34   16       PSRPROT   pshs   d,x  F12A BD   F2A1               jsr    tsk2rg  F12D 8E   0014               ldx    #SNPROTO  F130 EC   E4                 ldd    0,s  F132 BD   EDA8               jsr    bytewr  F135 35   96                 puls   d,x,pc                                          *                     * GSRTOS, get byte from socket registers TOS                     * E=socket#                     * return byte in B                     *  F137 34   16       GSRTOS    pshs   d,x  F139 BD   F2A1               jsr    tsk2rg  F13C 8E   0015               ldx    #SNTOS  F13F BD   ED4B               jsr    byterd  F142 ED   E4                 std    0,s  F144 35   96                 pul    d,x,pc                                          *                     * PSRTOS, put byte B into socket registers TOS                     * E=socket#                     *  F146 34   16       PSRTOS    pshs   d,x  F148 BD   F2A1               jsr    tsk2rg  F14B 8E   0015               ldx    #SNTOS  F14E EC   E4                 ldd    0,s  F150 BD   EDA8               jsr    bytewr  F153 35   96                 puls   d,x,pc                                          *                     * GSRTTL, get byte from socket registers TTL                     * E=socket#                     * return byte in B                     *  F155 34   16       GSRTTL    pshs   d,x  F157 BD   F2A1               jsr    tsk2rg  F15A 8E   0016               ldx    #SNTTL  F15D BD   ED4B               jsr    byterd  F160 ED   E4                 std    0,s  F162 35   96                 pul    d,x,pc                                          *                     * PSRTTL, put byte B into socket registers TTL                     * E=socket#                     *FIO Simulation Structure             19:34:44  Apr 22, 2024   Page  101wzspi, basic spi routines                             F164 34   16       PSRTTL    pshs   d,x  F166 BD   F2A1               jsr    tsk2rg  F169 8E   0016               ldx    #SNTTL  F16C EC   E4                 ldd    0,s  F16E BD   EDA8               jsr    bytewr  F171 35   96                 puls   d,x,pc                                          *                     * GSRRBFS, get byte from socket registers rec buf size                     * E=socket#                     * return byte in B                     *  F173 34   16       GSRRBFS   pshs   d,x  F175 BD   F2A1               jsr    tsk2rg  F178 8E   001E               ldx    #SNRBFSZ  F17B BD   ED4B               jsr    byterd  F17E ED   E4                 std    0,s  F180 35   96                 pul    d,x,pc                                          *                     * PSRTBFS, put byte B into socket registers rec buf size                     * E=socket#                     *  F182 34   16       PSRRBFS   pshs   d,x  F184 BD   F2A1               jsr    tsk2rg  F187 8E   001E               ldx    #SNRBFSZ  F18A EC   E4                 ldd    0,s  F18C BD   EDA8               jsr    bytewr  F18F 35   96                 puls   d,x,pc                                          *                     * GSRTBFS, get byte from socket registers tx buf size                     * E=socket#                     * return byte in B                     *  F191 34   16       GSRTBFS   pshs   d,x  F193 BD   F2A1               jsr    tsk2rg  F196 8E   001F               ldx    #SNTBFSZ  F199 BD   ED4B               jsr    byterd  F19C ED   E4                 std    0,s  F19E 35   96                 puls   d,x,pc                                          *                     * PSRTBFS, put byte B into socket registers tx buf size                     * E=socket#                     *  F1A0 34   16       PSRTBFS   pshs   d,x  F1A2 BD   F2A1               jsr    tsk2rg  F1A5 8E   001F               ldx    #SNTBFSZ  F1A8 EC   E4                 ldd    0,s  F1AA BD   EDA8               jsr    bytewr  F1AD 35   96                 puls   d,x,pcFIO Simulation Structure             19:34:44  Apr 22, 2024   Page  102wzspi, basic spi routines                                                                     *                     * GSRTXFR, get word from socket registers TX free size                     * E=socket#                     * return word in D                     *  F1AF 34   16       GSRTXFR   pshs   d,x  F1B1 BD   F2A1               jsr    tsk2rg  F1B4 8E   0020               ldx    #SNTXFR0  [R]  F1B7 BD   ED5D               jsr    wordrd  F1BA ED   E4       01        std    0,s  F1BC BD   ED5D               jsr    wordrd  F1BF 10A3 E4                 cmpd   0,s       read more times and exit  F1C2 26   F6                 bne    01b       when 2 reads are equal  F1C4 35   96                 puls   d,x,pc                                          *                     * GSRTXRP, get word from socket registers TX read pointer                     * E=socket#                     * return word in D                     *  F1C6 34   16       GSRTXRP   pshs   d,x  F1C8 BD   F2A1               jsr    tsk2rg  F1CB 8E   0022               ldx    #SNTXRP0  [R]  F1CE BD   ED5D               jsr    wordrd  F1D1 ED   E4       01        std    0,s  F1D3 BD   ED5D               jsr    wordrd  F1D6 10A3 E4                 cmpd   0,s       read more times and exit  F1D9 26   F6                 bne    01b       when 2 reads are equal  F1DB 35   96                 puls   d,x,pc                                          *                     * GSRTXWP, get word from socket registers TX write pointer                     * E=socket#                     * return word in D                     *  F1DD 34   16       GSRTXWP   pshs   d,x  F1DF BD   F2A1               jsr    tsk2rg  F1E2 8E   0024               ldx    #SNTXWP0  [RW]  F1E5 BD   ED5D               jsr    wordrd  F1E8 ED   E4                 std    0,s  F1EA 35   96                 puls   d,x,pc                                          *                     * PSRTXWP, put word D into socket registers TX write pointer                     * E=socket#                     *  F1EC 34   16       PSRTXWP   pshs   d,x  F1EE BD   F2A1               jsr    tsk2rg  F1F1 8E   0024               ldx    #SNTXWP0  F1F4 EC   E4                 ldd    0,s  F1F6 BD   EDB7               jsr    wordwrFIO Simulation Structure             19:34:44  Apr 22, 2024   Page  103wzspi, basic spi routines                             F1F9 35   96                 puls   d,x,pc                                          *                     * GSRRXRS, get word from socket registers RX received size                     * E=socket#                     * return word in D                     *  F1FB 34   16       GSRRXRS   pshs   d,x  F1FD BD   F2A1               jsr    tsk2rg  F200 8E   0026               ldx    #SNRXRZ0  [R]  F203 BD   ED5D               jsr    wordrd  F206 ED   E4       01        std    0,s  F208 BD   ED5D               jsr    wordrd  F20B 10A3 E4                 cmpd   0,s       read more times and exit  F20E 26   F6                 bne    01b       when 2 reads are equal  F210 35   96                 puls   d,x,pc                                          *                     * GSRRXRP, get word from socket registers RX read pointer                     * E=socket#                     * return word in D                     *  F212 34   16       GSRRXRP   pshs   d,x  F214 BD   F2A1               jsr    tsk2rg  F217 8E   0028               ldx    #SNRXRP0  [RW]  F21A BD   ED5D               jsr    wordrd  F21D ED   E4                 std    0,s  F21F 35   96                 puls   d,x,pc                                          *                     * PSRRXRP, put word D into socket registers RX read pointer                     * E=socket#                     *  F221 34   16       PSRRXRP   pshs   d,x >F223 BD   F2A1               jsr    tsk2rg  F226 8E   0028               ldx    #SNRXRP0  F229 EC   E4                 ldd    0,s  F22B BD   EDB7               jsr    wordwr  F22E 35   96                 puls   d,x,pc                                          *                     * GSRRXWP, get word from socket registers RX write pointer                     * E=socket#                     * return word in D                     *  F230 34   16       GSRRXWP   pshs   d,x >F232 BD   F2A1               jsr    tsk2rg  F235 8E   002A               ldx    #SNRXWP0  [R]  F238 BD   ED5D               jsr    wordrd  F23B ED   E4       01        std    0,s  F23D BD   ED5D               jsr    wordrd  F240 10A3 E4                 cmpd   0,s       read more times and exitFIO Simulation Structure             19:34:45  Apr 22, 2024   Page  104wzspi, basic spi routines                             F243 26   F6                 bne    01b       when 2 reads are equal  F245 35   96                 puls   d,x,pc                                          *                     * GSRIMR, get byte from socket registers interrupt mask                     * E=socket#                     * return byte in B                     *  F247 34   16       GSRIMR    pshs   d,x >F249 BD   F2A1               jsr    tsk2rg  F24C 8E   002C               ldx    #SNIMR  F24F BD   ED4B               jsr    byterd  F252 ED   E4                 std    0,s  F254 35   96                 puls   d,x,pc                                          *                     * PSRIMS, put byte B into socket registers interrupt mask                     * E=socket#                     *  F256 34   16       PSRIMR    pshs   d,x >F258 BD   F2A1               jsr    tsk2rg  F25B 8E   002C               ldx    #SNIMR  F25E EC   E4                 ldd    0,s  F260 BD   EDA8               jsr    bytewr  F263 35   96                 puls   d,x,pc                                          *                     * GSRFRAG, get word from socket registers FRAG                     * E=socket#                     * return word in D                     *  F265 34   16       GSRFRAG   pshs   d,x >F267 BD   F2A1               jsr    tsk2rg  F26A 8E   002D               ldx    #SNFRAG0  F26D BD   ED5D               jsr    wordrd  F270 ED   E4                 std    0,s  F272 35   96                 puls   d,x,pc                                          *                     * PSRGRAG, put word D into socket registers FRAG                     * E=socket#                     *  F274 34   16       PSRFRAG   pshs   d,x >F276 BD   F2A1               jsr    tsk2rg  F279 8E   002D               ldx    #SNFRAG0  F27C EC   E4                 ldd    0,s  F27E BD   EDB7               jsr    wordwr  F281 35   96                 puls   d,x,pc                                          *                     * GSRKATM, get byte from socket registers keep alive timer                     * E=socket#FIO Simulation Structure             19:34:45  Apr 22, 2024   Page  105wzspi, basic spi routines                                                * return byte in B                     *  F283 34   16       GSKATM    pshs   d,x >F285 BD   F2A1               jsr    tsk2rg  F288 8E   002F               ldx    #SNKATIM  F28B BD   ED4B               jsr    byterd  F28E ED   E4                 std    0,s  F290 35   96                 puls   d,x,pc                                          *                     * PSRKATM, put byte B into socket registers keep alive timer                     * E=socket#                     *  F292 34   16       PSRKATM   pshs   d,x >F294 BD   F2A1               jsr    tsk2rg  F297 8E   002F               ldx    #SNKATIM  F29A EC   E4                 ldd    0,s  F29C BD   EDA8               jsr    bytewr  F29F 35   96                 puls   d,x,pc                     *                     * data handling routines                     *                                          * translate socket register in partial address                     * prepares bits [7...5][4...3]                     * E=socket#, F=lost, B=lost               F2A1  tsk2rg    equ    *  F2A1                         trfr   E,B  F2A1 1F                      fcb    $1f  F2A2 E9                      fcb    E<<4|B                               endm  F2A3 5A                      decb             wzenum= 1...8, sn= 0...7                     *  F2A4 1C   FE                 clc              make reg bits + '01'  F2A6 59                      rolb             socket register  F2A7 1A   01                 sec  F2A9 59                      rolb             xxx 01 ...                     *  F2AA                         trfr   B,F  F2AA 1F                      fcb    $1f  F2AB 9F                      fcb    B<<4|F                               endm  F2AC 39                      rts                                          *                     * translate socket register in final address (data xfer)                     * prepares bit [7...0]                     *               F2AD  tsk2tx    equ    *  F2AD                         trfr   E,B  F2AD 1F                      fcb    $1f  F2AE E9                      fcb    E<<4|BFIO Simulation Structure             19:34:45  Apr 22, 2024   Page  106wzspi, basic spi routines                                                          endm  F2AF 5A                      decb             wzenum= 1...8, sn= 0...7                     *  F2B0 1A   01                 sec              make reg bits + '10'  F2B2 59                      rolb             sock TX buffer  F2B3 1C   FE                 clc  F2B5 59                      rolb                     *  F2B6 1A   01                 sec  F2B8 59                      rolb             write bit     '1'                     *  F2B9 58                      lslb             variable size '00'  F2BA 58                      lslb             xxx 10 100                     *  F2BB 39                      rts                                          *                     * translate socket register in rx buffer address (data xfer)                     * prepares bit [7...0]                     *               F2BC  tsk2rx    equ    *  F2BC                         trfr   E,B  F2BC 1F                      fcb    $1f  F2BD E9                      fcb    E<<4|B                               endm  F2BE 5A                      decb             wzenum= 1...8, sn= 0...7                     *  F2BF 1A   01                 sec              make reg bits + '11'  F2C1 59                      rolb             sock RX buffer  F2C2 1A   01                 sec              make reg bits + '11'  F2C4 59                      rolb                     *  F2C5 1C   FE                 clc  F2C7 59                      rolb             read bit     '0'                     *  F2C8 58                      lslb             variable size '00'  F2C9 58                      lslb             xxx 11 000  F2CA 39                      rts                                          *                     * rdsk2fb, read socket data in fifo buffer                     * Y=target, U=sock info                     * E=socket#                     * entry D= available count                     * return, D=xferred count                     *  F2CB 34   76       RDSK2FB   pshs   d,x,y,u                     *  F2CD 10A3 4A                 cmpd   wzrqln,u  has fio max size incorporated  F2D0 23   02                 bls    01f  F2D2 EC   4A                 ldd    wzrqln,u  mandatory size  F2D4 1F   01       01        tfr    D,X       save for laterFIO Simulation Structure             19:34:46  Apr 22, 2024   Page  107wzspi, basic spi routines                             F2D6 ED   E4                 std    0,s       save xfrerred old  D  F2D8 ED   48                 std    wzxfer,u  F2DA 27   3B                 beq    15f       no data                     *  F2DC BD   F212               jsr    GSRRXRP  F2DF 34   06                 pshs   d         save socket read pointer  F2E1 1F   02                 tfr    D,Y                     *  F2E3 CE   8080               ldu    #SPIBASE  F2E6 34   01                 pshs   cc  F2E8                         pshsw  F2E8 1038                    fdb    $1038                               endm  F2EA 34   40                 pshs   u  F2EC 1A   50                 orcc   #$50      disable interrupts  F2EE 86   2D                 lda    #SPI_RST+SPI_SR_+SPI_CR_+SPI_AUT set CS low  F2F0 A7   C4                 sta    spicmd,u  F2F2 10AF 44                 sty    hibyta,u  start address                      >F2F5 BD   F2BC               jsr    tsk2rx    SOCK# to buffer address                       F2F8 E7   44                 stb    hibyta,u  F2FA 10AE 6B                 ldy    11,s      target  F2FD E7   44                 stb    hibyta,u  shift out first data byte  F2FF 33   45                 leau   lobyta,u  lobyte is the first byte shifted in  F301                         trfr   X,W  F301 1F                      fcb    $1f  F302 16                      fcb    X<<4|W                               endm  F303                         tfm4   U,Y  F303 113B                    fdb    $113b  F305 32                      fcb    U<<4|Y                               endm  F306 35   40                 puls   u  F308 86   65                 lda    #SPI_CS_+SPI_RST+SPI_SR_+SPI_CR_  F30A A7   C4                 sta    spicmd,u  F30C                         pulsw  restore   E:F  F30C 1039                    fdb    $1039                               endm  F30E 35   01                 puls   cc                     *  F310 35   06                 puls   d         old read pointer  F312 E3   E4                 addd   0,s       adjust transferred  F314 BD   F221               jsr    PSRRXRP   update pointer                     *  F317 35   F6       15        puls   d,x,y,u,pc                                                               *                     * wrfb2sk,write fifo buffer to socket buffer                     * Y=target                     * E=socket#FIO Simulation Structure             19:34:46  Apr 22, 2024   Page  108wzspi, basic spi routines                                                * on entry D= total amount to xfer                     * on return D= xferred count                     *  F319 34   76       WRFB2SK   pshs   d,x,y,u  F31B 10A3 4A                 cmpd   wzrqln,u  has fio max size incorporated  F31E 23   02                 bls    01f  F320 EC   4A                 ldd    wzrqln,u  F322 1F   01       01        tfr    d,x  F324 ED   E4                 std    0,s  F326 ED   48                 std    wzxfer,u  report size  F328 27   52                 beq    15f                     *  F32A 10AE C8 22              ldy    wzuwrp,u  0 if not UDP or never written  F32E 26   05                 bne    24f  F330 BD   F1DD               jsr    GSRTXWP   get write pointer  F333 20   02                 bra    25f  F335 1F   20       24        tfr    y,d                     *  F337 34   06       25        pshs   d  F339 1F   02                 tfr    D,Y                     *  F33B CE   8080               ldu    #SPIBASE  F33E 34   01                 pshs   cc  F340                         pshsw  save      E:F  F340 1038                    fdb    $1038                               endm  F342 34   40                 pshs   u  F344 1A   50                 orcc   #$50  F346 86   2D                 lda    #SPI_RST+SPI_SR_+SPI_CR_+SPI_AUT set CS low  F348 A7   C4                 sta    spicmd,u  F34A 10AF 44                 sty    hibyta,u  start address                       F34D BD   F2AD               jsr    tsk2tx                       F350 E7   44                 stb    hibyta,u  F352 10AE 6B                 ldy    11,s      target  F355 33   44                 leau   hibyta,u  the first to shift out  F357                         trfr   X,W  F357 1F                      fcb    $1f  F358 16                      fcb    X<<4|W                               endm  F359                         tfm3   Y,U  F359 113A                    fdb    $113a  F35B 23                      fcb    Y<<4|U                               endm  F35C 35   40                 puls   u  F35E 86   65                 lda    #SPI_CS_+SPI_RST+SPI_SR_+SPI_CR_  F360 A7   C4                 sta    spicmd,u  F362                         pulsw  restore   E:F!!  F362 1039                    fdb    $1039                               endm  F364 35   01                 puls   ccFIO Simulation Structure             19:34:46  Apr 22, 2024   Page  109wzspi, basic spi routines                                                *  F366 35   06                 puls   d         old write pointer  F368 E3   E4                 addd   0,s  F36A EE   66                 ldu    6,s       restore U  F36C AE   C8 26              ldx    wztype,u  F36F 8C   0002               cmpx   #SK_DGRM  F372 27   05                 beq    10f  F374 BD   F1EC     11        jsr    PSRTXWP   update pointer  F377 20   03                 bra    15f                       F379 ED   C8 22    10        std    wzuwrp,u  set RAM pointer                     *                     *  F37C 35   F6       15        puls   d,x,y,u,pcFIO Simulation Structure             19:34:46  Apr 22, 2024   Page  110Debug Interface Routines                                                   F37E               DB_main  F37E 8D   4F                 bsr    DB_test   see if debug routines present  F380 6E   9F C002            jmp    [DEBUGROM+2]  F384               DB_pdata  F384 8D   49                 bsr    DB_test   see if debug routines present  F386 6E   9F C004            jmp    [DEBUGROM+4]  F38A               DB_phex  F38A 8D   43                 bsr    DB_test   see if debug routines present  F38C 6E   9F C006            jmp    [DEBUGROM+6]  F390               DB_phex2  F390 8D   3D                 bsr    DB_test   see if debug routines present  F392 6E   9F C008            jmp    [DEBUGROM+8]  F396               DB_pcrlf  F396 8D   37                 bsr    DB_test   see if debug routines present  F398 6E   9F C00A            jmp    [DEBUGROM+10]  F39C               DB_check  F39C 8D   31                 bsr    DB_test   see if debug routines present  F39E 6E   9F C00C            jmp    [DEBUGROM+12]  F3A2               DB_config  F3A2 8D   2B                 bsr    DB_test   see if debug routines present  F3A4 6E   9F C00E            jmp    [DEBUGROM+14]  F3A8 34   17       DB_msg    pshs   cc,d,x  F3AA AE   65                 ldx    1+2+2,s   get return address  F3AC EC   81                 ldd    ,x++      get mask word  F3AE B4   0401               anda   DB_cntrl  F3B1 F4   0402               andb   DB_cntrl+1  F3B4 34   04                 pshs   b  F3B6 AA   E0                 ora    ,s+  F3B8 27   04                 beq    10f       jump if flag not set  F3BA 30   02                 leax   2,x       skip over false address & fall through  F3BC 20   02                 bra    20f  F3BE AE   84       10        ldx    ,x        get false branch label  F3C0 AF   65       20        stx    1+2+2,s   fix up return address  F3C2 35   97                 puls   cc,d,x,pc return                     *  F3C4               DB_pspace  F3C4               DB_outsp  F3C4 34   16                 pshs   d,x  F3C6 8E   F3CD               ldx    #00f  F3C9 8D   B9                 bsr    DB_pdata  F3CB 35   96                 puls   d,x,pc  F3CD 20 00         00        fcc    ' ',0                       F3CF 34   07       DB_test   pshs   cc,d  F3D1 FC   C000               ldd    DEBUGROM  Debug rom present?  F3D4 1083 1234               cmpd   #$1234    special marker  F3D8 27   05                 beq    99f       yes - exit  F3DA 35   07                 puls   cc,d      no - abort DB_xx function  F3DC 32   62                 leas   2,s  F3DE 39                      rts  F3DF 35   87       99        puls   cc,d,pc   returnFIO Simulation Structure             19:34:47  Apr 22, 2024   Page  111Debug Interface Routines                                                                                                     end    rom_initFIO Simulation Structure             19:34:47  Apr 22, 2024   Page  112Debug Interface Routines                            Symbol Table:Absolute Symbols:A        0008   AF_INET  0002   AF_UNIX  0001   AF_UNSP  0000   B        0009   CC       000A   CI_CFL   0080   CI_MP    0010   CI_POC   0020   CI_UNR   0040   CPU2DEV  0022   CPU_down E05E   CPUtraps FFF0   CR       000D   D        0000   DBG_8274 0002   DBG_CMD  0100   DBG_HAN  0020   DBG_INIT 0400   DBG_INT  0004   DBG_IO   0010   DBG_MSG  0200   DBG_OPEN 0800   DBG_SLP  0040   DBG_SYS  0001   DBG_TASK 0080   DBG_TRMI 0008   DB_check F39C   DB_cntrl 0401   DB_confi F3A2   DB_iflg  0400   DB_main  F37E   DB_msg   F3A8   DB_outsp F3C4   DB_pcrlf F396   DB_pdata F384   DB_phex  F38A   DB_phex2 F390   DB_pspac F3C4   DB_test  F3CF   DBmsg00  E012   DBmsg01  E02A   DBmsg02  E04A   DEBUG    0D04   DEBUGROM C000   DEBUG_CO 0000   DEV2CPU  0021   DEV_SIZE 0006   DEV_SOCK E5F4   DO_HISTO 0001   DP       000B   DPR_BASE 0000   D_END    0038   D_func0  0000   D_func1  0002   D_func10 0020   D_func11 0022   D_func12 0024   D_func13 0026   D_func14 0028   D_func15 002A   D_func16 002C   D_func17 002E   D_func18 0030   D_func2  0004   D_func3  0006   D_func4  0008   D_func5  000A   D_func6  000C   D_func7  000E   D_func8  0010   D_func9  0012   D_funcA  0014   D_funcB  0016   D_funcC  0018   D_funcD  001A   D_funcE  001C   D_funcF  001E   D_init   0034   D_inthan 0032   D_test   0036   E        000E   E_ABORT  00BF   E_BADCMD 0081   E_BADDEV 0084   E_DEVBSY 0085   E_INTRPT 00BE   E_IOERR  0086   E_NTOPEN 0083   E_SOCKET 00C0   E_SYSBSY 0082   F        000F   FF       0040   FIFO_get E2F7   FIFO_put E31C   FIFOgeta E2EE   FIFOputa E314   FIOPRI   FFCE   FIO_get  E2CC   FIO_lock 0446   FIO_rel  E2E1   GCRGA    EDF6   GCRILLT  EEBE   GCRIMR   EEFA   GCRIR    EEDC   GCRMR    EDD8   GCRPHY   EFB6   GCRRCR   EF72   GCRRTR   EF54   GCRSHA   EE52   GCRSIMR  EF36   GCRSIP   EE90   GCRSIR   EF18   GCRSNM   EE24   GCRUIP   EF9F   GCRURP   EF90   GCRVERS  EFD4   GSKATM   F283   GSRCR    F001   GSRDHAR  F071   GSRDIP   F0AF   GSRDPOR  F0DD   GSRFRAG  F265   GSRIMR   F247   GSRIR    F026   GSRMR    EFE3   GSRMSS   F0FB   GSRPORT  F053   GSRPROT  F119   GSRRBFS  F173   GSRRXRP  F212   GSRRXRS  F1FB   GSRRXWP  F230   GSRSR    F044   GSRTBFS  F191   GSRTOS   F137   GSRTTL   F155   GSRTXFR  F1AF   GSRTXRP  F1C6   GSRTXWP  F1DD   HANGS    0001   HRECSIZ  0004   H_cpu    E473   H_fio    E497   IF       0010   INTS     0002   IO_end   E395   IO_han   E337   IRQ_han  E3B3   IRQmsg10 E3C0   IS       0003   IU       0002   IX       0000   IY       0001   LF       000A   MAXHIST  0010   MAXTBL   0003   MAX_DEV  0001   MAX_S_NU 0019   MAX_TI   0009   MAX_UDP  05C0   MAX_WZ   0008   MOD_SIZE 0004   NBRQLN   0004   NBSIZE   0204   NET      0001   NUM_TSK  0459   O_CLOSE  0020   O_INTRPT 0038   O_OPEN   0010   O_PGETD  00D0   O_PSETD  00E0   O_READ   0060   O_RQRD   0050   O_RQWR   0030   O_TTYG   00A0   O_TTYS   0090   O_WR1C   0080   O_WRITE  0040   PACK_COM 0000   PACK_FIR 0080   PACK_REM 0001   PC       0005   PCRGA    EE0D   PCRILLT  EECD   PCRIMR   EF09   PCRIR    EEEB   PCRMR    EDE7   PCRPHY   EFC5   PCRRCR   EF81   PCRRTR   EF63   PCRSHA   EE71   PCRSIMR  EF45   PCRSIP   EEA7   PCRSIR   EF27   PCRSNM   EE3B   PF_INET  0002   PF_UNIX  0001   PIPES    0006   POLPRI   FFBA   PROT_EGP 0008   PROT_ICM 0001   PROT_IGM 0002   PROT_XLT 8000   PSRCR    F010   PSRDHAR  F090   PSRDIP   F0C6   PSRDPOR  F0EC   PSRFRAG  F274   PSRIMR   F256   PSRIR    F035   PSRKATM  F292   PSRMR    EFF2   PSRMSS   F10A   PSRPORT  F062   PSRPROT  F128   PSRRBFS  F182   PSRRXRP  F221   PSRTBFS  F1A0   PSRTOS   F146   PSRTTL   F164   PSRTXWP  F1EC   QFF1     0080   QUITS    0003   RAMend   3EFF   FIO Simulation Structure             19:34:48  Apr 22, 2024   Page  113Debug Interface Routines                            RAMorg   0400   RAMscrat 7000   RAMscren 7E00   RDSK2FB  F2CB   REJECT   0080   ROMLOorg E000   ROM_ERR  E0D3   ROM_VERS 0020   ROMstack 7FE0   RSVREG   0003   RUNPRI   0046   R_ACCEPT 000B   R_BIND   0009   R_CLOCK  000E   R_CLOSE  0002   R_CONNEC 0008   R_DISCON 000C   R_INTRPT 0007   R_LISTEN 000A   R_OPEN   0001   R_PDATA  000B   R_RD1C   0009   R_RDFRM  0021   R_RDOK   0005   R_RDRBLK 0033   R_READ   0006   R_READM  000C   R_REQOK  0003   R_RESET  000F   R_RQRBLK 0032   R_RQRD   0005   R_RQRDNB 0015   R_RQSBLK 0030   R_RQWR   0003   R_RQWRNB 0013   R_RRDFD  0022   R_RSNDTO 0023   R_SNDBLK 0031   R_SNDKEP 000E   R_SNDMAC 000D   R_SNDTOM 0025   R_SPCL   000F   R_TTY    000D   R_WR1C   0008   R_WRITE  0004   R_WSNDTO 0024   S        0004   SIQPRI   FFD8   SI_CON   0001   SI_DIS   0002   SI_HAN   E407   SI_Q     040E   SI_Q_ptr 0444   SI_RCV   0004   SI_SOK   0010   SI_TIM   0008   SKADLN   0010   SKPRI    FFC4   SK_DGRM  0002   SK_IRAW  0004   SK_MRAW  0003   SK_NONBL 0100   SK_STRM  0001   SNCR     0001   SNDHAR0  0006   SNDHAR1  0007   SNDHAR2  0008   SNDHAR3  0009   SNDHAR4  000A   SNDHAR5  000B   SNDIPR0  000C   SNDIPR1  000D   SNDIPR2  000E   SNDIPR3  000F   SNDPOR0  0010   SNDPOR1  0011   SNFRAG0  002D   SNFRAG1  002E   SNIMR    002C   SNIR     0002   SNKATIM  002F   SNMR     0000   SNMSSR0  0012   SNMSSR1  0013   SNPORT0  0004   SNPORT1  0005   SNPROTO  0014   SNRBFSZ  001E   SNRXRP0  0028   SNRXRP1  0029   SNRXRZ0  0026   SNRXRZ1  0027   SNRXWP0  002A   SNRXWP1  002B   SNSR     0003   SNTBFSZ  001F   SNTOS    0015   SNTTL    0016   SNTXFR0  0020   SNTXFR1  0021   SNTXRP0  0022   SNTXRP1  0023   SNTXWP0  0024   SNTXWP1  0025   SPIBASE  8080   SPI_AUT  0008   SPI_CR_  0001   SPI_CS_  0040   SPI_HLD  0002   SPI_IEN  0010   SPI_IRQ  0001   SPI_RST  0020   SPI_SR_  0004   SP_EGP   0008   SP_GMP   0002   SP_ICMP  0001   SP_TCP   0006   SP_UDP   0011   SYS_TABS 04C6   S_ACCEPT 0058   S_BIND   0048   S_CLOSE  0010   S_CONNEC 0040   S_DISCON 0060   S_INTRPT 0038   S_LISTEN 0050   S_OPEN   0008   S_RDRBLK 00D8   S_READ   0030   S_RQRBLK 00D0   S_RQRD   0028   S_RQSBLK 00C0   S_RQWR   0018   S_RRDFRM 0080   S_RREAD  0088   S_SNDBLK 00C8   S_SNDKEP 0070   S_SNDMAC 0068   S_SPCL   0078   S_WRITE  0020   S_WRQSTO 0090   S_WSNDTM 00A0   S_WSNDTO 0098   TFREE    0004   TRUN     0001   TSKSIZ   00D7   TSLEEP   0002   TSYS     0005   TWAIT    0003   U        0003   USTSIZ   00C0   V        0007   W        0006   WCACCP   0086   WCBIND   0085   WCCLOS   0010   WCCONN   0004   WCDISC   0008   WCLIST   0002   WCOPEN   0001   WCRECV   0040   WCRRQD   0081   WCSEND   0020   WCSKEP   0022   WCSNAC   0021   WCSPEC   0080   WCXMDR   0082   WFNBLK   0001   WFSPOC   0002   WRFB2SK  F319   WSCLSD   0000   WSCLSG   001A   WSCLWT   001C   WSESTB   0017   WSFWAI   0018   WSINIT   0013   WSIRAW   0032   WSLACK   001D   WSLIST   0014   WSMRAW   0042   WSRNBL   001E   WSRRQF   0081   WSSPEC   0080   WSSYNR   0016   WSSYNS   0015   WSTIMW   001B   WSUDP    0022   WSWNBL   001F   WSXMDD   0082   WZ5_name E1DF   WZBUSY   0080   WZGAR0   0001   WZGAR1   0002   WZGAR2   0003   WZGAR3   0004   WZILLT0  0013   WZILLT1  0014   WZIMR    0016   WZIR     0015   WZLCSZ   0016   WZMR     0000   WZNETOF  0370   WZPHY    002E   WZRCR    001B   WZRTR0   0019   WZRTR1   001A   WZSHAR0  0009   WZSHAR1  000A   WZSHAR2  000B   WZSHAR3  000C   WZSHAR4  000D   WZSHAR5  000E   WZSIMR   0018   WZSIPR0  000F   WZSIPR1  0010   WZSIPR2  0011   WZSIPR3  0012   WZSIR    0017   WZSIZE   002A   WZSKIO   0002   WZSKIP   0040   WZSKIS   0004   WZSKOFF  0220   WZSLCK   0001   WZSUBR0  0005   WZSUBR1  0006   WZSUBR2  0007   WZSUBR3  0008   WZUIPR0  0028   WZUIPR1  0029   WZUIPR2  002A   WZUIPR3  002B   WZUPRT0  002C   WZUPRT1  002D   WZVERS   0039   WZWLCK   0010   X        0001   Y        0002   bad_cmd  E3B0   bittab   E77A   bmread   ED6F   bt2num   E769   byterd   ED4B   bytewr   EDA8   change   E4BB   chproc   040C   clock_ti 0455   conlb1   E823   cpu_fio  0000   cpu_fio1 0001   cpu_fio2 0003   cpu_fio3 0004   cpu_fio4 0006   cpu_fio5 0008   cpu_fioF 0024   dev_addr 0000   dev_brbu 0004   dev_tab  04A0   dev_type 0002   end_vars 3EFF   FIO Simulation Structure             19:34:48  Apr 22, 2024   Page  114Debug Interface Routines                            fifo     0020   fifo_cnt 0012   fifo_get 0014   fifo_put 0016   fifo_us0 0018   fifo_us1 001A   fifo_us2 001C   fifo_us3 001E   fio_cpu  0009   fio_cpu1 000A   fio_cpu2 000C   fio_cpu3 000D   fio_cpu4 000F   fio_cpu5 0011   fio_cpuF 0023   fio_dsz  E07D   fio_fsz  E07B   fio_irq  E22A   fio_msg  E294   fio_rese E1EA   fio_resp E2B0   fio_star E09B   fio_wait E20D   fiointe  E293   functb   EC73   getjo1   E503   getjo2   E512   getjo4   E519   getjo6   E522   getjo8   E524   getjob   E4FD   hibyta   0004   hibyts   0006   hst_cmd  0000   hst_seq  0001   hst_tty  0002   hst_val  0003   hstbuf   045A   hstptr   049A   idle     040D   int_all  E3D8   int_buf  0447   int_ptr  0453   jobpri   040B   lobyta   0005   lobyts   0007   lstram   04C6   makrd6   E57C   makrdy   E567   max_trn  E07F   mod_name 0002   mod_tbl  E1D9   mod_type 0000   no_dev   E15A   num2bt   E75F   nwp_strt 0000   oldorg   ED17   polext   E83D   putru1   E53B   putru2   E542   putru4   E550   putru5   E55F   putru6   E563   putrun   E52E   rdrqer1  E95C   rom_bad  E0D1   rom_firq E0A4   rom_init E080   rom_int  E0C6   rom_nmi  E09E   rom_swi  E0AB   rom_swi2 E0B1   rom_swi3 E0B8   rom_trap E0BF   rsche2   E4D2   rsche3   E4E6   rsched   E4C1   runlst   0403   sa_dat   0002   sa_fam   0000   sdev_sig E69E   send_SI  E449   set_tabl E112   showrg   ECC1   sin_addr 0014   sin_fam  0010   sin_port 0012   skacpt   E8DD   skbind   E866   skclin   E79E   skclos   E783   skcner1  E85C   skcner2  E849   skcner3  E860   skcner4  E858   skcner5  E854   skcner6  E84D   skconn   E7D0   skcraw   E6D6   skctcp   E6C4   skcudp   E6CD   skdisc   ED10   skdvini  E646   skfres   E6BD   skinit   E62C   skinthan E69D   skintrp  ED10   sklist   E8AB   sknbe1   EC06   sknbrd   EC09   sknbrp1  EBFD   sknbrp2  EBE4   sknbrr   EBB2   sknbsd   EC3C   sknbsr   EC2C   sknewp   E69F   skopen   E6E3   skoper1  E755   skoper2  E759   skowfo   E73D   skrecv   E961   skreqrd  E914   skreqwr  E9A4   sksend   E9EB   skskep   ED10   sksmac   ED10   skspcl   EC4C   sktest   E69A   skurrd   EAA5   skurrdf  EA2E   skurwt   EAD3   skusnm   EB22   skusnt   EB78   skuwr2   EB22   sleep    E5A1   sleep7   E5C9   slplst   0405   spicmd   0000   spicon   0001   spiint   0456   spinit   ED17   spista   0000   spistr2  ED1D   sprend   EDC6   stbinit  E0E0   sto_chk  E161   swtchu   E4F2   sys_vars 0400   tim_base 8400   tim_rest 8401   timerack E1CD   timerchk E1D3   timerin  E1C7   tsagin   000F   tscmd    0009   tsdev    000D   tsevnt   0006   tsk2rg   F2A1   tsk2rx   F2BC   tsk2tx   F2AD   tskend   049E   tskinit  E16F   tsktab   049C   tslink   0000   tsprir   0005   tsseq    000A   tssgnl   0008   tsslnk   0002   tsstat   0004   tstval   000C   umark0   0013   umark1   0015   usp      0011   utask    0409   wakeu2   E588   wakeu3   E58F   wakeu4   E593   wakeu5   E595   wakeup   E57D   wlocip   0370   wordrd   ED5D   wordwr   EDB7   wzanyp   0457   wzcmnd   0004   wzdctr   0001   wzdevt   E6B1   wzdma1   000C   wzdma2   000E   wzdprt   0012   wzdsta   0012   wzenum   0000   wzerr    0007   wzfaml   0024   wzflg    0003   wzfsta   0002   wzgwad   0008   wzhwad   000C   wzifga   E00E   wzifip   E006   wzifma   E000   wzifnm   E00A   wzipad   0014   wzmyip   0000   wzprot   0028   wzrdev   ECA5   wzrqln   000A   wzsbnm   0004   wzsflg   0018   wzsk1    0346   wzsk2    031C   wzsk3    02F2   wzsk4    02C8   wzsk5    029E   wzsk6    0274   wzsk7    024A   wzsk8    0220   wzsprt   0010   wzstat   0005   wztype   0026   wzuipa   001A   wzupkt   0006   wzuprt   001E   wzurms   0020   wzuwrp   0022   wzwdev   EC7B   wzxfer   0008   xmtint   E5D6   