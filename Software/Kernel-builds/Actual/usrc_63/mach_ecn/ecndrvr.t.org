        opt     nol        lib     ./gendrvr.h        lib     ./ecndrvr.h        opt     lis,exp        if      (ECN=1)        sttl     Econet Drivers        pag        name    ecndrvr        data        global  ecnop,ecncl,ecnrd,ecnwr,ecnsp        global  ecnirq,dprecn,ecn_cpuFecnrdb  rzb     HDRSIZecnwrb  rzb     HDRSIZ*ecnopt  fcb     0,0,0,0        eco open tableecnsts  rzb     2** open the ecn driver* B contains device minor*ecnop   pshs    d        ldx     #ecnopt        lda     b,x        bne     ecnop2          exclusive open        inc     b,x        bra     ecnop3*ecnop2  lda     #EBARG        sta     uerrorecnop3  puls    d,pc            return** ecn close*ecncl        ldx     #ecnopt        clr     b,x             clear open status        rts                     return** IRQ, here something has been done (success or fail)*ecnirq  equ     *        ldu     #dprecn        ldb     ecn_cpuF,u        bitb    #ECNRDI        beq     ecnir1        lda     #$ff        sta     ecnrda,u         save this news        pshs    b,u        ldy     #ecnrdb        jsr     wakeup        puls    b,u*ecnir1  bitb    #ECNWRI        beq     ecnri2        nopecnri2  clr     ecn_cpuF,u        set we saw it        rts** ecnrd*ecnrd   equ     *        pshs    d       save device number        ldy     #ecnrdb        jsr     blkgtb  get device buffer        puls    d        jsr     ecncn   configure buffer        tst     uerror  OK?        beq     ecnrd4        pshs    y        ldy     #ecnrdb        jsr     blkfrb  free the buffer        puls    y,pc    error return        ldu     #dprecnecnrd4  nopecnrd9  pshs    cc        sei        tst     ecnrda,u  new data?        bne     ecnrd5        pshs    y        ldb     #ECNPRI        jsr     sleep        puls    y        puls    cc        bra     ecnrd4*ecnrd5  puls    cc        ldd     ecnrct,u        beq     ecnrd7      took all        cmpd    uicnt        bhi     ecnrd0    is not going to fit in user buffer        cmpd    #ECNFSZ   does it fit in fifo?        bls     ecnrd8  yes        ldd     #ECNFSZ   one fifo at a timeecnrd8  trfr    D,W         count        pshs    x,u        tfr     y,x        jsr     mapbpt        leau    ecnrff,u   read fifo        tfm1    X,U        move to user        puls    x,u        ldd     bfadr,y    move user pointer        addr    W,D        std     bfadr,y        ldd     ecnrct,u       subtract what is done        subr    W,D        std     ecnrct,u        beq     ecnrd7          done all*        clr     ecnrda,u     say we took it        lda     ecn_dprF,u   we need more        ora     #ECNRDI      ask to fill fifo again        sta     ecn_dprF,u      signal IOP        bra     ecnrd9ecnrd0  ldd     #0        std     uicnt        bra     ecnrdeecnrd7  clr     ecnrda,u     say we took it        ldb     ecnrer,u     error from network        beq     ecnrd6*ecnrde  ldb     bfflag,y        orb     #BFERR        stb     bfflag,y        ldb     #EIO        stb     uerror*ecnrd6  jmp     blkfrb          free buffer** ecnwr*ecnwr   equ     *        pshs    d       save device info        ldy     #ecnwrb        jsr     blkgtb  get device buffer        puls    d        jsr     ecncn   configure        tst     uerror  OK        beq     ecnwr4        pshs    y        ldy     #ecnwrb        jsr     blkfrb  free the buffer        puls    y,pc    error returnecnwr4  ldu     #dprecn        tst     ecnwdb,u        beq     ecnwr5        ldb     #ECNPRI        jsr     sleep        bra     ecnwr4*ecnwr5  ldd     uicnt        std     ecnwct,u        trfr    D,W        pshs    x,u        tfr     y,x        jsr     mapbpt        leau    ecnwff,u        tfm1    U,X        puls    x,u        clr     ecnwdb,u        lda     ecn_dprF,u        ora     #ECNWRI         signal from xmit        sta     ecn_dprF,u        jmp     blkfrb          free bufferecncn   equ     *        std     bfdvn,y        ldd     uicnt        cmpd    #ECNFSZ        bhs     ecnce1        std     bfxfc,y        ldd     uistrt        std     bfadr,y        jsr     mapupg        std     bfxadr,y* check if whole buffer remains within one page* whether the buffer is big or small        ldd     bfadr,y        anda    #%00001111      round to 4K        addd    uicnt        bita    #%11110000        bne     ecnce1           overflow        rts*ecnce1  lda     #EBARG        sta     uerror        rts** ecnspl*ecnsp        tfr     x,y        ldx     #ecnsts         side info table        abx                     correct entry        cmpy    #0        bne     01f*        ldd     usarg0        sta     0,x             set side        stb     1,x             set dens        rts01      lda     0,x             get side        ldb     1,x             get dens        std     0,y        endif        end